From 4a6339b24585f70aadd0d87380552cb8802bd612 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Sergio=20Casta=C3=B1o=20Arteaga?= <tegioz@icloud.com>
Date: Wed, 13 Sep 2023 13:56:50 +0200
Subject: [PATCH] Do not follow symlinks when reading certain files
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Sergio Casta√±o Arteaga <tegioz@icloud.com>
---
 internal/tracker/source/generic/generic.go    | 15 ++++++++-------
 .../tracker/source/helmplugin/helmplugin.go   |  5 +++--
 internal/tracker/source/tekton/tekton.go      |  3 ++-
 internal/util/file.go                         | 19 +++++++++++++++++++
 4 files changed, 32 insertions(+), 10 deletions(-)
 create mode 100644 internal/util/file.go

diff --git a/internal/tracker/source/generic/generic.go b/internal/tracker/source/generic/generic.go
index cb6970549..c6897ca59 100644
--- a/internal/tracker/source/generic/generic.go
+++ b/internal/tracker/source/generic/generic.go
@@ -12,6 +12,7 @@ import (
 	"github.com/artifacthub/hub/internal/hub"
 	"github.com/artifacthub/hub/internal/oci"
 	"github.com/artifacthub/hub/internal/pkg"
+	"github.com/artifacthub/hub/internal/util"
 	gk "github.com/open-policy-agent/gatekeeper/v3/pkg/gator/verify"
 	ignore "github.com/sabhiram/go-gitignore"
 )
@@ -197,7 +198,7 @@ func PreparePackage(r *hub.Repository, md *hub.PackageMetadata, pkgPath string)
 	// If the readme content hasn't been provided in the metadata file, try to
 	// get it from the README.md file.
 	if p.Readme == "" {
-		readme, err := os.ReadFile(filepath.Join(pkgPath, "README.md"))
+		readme, err := util.ReadRegularFile(filepath.Join(pkgPath, "README.md"))
 		if err == nil {
 			p.Readme = string(readme)
 		}
@@ -241,7 +242,7 @@ func PreparePackage(r *hub.Repository, md *hub.PackageMetadata, pkgPath string)
 func prepareArgoTemplateData(pkgPath string) (map[string]interface{}, error) {
 	// Read manifests file
 	manifestsPath := path.Join(pkgPath, argoTemplateManifests)
-	template, err := os.ReadFile(manifestsPath)
+	template, err := util.ReadRegularFile(manifestsPath)
 	if err != nil {
 		return nil, fmt.Errorf("error reading argo template manifests: %w", err)
 	}
@@ -275,7 +276,7 @@ func prepareFalcoData(pkgPath string, ignorer ignore.IgnoreParser) (map[string]i
 func prepareGatekeeperData(pkgPath string) (map[string]interface{}, error) {
 	// Read template file
 	templatePath := path.Join(pkgPath, "template.yaml")
-	template, err := os.ReadFile(templatePath)
+	template, err := util.ReadRegularFile(templatePath)
 	if err != nil {
 		return nil, fmt.Errorf("error reading gatekeeper template file: %w", err)
 	}
@@ -290,7 +291,7 @@ func prepareGatekeeperData(pkgPath string) (map[string]interface{}, error) {
 		for _, t := range suites[0].Tests {
 			var cases []*GKExampleCase
 			if t.Constraint != "" {
-				content, err := os.ReadFile(path.Join(pkgPath, t.Constraint))
+				content, err := util.ReadRegularFile(path.Join(pkgPath, t.Constraint))
 				if err != nil {
 					return nil, fmt.Errorf("error reading constraint file (%s): %w", t.Constraint, err)
 				}
@@ -301,7 +302,7 @@ func prepareGatekeeperData(pkgPath string) (map[string]interface{}, error) {
 				})
 			}
 			for _, c := range t.Cases {
-				content, err := os.ReadFile(path.Join(pkgPath, c.Object))
+				content, err := util.ReadRegularFile(path.Join(pkgPath, c.Object))
 				if err != nil {
 					return nil, fmt.Errorf("error reading example file (%s): %w", c.Object, err)
 				}
@@ -345,7 +346,7 @@ func prepareKubeArmorData(pkgPath string, ignorer ignore.IgnoreParser) (map[stri
 func prepareKyvernoData(pkgPath string) (map[string]interface{}, error) {
 	// Read policy file
 	policyPath := path.Join(pkgPath, path.Base(pkgPath)+".yaml")
-	policy, err := os.ReadFile(policyPath)
+	policy, err := util.ReadRegularFile(policyPath)
 	if err != nil {
 		return nil, fmt.Errorf("error reading kyverno policy file: %w", err)
 	}
@@ -392,7 +393,7 @@ func GetFilesWithSuffix(suffix, rootPath string, ignorer ignore.IgnoreParser) (m
 		if !strings.HasSuffix(info.Name(), suffix) {
 			return nil
 		}
-		content, err := os.ReadFile(path)
+		content, err := util.ReadRegularFile(path)
 		if err != nil {
 			return fmt.Errorf("error reading file: %w", err)
 		}
diff --git a/internal/tracker/source/helmplugin/helmplugin.go b/internal/tracker/source/helmplugin/helmplugin.go
index 1dbfcf32f..3f13fc6cf 100644
--- a/internal/tracker/source/helmplugin/helmplugin.go
+++ b/internal/tracker/source/helmplugin/helmplugin.go
@@ -11,6 +11,7 @@ import (
 	"github.com/artifacthub/hub/internal/hub"
 	"github.com/artifacthub/hub/internal/license"
 	"github.com/artifacthub/hub/internal/pkg"
+	"github.com/artifacthub/hub/internal/util"
 	"github.com/hashicorp/go-multierror"
 	"helm.sh/helm/v3/pkg/plugin"
 	"sigs.k8s.io/yaml"
@@ -147,7 +148,7 @@ func PreparePackage(r *hub.Repository, md *plugin.Metadata, pkgPath string) (*hu
 	}
 
 	// Include readme file if available
-	readme, err := os.ReadFile(filepath.Join(pkgPath, "README.md"))
+	readme, err := util.ReadRegularFile(filepath.Join(pkgPath, "README.md"))
 	if err == nil {
 		p.Readme = string(readme)
 	}
@@ -157,7 +158,7 @@ func PreparePackage(r *hub.Repository, md *plugin.Metadata, pkgPath string) (*hu
 	if err == nil {
 		for _, file := range files {
 			if licenseRE.Match([]byte(file.Name())) {
-				licenseFile, err := os.ReadFile(filepath.Join(pkgPath, file.Name()))
+				licenseFile, err := util.ReadRegularFile(filepath.Join(pkgPath, file.Name()))
 				if err == nil {
 					p.License = license.Detect(licenseFile)
 					break
diff --git a/internal/tracker/source/tekton/tekton.go b/internal/tracker/source/tekton/tekton.go
index d5ba7d01d..f6d876fba 100644
--- a/internal/tracker/source/tekton/tekton.go
+++ b/internal/tracker/source/tekton/tekton.go
@@ -17,6 +17,7 @@ import (
 	"github.com/artifacthub/hub/internal/repo"
 	"github.com/artifacthub/hub/internal/tracker/source"
 	"github.com/artifacthub/hub/internal/tracker/source/generic"
+	"github.com/artifacthub/hub/internal/util"
 	"github.com/ghodss/yaml"
 	"github.com/go-git/go-git/v5"
 	"github.com/go-git/go-git/v5/plumbing"
@@ -463,7 +464,7 @@ func PreparePackage(i *PreparePackageInput) (*hub.Package, error) {
 	}
 
 	// Include readme file
-	readme, err := os.ReadFile(filepath.Join(i.PkgPath, "README.md"))
+	readme, err := util.ReadRegularFile(filepath.Join(i.PkgPath, "README.md"))
 	if err == nil {
 		p.Readme = string(readme)
 	}
diff --git a/internal/util/file.go b/internal/util/file.go
new file mode 100644
index 000000000..08d03a137
--- /dev/null
+++ b/internal/util/file.go
@@ -0,0 +1,19 @@
+package util
+
+import (
+	"fmt"
+	"os"
+)
+
+// ReadRegularFile is a wrapper around os.ReadFile that only operates on
+// regular files.
+func ReadRegularFile(name string) ([]byte, error) {
+	info, err := os.Lstat(name)
+	if err != nil {
+		return nil, err
+	}
+	if !info.Mode().IsRegular() {
+		return nil, fmt.Errorf("invalid file %s", name)
+	}
+	return os.ReadFile(name)
+}
