{
  "index": 4,
  "original_url": "https://github.com/proglottis/gpgme/commit/7e8c79da5ec1bd810f01f46df83a8a914e49f4fa",
  "patch_url": "https://github.com/proglottis/gpgme/commit/7e8c79da5ec1bd810f01f46df83a8a914e49f4fa.patch",
  "commit_info": {
    "type": "pr_commit",
    "hash": "7e8c79da5ec1bd810f01f46df83a8a914e49f4fa",
    "url": "https://github.com/proglottis/gpgme/commit/7e8c79da5ec1bd810f01f46df83a8a914e49f4fa",
    "pr_url": "https://github.com/proglottis/gpgme/pull/23",
    "pr_number": "23",
    "owner": "proglottis",
    "repo": "gpgme",
    "message": "Ensure Context is not dellocated while C code is still using it\n\nAs far as Go is concerned, Context.ctx and Context.cbc are just values, so it is\nOK to implement\n> cgo_call(c.ctx)\nas\n> tmp := c.ctx\n> dropReferenceTo(c)\n> // c's finalizer can be called at any point from now on, possibly deallocating c.ctx\n> cgo_call(tmp) // possibly using free memory\n\nTo fix this, explicitly extend the lifetime of Context:\n> cgo_call(c.ctx)\n> runtime.KeepAlive(c)\nbecomes\n> tmp := c.ctx\n> cgo_call(tmp) // c.ctx is certainly still valid\n> dropReferenceTo(c)\n> // c's finalizer can be called from now on, possibly deallocating c.ctx\n\nTo be extra careful, this adds runtime.KeepAlive calls even in cases where the current\ncode path necessarily keeps c alive afterwards, so that the patern is clear and so\nthat future possible changes to the code don't invalidate this assumption.\n\nSecondarily, in a few cases GPGMe returns internal pointers inside Context.ctx;\nin that case, extend the lifetime of Context until we make a complete copy of\nthe data.\n\nAs a special case, EngineInfo is now not just a wrapper around a C pointer with\nan unknown lifetime, but we make a full copy of the data when obtaining the pointer\nso that we can safely use it after dropping the context that returned the information,\nor after changing the information and possibly invalidating the pointers.\n\nSigned-off-by: Miloslav Trmač <mitr@redhat.com>",
    "author": "Miloslav Trmač",
    "date": "2020-01-10T16:26:47Z"
  },
  "patch_stats": {
    "files_modified": 1,
    "lines_added": 104,
    "lines_removed": 31,
    "total_changes": 135,
    "file_list": [
      "gpgme.go"
    ],
    "file_extensions": [
      "go"
    ],
    "binary_files": 0
  }
}