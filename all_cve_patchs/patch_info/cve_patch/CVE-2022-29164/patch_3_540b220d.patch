From 540b220d63868497cb427a4b4d1f9d32a7468b0b Mon Sep 17 00:00:00 2001
From: Alex Collins <alex_collins@intuit.com>
Date: Mon, 2 May 2022 16:51:00 -0700
Subject: [PATCH] chore: Revert artifact Content-Security-Policy

Signed-off-by: Alex Collins <alex_collins@intuit.com>
---
 server/artifacts/artifact_server.go | 47 ++---------------------------
 test/e2e/argo_server_test.go        | 26 ----------------
 2 files changed, 2 insertions(+), 71 deletions(-)

diff --git a/server/artifacts/artifact_server.go b/server/artifacts/artifact_server.go
index c2571756f983..995aef7d4e01 100644
--- a/server/artifacts/artifact_server.go
+++ b/server/artifacts/artifact_server.go
@@ -7,16 +7,14 @@ import (
 	"io"
 	"mime"
 	"net/http"
-	"os"
 	"path"
 	"strings"
 
-	apierr "k8s.io/apimachinery/pkg/api/errors"
-
 	log "github.com/sirupsen/logrus"
 	"google.golang.org/grpc/codes"
 	"google.golang.org/grpc/metadata"
 	"google.golang.org/grpc/status"
+	apierr "k8s.io/apimachinery/pkg/api/errors"
 	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
 
 	"github.com/argoproj/argo-workflows/v3/persist/sqldb"
@@ -30,20 +28,6 @@ import (
 	"github.com/argoproj/argo-workflows/v3/workflow/hydrator"
 )
 
-const (
-	// EnvArgoArtifactContentSecurityPolicy is the env variable to override the default security policy -
-	//   Content-Security-Policy HTTP header
-	EnvArgoArtifactContentSecurityPolicy = "ARGO_ARTIFACT_CONTENT_SECURITY_POLICY"
-	// 	EnvArgoArtifactXFrameOptions is the env variable to set the server X-Frame-Options header
-	EnvArgoArtifactXFrameOptions = "ARGO_ARTIFACT_X_FRAME_OPTIONS"
-	// DefaultContentSecurityPolicy is the default policy added to the Content-Security-Policy HTTP header
-	//   if no environment override has been added
-	// Validte using https://csp-evaluator.withgoogle.com
-	DefaultContentSecurityPolicy = "sandbox; base-uri 'none'; default-src 'none'; img-src 'self'; style-src 'self'"
-	// DefaultXFrameOptions is the default value for the X-Frame-Options header
-	DefaultXFrameOptions = "SAMEORIGIN"
-)
-
 type ArtifactServer struct {
 	gatekeeper           auth.Gatekeeper
 	hydrator             hydrator.Interface
@@ -51,7 +35,6 @@ type ArtifactServer struct {
 	instanceIDService    instanceid.Service
 	artDriverFactory     artifact.NewDriverFunc
 	artifactRepositories artifactrepositories.Interface
-	httpHeaderConfig     map[string]string
 }
 
 func NewArtifactServer(authN auth.Gatekeeper, hydrator hydrator.Interface, wfArchive sqldb.WorkflowArchive, instanceIDService instanceid.Service, artifactRepositories artifactrepositories.Interface) *ArtifactServer {
@@ -59,23 +42,7 @@ func NewArtifactServer(authN auth.Gatekeeper, hydrator hydrator.Interface, wfArc
 }
 
 func newArtifactServer(authN auth.Gatekeeper, hydrator hydrator.Interface, wfArchive sqldb.WorkflowArchive, instanceIDService instanceid.Service, artDriverFactory artifact.NewDriverFunc, artifactRepositories artifactrepositories.Interface) *ArtifactServer {
-	httpHeaderConfig := map[string]string{}
-
-	env, defined := os.LookupEnv(EnvArgoArtifactContentSecurityPolicy)
-	if defined {
-		httpHeaderConfig["Content-Security-Policy"] = env
-	} else {
-		httpHeaderConfig["Content-Security-Policy"] = DefaultContentSecurityPolicy
-	}
-
-	env, defined = os.LookupEnv(EnvArgoArtifactXFrameOptions)
-	if defined {
-		httpHeaderConfig["X-Frame-Options"] = env
-	} else {
-		httpHeaderConfig["X-Frame-Options"] = DefaultXFrameOptions
-	}
-
-	return &ArtifactServer{authN, hydrator, wfArchive, instanceIDService, artDriverFactory, artifactRepositories, httpHeaderConfig}
+	return &ArtifactServer{authN, hydrator, wfArchive, instanceIDService, artDriverFactory, artifactRepositories}
 }
 
 func (a *ArtifactServer) GetOutputArtifact(w http.ResponseWriter, r *http.Request) {
@@ -205,11 +172,6 @@ func (a *ArtifactServer) GetArtifactFile(w http.ResponseWriter, r *http.Request)
 		}
 		log.Debugf("this is a directory, artifact: %+v; files: %v", artifact, objects)
 
-		// set headers
-		for name, value := range a.httpHeaderConfig {
-			w.Header().Add(name, value)
-		}
-
 		key, _ := artifact.GetKey()
 		for _, object := range objects {
 
@@ -448,11 +410,6 @@ func (a *ArtifactServer) returnArtifact(w http.ResponseWriter, art *wfv1.Artifac
 	w.Header().Add("Content-Disposition", fmt.Sprintf(`filename="%s"`, path.Base(key)))
 	w.Header().Add("Content-Type", mime.TypeByExtension(path.Ext(key)))
 
-	// Iterate and set the rest of the headers
-	for name, value := range a.httpHeaderConfig {
-		w.Header().Add(name, value)
-	}
-
 	_, err = io.Copy(w, stream)
 	if err != nil {
 		http.Error(w, fmt.Sprintf("failed to stream artifact: %v", err), http.StatusInternalServerError)
diff --git a/test/e2e/argo_server_test.go b/test/e2e/argo_server_test.go
index cf11c4ffca5e..d936942f909e 100644
--- a/test/e2e/argo_server_test.go
+++ b/test/e2e/argo_server_test.go
@@ -25,7 +25,6 @@ import (
 
 	"github.com/argoproj/argo-workflows/v3/pkg/apis/workflow"
 	wfv1 "github.com/argoproj/argo-workflows/v3/pkg/apis/workflow/v1alpha1"
-	"github.com/argoproj/argo-workflows/v3/server/artifacts"
 	"github.com/argoproj/argo-workflows/v3/test/e2e/fixtures"
 	"github.com/argoproj/argo-workflows/v3/workflow/common"
 )
@@ -1066,11 +1065,6 @@ func (s *ArgoServerSuite) TestArtifactServer() {
 		resp.Body().
 			Contains(":) Hello Argo!")
 
-		resp.Header("Content-Security-Policy").
-			Equal(artifacts.DefaultContentSecurityPolicy) // MSB
-
-		resp.Header("X-Frame-Options").
-			Equal(artifacts.DefaultXFrameOptions)
 	})
 
 	// In this case, the artifact name is a file
@@ -1082,11 +1076,6 @@ func (s *ArgoServerSuite) TestArtifactServer() {
 		resp.Body().
 			Contains(":) Hello Argo!")
 
-		resp.Header("Content-Security-Policy").
-			Equal(artifacts.DefaultContentSecurityPolicy) // MSB
-
-		resp.Header("X-Frame-Options").
-			Equal(artifacts.DefaultXFrameOptions)
 	})
 
 	// In this case, the artifact name is a directory
@@ -1098,11 +1087,6 @@ func (s *ArgoServerSuite) TestArtifactServer() {
 		resp.Body().
 			Contains("<a href=\"subdirectory/\">subdirectory/</a>")
 
-		resp.Header("Content-Security-Policy").
-			Equal(artifacts.DefaultContentSecurityPolicy) // MSB
-
-		resp.Header("X-Frame-Options").
-			Equal(artifacts.DefaultXFrameOptions)
 	})
 
 	// In this case, the filename specified in the request is actually a directory
@@ -1115,11 +1099,6 @@ func (s *ArgoServerSuite) TestArtifactServer() {
 			Contains("<a href=\"sub-file-1\">sub-file-1</a>").
 			Contains("<a href=\"sub-file-2\">sub-file-2</a>")
 
-		resp.Header("Content-Security-Policy").
-			Equal(artifacts.DefaultContentSecurityPolicy) // MSB
-
-		resp.Header("X-Frame-Options").
-			Equal(artifacts.DefaultXFrameOptions)
 	})
 
 	// In this case, the filename specified in the request is a subdirectory file
@@ -1131,11 +1110,6 @@ func (s *ArgoServerSuite) TestArtifactServer() {
 		resp.Body().
 			Contains(":) Hello Argo!")
 
-		resp.Header("Content-Security-Policy").
-			Equal(artifacts.DefaultContentSecurityPolicy) // MSB
-
-		resp.Header("X-Frame-Options").
-			Equal(artifacts.DefaultXFrameOptions)
 	})
 
 	// In this case, the artifact name is a file
