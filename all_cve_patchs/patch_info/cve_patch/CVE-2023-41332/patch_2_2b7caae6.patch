From 2b7caae652297b976f6355339319f5bdb9398988 Mon Sep 17 00:00:00 2001
From: Tam Mach <tam.mach@cilium.io>
Date: Fri, 11 Aug 2023 23:03:30 +1000
Subject: [PATCH] helm: Add validation rule for Envoy L7 Load Balancer

This is to ensure that proxy must be enabled if Envoy L7 Load balancer
feature is enabled.

Signed-off-by: Tam Mach <tam.mach@cilium.io>
---
 install/kubernetes/cilium/templates/validate.yaml | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/install/kubernetes/cilium/templates/validate.yaml b/install/kubernetes/cilium/templates/validate.yaml
index 43c4de393424d..dfb5cb30919a3 100644
--- a/install/kubernetes/cilium/templates/validate.yaml
+++ b/install/kubernetes/cilium/templates/validate.yaml
@@ -48,10 +48,10 @@
   {{- end }}
 {{- end }}
 
-{{- if or .Values.ingressController.enabled .Values.gatewayAPI.enabled }}
+{{- if or .Values.ingressController.enabled .Values.gatewayAPI.enabled (eq .Values.loadBalancer.l7.backend "envoy") }}
   {{- if hasKey .Values "l7Proxy" }}
     {{- if not .Values.l7Proxy }}
-      {{ fail "Ingress or Gateway API controller requires .Values.l7Proxy to be set to 'true'" }}
+      {{ fail "Ingress or Gateway API controller or Envoy L7 Load Balancer  requires .Values.l7Proxy to be set to 'true'" }}
     {{- end }}
   {{- end }}
 {{- end }}
