From b0f7d0a97a06bd5598d012bfbaf78638b4cc1cbd Mon Sep 17 00:00:00 2001
From: Mariam Fahmy <mariam.fahmy@nirmata.com>
Date: Mon, 5 Feb 2024 14:48:56 +0200
Subject: [PATCH] feat: add chainsaw test for policy webhook based
 configuration

Signed-off-by: Mariam Fahmy <mariam.fahmy@nirmata.com>
---
 .../webhook-registeration/README.md           | 11 +++++
 .../webhook-registeration/chainsaw-test.yaml  | 28 ++++++++++++
 .../webhook-registeration/policy-assert.yaml  |  9 ++++
 .../webhook-registeration/policy.yaml         | 43 +++++++++++++++++++
 .../webhook-registeration/webhook.yaml        | 27 ++++++++++++
 5 files changed, 118 insertions(+)
 create mode 100644 test/conformance/chainsaw/webhook-configurations/webhook-registeration/README.md
 create mode 100755 test/conformance/chainsaw/webhook-configurations/webhook-registeration/chainsaw-test.yaml
 create mode 100644 test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy-assert.yaml
 create mode 100644 test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy.yaml
 create mode 100644 test/conformance/chainsaw/webhook-configurations/webhook-registeration/webhook.yaml

diff --git a/test/conformance/chainsaw/webhook-configurations/webhook-registeration/README.md b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/README.md
new file mode 100644
index 000000000000..ca7d0d578d35
--- /dev/null
+++ b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/README.md
@@ -0,0 +1,11 @@
+## Description
+
+This test checks fine-grained webhook configuration is synced to admission webhooks.
+
+## Expected Behavior
+
+When a policy is created, a webhook rule is automatically created with the same `matchConditions` as configured in the policy. The corresponding webhook rule will be deleted when the policy is deleted.
+
+## Reference Issue(s)
+
+#9111
diff --git a/test/conformance/chainsaw/webhook-configurations/webhook-registeration/chainsaw-test.yaml b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/chainsaw-test.yaml
new file mode 100755
index 000000000000..32755567a2bd
--- /dev/null
+++ b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/chainsaw-test.yaml
@@ -0,0 +1,28 @@
+apiVersion: chainsaw.kyverno.io/v1alpha1
+kind: Test
+metadata:
+  creationTimestamp: null
+  name: webhook-registeration
+spec:
+  steps:
+  - name: step-01
+    try:
+    - apply:
+        file: policy.yaml
+    - assert:
+        file: policy-assert.yaml
+  - name: step-02
+    try:
+    - assert:
+        file: webhook.yaml
+  - name: step-03
+    try:
+    - delete:
+        ref:
+          apiVersion: kyverno.io/v1
+          kind: ClusterPolicy
+          name: cpol-fine-grained-match-conditions-disallow-latest-image-tag-1
+  - name: step-04
+    try:
+    - error:
+      file: webhook.yaml
diff --git a/test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy-assert.yaml b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy-assert.yaml
new file mode 100644
index 000000000000..3e6f6d6c701e
--- /dev/null
+++ b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy-assert.yaml
@@ -0,0 +1,9 @@
+apiVersion: kyverno.io/v1
+kind: ClusterPolicy
+metadata:
+  name: cpol-fine-grained-match-conditions-disallow-latest-image-tag-1
+status:
+  conditions:
+    - reason: Succeeded
+      status: "True"
+      type: Ready
diff --git a/test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy.yaml b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy.yaml
new file mode 100644
index 000000000000..8265c1c428f6
--- /dev/null
+++ b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/policy.yaml
@@ -0,0 +1,43 @@
+---
+apiVersion: kyverno.io/v1
+kind: ClusterPolicy
+metadata:
+  annotations:
+    pod-policies.kyverno.io/autogen-controllers: none
+  name: cpol-fine-grained-match-conditions-disallow-latest-image-tag-1
+spec:
+  admission: true
+  background: true
+  webhookConfiguration:
+    matchConditions:
+    - name: "select-namespace"
+      expression: '(object.metadata.namespace == "cpol-fine-grained-match-conditions-ns")'
+    - name: 'exclude-requests-by-groups'
+      expression: '!("system:nodes" in request.userInfo.groups)' 
+  rules:
+  - match:
+      any:
+      - resources:
+          kinds:
+          - Pod
+    name: require-image-tag
+    validate:
+      message: An image tag is required
+      pattern:
+        spec:
+          containers:
+          - image: '*:*'
+  - match:
+      any:
+      - resources:
+          kinds:
+          - Pod
+    name: validate-image-tag
+    validate:
+      message: Using a mutable image tag e.g. 'latest' is not allowed
+      pattern:
+        spec:
+          containers:
+          - image: '!*:latest'
+  validationFailureAction: Enforce
+  failurePolicy: Ignore
\ No newline at end of file
diff --git a/test/conformance/chainsaw/webhook-configurations/webhook-registeration/webhook.yaml b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/webhook.yaml
new file mode 100644
index 000000000000..124b3f2e2c0b
--- /dev/null
+++ b/test/conformance/chainsaw/webhook-configurations/webhook-registeration/webhook.yaml
@@ -0,0 +1,27 @@
+apiVersion: admissionregistration.k8s.io/v1
+kind: ValidatingWebhookConfiguration
+metadata:
+  labels:
+    webhook.kyverno.io/managed-by: kyverno
+  name: kyverno-resource-validating-webhook-cfg
+webhooks:
+- failurePolicy: Ignore
+  matchConditions:
+  - expression: (object.metadata.namespace == "cpol-fine-grained-match-conditions-ns")
+    name: select-namespace
+  - expression: '!("system:nodes" in request.userInfo.groups)'
+    name: exclude-requests-by-groups
+  rules:
+  - apiGroups:
+    - ""
+    apiVersions:
+    - v1
+    operations:
+    - CREATE
+    - UPDATE
+    - DELETE
+    - CONNECT
+    resources:
+    - pods
+    - pods/ephemeralcontainers
+    scope: Namespaced
