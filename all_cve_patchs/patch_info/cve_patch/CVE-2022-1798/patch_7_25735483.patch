From 257354834ad71006026e414330cd06c4354c8bee Mon Sep 17 00:00:00 2001
From: Roman Mohr <rmohr@google.com>
Date: Thu, 21 Jul 2022 12:52:46 +0200
Subject: [PATCH] Enable banncheck analyzer

Signed-off-by: Roman Mohr <rmohr@google.com>
---
 BUILD.bazel                              |  1 +
 nogo_config.json                         |  8 +++++
 tools/analyzers/banncheck/banncheck.json | 38 ++++++++++++++++++++++++
 3 files changed, 47 insertions(+)
 create mode 100644 tools/analyzers/banncheck/banncheck.json

diff --git a/BUILD.bazel b/BUILD.bazel
index ff08a6293bf2..20efa79b68e7 100644
--- a/BUILD.bazel
+++ b/BUILD.bazel
@@ -55,6 +55,7 @@ nogo(
     # You can see the what `go vet` does by running `go doc cmd/vet`.
     deps = [
         "//vendor/github.com/nunnatsa/ginkgolinter:go_default_library",
+        "//tools/analyzers/banncheck:go_default_library",
         "//vendor/github.com/gordonklaus/ineffassign/pkg/ineffassign:go_default_library",
         "@org_golang_x_tools//go/analysis/passes/asmdecl:go_default_library",
         "@org_golang_x_tools//go/analysis/passes/assign:go_default_library",
diff --git a/nogo_config.json b/nogo_config.json
index a37220930957..782ebb15600d 100644
--- a/nogo_config.json
+++ b/nogo_config.json
@@ -126,6 +126,14 @@
       "external/": "externaldoesn't pass vet"
     }
   },
+  "bannedAPI": {
+    "only_files": {
+      "pkg/": "only production code must not use banned imports"
+    },
+    "exclude_files": {
+      "pkg/.*_test\\.go": "unit tests are allowed to use banned imports"
+    }
+  },
   "ginkgolinter": {
     "exclude_files": {
       "vendor/": "vendor doesn't pass vet",
diff --git a/tools/analyzers/banncheck/banncheck.json b/tools/analyzers/banncheck/banncheck.json
new file mode 100644
index 000000000000..077cc8a66f82
--- /dev/null
+++ b/tools/analyzers/banncheck/banncheck.json
@@ -0,0 +1,38 @@
+{
+  "imports": [
+    {
+      "name": "kubevirt.io/kubevirt/pkg/unsafepath",
+      "msg": "unsafepath functions allows accessing a safepath.Path in an unsafe way and needs do be used carefully",
+      "exemptions": [
+        {
+          "justification ": "safepath needs access to unsafepath, to construct an unsafepath.Path for unsafe usage",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/safepath"
+        },
+        {
+          "justification ": "virt-chroot needs to deconstruct safepaths to pass them over to the virt-chroot binary",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/virt-handler/virt-chroot"
+        },
+        {
+          "justification ": "TODO: can get away from unsafepath but has no additional security risk since host-disk is insecure by default",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/host-disk"
+        },
+        {
+          "justification ": "TODO: checking if a path is mounted requires a path-string to check against the mount table, can be improved, exploitability risk is very low.",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/virt-handler/isolation"
+        },
+        {
+          "justification ": "XXX: mount entries are recoreded in a separate file with absolute files. No additional risk, but confusing from an audit perspective, must be changed at some point.",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/virt-handler/container-disk"
+        },
+        {
+          "justification ": "XXX: mount entries are recoreded in a separate file with absolute files. No additional risk, but confusing from an audit perspective, must be changed at some point.",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/virt-handler/hotplug-disk"
+        },
+        {
+          "justification ": "for selinux labeling safepaths need to be deconstructed to hand them over to the virt-chroot binary",
+          "allowedPkg": "kubevirt.io/kubevirt/pkg/virt-handler/selinux"
+        }
+      ]
+    }
+  ]
+}
\ No newline at end of file
