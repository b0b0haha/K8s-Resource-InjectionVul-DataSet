From a1ad0315a840063188cc38b9e429524a6f75ed71 Mon Sep 17 00:00:00 2001
From: Roman Mohr <rmohr@google.com>
Date: Thu, 21 Jul 2022 12:52:17 +0200
Subject: [PATCH] Modify banncheck analyzer to be able to consume an embedded
 config

Signed-off-by: Roman Mohr <rmohr@google.com>
---
 tools/analyzers/banncheck/BUILD.bazel         | 13 +++++++
 tools/analyzers/banncheck/banncheck.go        | 19 ++++++++++
 .../banncheck/banncheck/banned_api.go         | 37 ++++++++++++-------
 tools/analyzers/banncheck/config/config.go    | 27 ++++++++------
 4 files changed, 70 insertions(+), 26 deletions(-)
 create mode 100644 tools/analyzers/banncheck/BUILD.bazel
 create mode 100644 tools/analyzers/banncheck/banncheck.go

diff --git a/tools/analyzers/banncheck/BUILD.bazel b/tools/analyzers/banncheck/BUILD.bazel
new file mode 100644
index 000000000000..761f649f1dc3
--- /dev/null
+++ b/tools/analyzers/banncheck/BUILD.bazel
@@ -0,0 +1,13 @@
+load("@io_bazel_rules_go//go:def.bzl", "go_library")
+
+go_library(
+    name = "go_default_library",
+    srcs = ["banncheck.go"],
+    embedsrcs = ["banncheck.json"],
+    importpath = "kubevirt.io/kubevirt/tools/analyzers/banncheck",
+    visibility = ["//visibility:public"],
+    deps = [
+        "//tools/analyzers/banncheck/banncheck:go_default_library",
+        "@org_golang_x_tools//go/analysis:go_default_library",
+    ],
+)
diff --git a/tools/analyzers/banncheck/banncheck.go b/tools/analyzers/banncheck/banncheck.go
new file mode 100644
index 000000000000..09f340ea2038
--- /dev/null
+++ b/tools/analyzers/banncheck/banncheck.go
@@ -0,0 +1,19 @@
+package banncheck
+
+import (
+	"embed"
+
+	banncheck "kubevirt.io/kubevirt/tools/analyzers/banncheck/banncheck"
+
+	"golang.org/x/tools/go/analysis"
+)
+
+//go:embed banncheck.json
+var configFS embed.FS
+
+var Analyzer *analysis.Analyzer
+
+func init() {
+	Analyzer = banncheck.NewAnalyzerWithFS(configFS)
+	Analyzer.Flags.Lookup("configs").Value.Set("banncheck.json")
+}
diff --git a/tools/analyzers/banncheck/banncheck/banned_api.go b/tools/analyzers/banncheck/banncheck/banned_api.go
index 44219971f552..820174506da4 100644
--- a/tools/analyzers/banncheck/banncheck/banned_api.go
+++ b/tools/analyzers/banncheck/banncheck/banned_api.go
@@ -24,6 +24,8 @@ import (
 	"fmt"
 	"go/token"
 	"go/types"
+	"io/fs"
+	"os"
 	"path/filepath"
 	"strings"
 
@@ -33,35 +35,42 @@ import (
 )
 
 // NewAnalyzer returns an analyzer that checks for usage of banned APIs.
-func NewAnalyzer() *analysis.Analyzer {
+func NewAnalyzer(configFS fs.FS) *analysis.Analyzer {
+	return NewAnalyzerWithFS(os.DirFS("/"))
+}
+
+// NewAnalyzer returns an analyzer that checks for usage of banned APIs.
+func NewAnalyzerWithFS(configFS fs.FS) *analysis.Analyzer {
 	fs := flag.NewFlagSet("", flag.ExitOnError)
 	fs.String("configs", "", "Config files with banned APIs separated by a comma")
 
 	a := &analysis.Analyzer{
 		Name:  "bannedAPI",
 		Doc:   "Checks for usage of banned APIs",
-		Run:   checkBannedAPIs,
+		Run:   checkBannedAPIsWithFS(configFS),
 		Flags: *fs,
 	}
 
 	return a
 }
 
-func checkBannedAPIs(pass *analysis.Pass) (interface{}, error) {
-	cfgFiles := pass.Analyzer.Flags.Lookup("configs").Value.String()
-	if cfgFiles == "" {
-		return nil, errors.New("missing config files")
-	}
+func checkBannedAPIsWithFS(configFS fs.FS) func(pass *analysis.Pass) (interface{}, error) {
+	return func(pass *analysis.Pass) (interface{}, error) {
+		cfgFiles := pass.Analyzer.Flags.Lookup("configs").Value.String()
+		if cfgFiles == "" {
+			return nil, errors.New("missing config files")
+		}
 
-	cfg, err := config.ReadConfigs(strings.Split(cfgFiles, ","))
-	if err != nil {
-		return nil, err
-	}
+		cfg, err := config.ReadConfigs(configFS, strings.Split(cfgFiles, ","))
+		if err != nil {
+			return nil, err
+		}
 
-	checkBannedImports(pass, bannedAPIMap(cfg.Imports))
-	checkBannedFunctions(pass, bannedAPIMap(cfg.Functions))
+		checkBannedImports(pass, bannedAPIMap(cfg.Imports))
+		checkBannedFunctions(pass, bannedAPIMap(cfg.Functions))
 
-	return nil, nil
+		return nil, nil
+	}
 }
 
 func checkBannedImports(pass *analysis.Pass, bannedImports map[string][]config.BannedAPI) (interface{}, error) {
diff --git a/tools/analyzers/banncheck/config/config.go b/tools/analyzers/banncheck/config/config.go
index 366c1ad7b6f3..f11c77d5efbf 100644
--- a/tools/analyzers/banncheck/config/config.go
+++ b/tools/analyzers/banncheck/config/config.go
@@ -18,7 +18,7 @@ package config
 import (
 	"encoding/json"
 	"errors"
-	"os"
+	"io/fs"
 )
 
 // Config represents a configuration passed to the linter.
@@ -41,12 +41,12 @@ type Exemption struct {
 }
 
 // ReadConfigs reads banned APIs from all files.
-func ReadConfigs(files []string) (*Config, error) {
+func ReadConfigs(configFS fs.FS, files []string) (*Config, error) {
 	var imports []BannedAPI
 	var fns []BannedAPI
 
 	for _, file := range files {
-		config, err := readCfg(file)
+		config, err := readCfg(configFS, file)
 		if err != nil {
 			return nil, err
 		}
@@ -58,8 +58,8 @@ func ReadConfigs(files []string) (*Config, error) {
 	return &Config{Imports: imports, Functions: fns}, nil
 }
 
-func readCfg(filename string) (*Config, error) {
-	f, err := openFile(filename)
+func readCfg(configFS fs.FS, filename string) (*Config, error) {
+	f, err := openFile(configFS, filename)
 	if err != nil {
 		return nil, err
 	}
@@ -68,19 +68,22 @@ func readCfg(filename string) (*Config, error) {
 	return decodeCfg(f)
 }
 
-func openFile(filename string) (*os.File, error) {
-	info, err := os.Stat(filename)
-	if os.IsNotExist(err) {
-		return nil, errors.New("file does not exist")
+func openFile(configFS fs.FS, filename string) (fs.File, error) {
+	file, err := configFS.Open(filename)
+	if err != nil {
+		return nil, err
+	}
+	info, err := file.Stat()
+	if err != nil {
+		return nil, err
 	}
 	if info.IsDir() {
 		return nil, errors.New("file is a directory")
 	}
-
-	return os.Open(filename)
+	return file, nil
 }
 
-func decodeCfg(f *os.File) (*Config, error) {
+func decodeCfg(f fs.File) (*Config, error) {
 	var cfg Config
 	err := json.NewDecoder(f).Decode(&cfg)
 	if err != nil {
