{
  "index": 2,
  "original_url": "https://github.com/cilium/cilium/commit/175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
  "patch_url": "https://github.com/cilium/cilium/commit/175fb8fa5e2e42b623d15a7863b440ed1e3cd94d.patch",
  "commit_info": {
    "type": "pr_commit",
    "hash": "175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
    "url": "https://github.com/cilium/cilium/commit/175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
    "pr_url": "https://github.com/cilium/cilium/pull/28007",
    "pr_number": "28007",
    "owner": "cilium",
    "repo": "cilium",
    "message": "k8s: Restrict configuring reserved:init policy via CNP\n\nTypically if the policy target EndpointSelector does not include a\nnamespace, parsing will inject the namespace to ensure that only Pods\nwithin the same namespace can be selected. Furthermore, for peer\nEndpointSelectors there is a similar behaviour where ingress or egress\nis allowed only to the current namespace unless the user specifies which\nnamespace the peer exists in. However, these defaults did not previously\napply to policies that select the reserved:init Identity, since this\nIdentity is not inherently namespaced, and hence automatically injecting\nthe namespace would cause the policy to no longer match this Identity.\n\nThe reserved:init Identity was introduced in order to allow a different\npolicy to apply to Pods as they start up, iff the full Identity of those\nworkloads cannot be determined when they are first connecting to the\nCilium network (CNI ADD). In order to support this special reserved:init\nIdentity, various exceptions were introduced into CiliumNetworkPolicy\nparser that removed the automatic insertion of namespace into the\npolicies when there were label matches for the reserved:init namespace.\n\nThe awkward part about this abstraction early on was that there was no\nway to directly associate the reserved:init Identity to any specific\nKubernetes namespace, and yet CiliumNetworkPolicy was always inherently\ntied to a specific namespace. Since the introduction of the\nreserved:init Identity, CiliumClusterwideNetworkPolicy was also\nintroduced, which is a much better fit for the ability to select\nendpoints that are not inherently namespaced.\n\nThis patch deprecates support for applying network policies for the\nreserved:init Identity via CiliumNetworkPolicy in favour of\nCiliumClusterwideNetworkPolicy. As a benefit, this allows us to simplify\nthe logic that applies the namespaces into the policies and reduce the\nlikelihood of misconfigurations.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
    "author": "Joe Stringer",
    "date": "2023-09-05T21:38:03Z"
  },
  "patch_stats": {
    "files_modified": 4,
    "lines_added": 98,
    "lines_removed": 8,
    "total_changes": 106,
    "file_list": [
      "Documentation/operations/upgrade.rst",
      "examples/policies/l4/init.yaml",
      "pkg/k8s/apis/cilium.io/utils/utils.go",
      "pkg/k8s/apis/cilium.io/utils/utils_test.go"
    ],
    "file_extensions": [
      "go",
      "rst",
      "yaml"
    ],
    "binary_files": 0
  }
}