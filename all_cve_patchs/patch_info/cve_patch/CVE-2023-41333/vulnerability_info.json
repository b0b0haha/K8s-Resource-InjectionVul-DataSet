{
  "cve_id": "CVE-2023-41333",
  "description": "Cilium is a networking, observability, and security solution with an eBPF-based dataplane. An attacker with the ability to create or modify CiliumNetworkPolicy objects in a particular namespace is able to affect traffic on an entire Cilium cluster, potentially bypassing policy enforcement in other namespaces. By using a crafted `endpointSelector` that uses the `DoesNotExist` operator on the `reserved:init` label, the attacker can create policies that bypass namespace restrictions and affect the entire Cilium cluster. This includes potentially allowing or denying all traffic. This attack requires API server access, as described in the Kubernetes API Server Attacker section of the Cilium Threat Model. This issue has been resolved in Cilium versions 1.14.2, 1.13.7, and 1.12.14. As a workaround an admission webhook can be used to prevent the use of `endpointSelectors` that use the `DoesNotExist` operator on the `reserved:init` label in CiliumNetworkPolicies.\n",
  "references": [
    "https://docs.cilium.io/en/stable/security/threat-model/#kubernetes-api-server-attacker",
    "https://github.com/cilium/cilium/pull/28007",
    "https://github.com/cilium/cilium/security/advisories/GHSA-4xp2-w642-7mcx"
  ],
  "commit_urls": [],
  "pr_urls": [
    "https://github.com/cilium/cilium/pull/28007"
  ],
  "issue_urls": [],
  "advisory_urls": [
    "https://github.com/cilium/cilium/security/advisories/GHSA-4xp2-w642-7mcx"
  ],
  "related_commits": [
    {
      "type": "pr_commit",
      "hash": "029cb4447920d3ae134318d7ee9c73e449e9ed41",
      "url": "https://github.com/cilium/cilium/commit/029cb4447920d3ae134318d7ee9c73e449e9ed41",
      "pr_url": "https://github.com/cilium/cilium/pull/28007",
      "pr_number": "28007",
      "owner": "cilium",
      "repo": "cilium",
      "message": "k8s: Change test for reserved:init to CCNP\n\nChange the expected test for policies that apply to reserved:init pod to\nassume that CCNP is used to configure this type of policy.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
      "author": "Joe Stringer",
      "date": "2023-09-05T21:37:18Z"
    },
    {
      "type": "pr_commit",
      "hash": "175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
      "url": "https://github.com/cilium/cilium/commit/175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
      "pr_url": "https://github.com/cilium/cilium/pull/28007",
      "pr_number": "28007",
      "owner": "cilium",
      "repo": "cilium",
      "message": "k8s: Restrict configuring reserved:init policy via CNP\n\nTypically if the policy target EndpointSelector does not include a\nnamespace, parsing will inject the namespace to ensure that only Pods\nwithin the same namespace can be selected. Furthermore, for peer\nEndpointSelectors there is a similar behaviour where ingress or egress\nis allowed only to the current namespace unless the user specifies which\nnamespace the peer exists in. However, these defaults did not previously\napply to policies that select the reserved:init Identity, since this\nIdentity is not inherently namespaced, and hence automatically injecting\nthe namespace would cause the policy to no longer match this Identity.\n\nThe reserved:init Identity was introduced in order to allow a different\npolicy to apply to Pods as they start up, iff the full Identity of those\nworkloads cannot be determined when they are first connecting to the\nCilium network (CNI ADD). In order to support this special reserved:init\nIdentity, various exceptions were introduced into CiliumNetworkPolicy\nparser that removed the automatic insertion of namespace into the\npolicies when there were label matches for the reserved:init namespace.\n\nThe awkward part about this abstraction early on was that there was no\nway to directly associate the reserved:init Identity to any specific\nKubernetes namespace, and yet CiliumNetworkPolicy was always inherently\ntied to a specific namespace. Since the introduction of the\nreserved:init Identity, CiliumClusterwideNetworkPolicy was also\nintroduced, which is a much better fit for the ability to select\nendpoints that are not inherently namespaced.\n\nThis patch deprecates support for applying network policies for the\nreserved:init Identity via CiliumNetworkPolicy in favour of\nCiliumClusterwideNetworkPolicy. As a benefit, this allows us to simplify\nthe logic that applies the namespaces into the policies and reduce the\nlikelihood of misconfigurations.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
      "author": "Joe Stringer",
      "date": "2023-09-05T21:38:03Z"
    },
    {
      "type": "pr_commit",
      "hash": "f5557613de9e694a1ebfb5291e5f88f721e4dac6",
      "url": "https://github.com/cilium/cilium/commit/f5557613de9e694a1ebfb5291e5f88f721e4dac6",
      "pr_url": "https://github.com/cilium/cilium/pull/28007",
      "pr_number": "28007",
      "owner": "cilium",
      "repo": "cilium",
      "message": "k8s: Add validation for init policy selection\n\nExtend the CNP validation (including preflight checks) to warn users\nthat they are using a policy configuration that is no longer supported.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
      "author": "Joe Stringer",
      "date": "2023-09-07T20:16:27Z"
    }
  ],
  "commits": [
    {
      "type": "pr_commit",
      "hash": "029cb4447920d3ae134318d7ee9c73e449e9ed41",
      "url": "https://github.com/cilium/cilium/commit/029cb4447920d3ae134318d7ee9c73e449e9ed41",
      "pr_url": "https://github.com/cilium/cilium/pull/28007",
      "pr_number": "28007",
      "owner": "cilium",
      "repo": "cilium",
      "message": "k8s: Change test for reserved:init to CCNP\n\nChange the expected test for policies that apply to reserved:init pod to\nassume that CCNP is used to configure this type of policy.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
      "author": "Joe Stringer",
      "date": "2023-09-05T21:37:18Z"
    },
    {
      "type": "pr_commit",
      "hash": "175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
      "url": "https://github.com/cilium/cilium/commit/175fb8fa5e2e42b623d15a7863b440ed1e3cd94d",
      "pr_url": "https://github.com/cilium/cilium/pull/28007",
      "pr_number": "28007",
      "owner": "cilium",
      "repo": "cilium",
      "message": "k8s: Restrict configuring reserved:init policy via CNP\n\nTypically if the policy target EndpointSelector does not include a\nnamespace, parsing will inject the namespace to ensure that only Pods\nwithin the same namespace can be selected. Furthermore, for peer\nEndpointSelectors there is a similar behaviour where ingress or egress\nis allowed only to the current namespace unless the user specifies which\nnamespace the peer exists in. However, these defaults did not previously\napply to policies that select the reserved:init Identity, since this\nIdentity is not inherently namespaced, and hence automatically injecting\nthe namespace would cause the policy to no longer match this Identity.\n\nThe reserved:init Identity was introduced in order to allow a different\npolicy to apply to Pods as they start up, iff the full Identity of those\nworkloads cannot be determined when they are first connecting to the\nCilium network (CNI ADD). In order to support this special reserved:init\nIdentity, various exceptions were introduced into CiliumNetworkPolicy\nparser that removed the automatic insertion of namespace into the\npolicies when there were label matches for the reserved:init namespace.\n\nThe awkward part about this abstraction early on was that there was no\nway to directly associate the reserved:init Identity to any specific\nKubernetes namespace, and yet CiliumNetworkPolicy was always inherently\ntied to a specific namespace. Since the introduction of the\nreserved:init Identity, CiliumClusterwideNetworkPolicy was also\nintroduced, which is a much better fit for the ability to select\nendpoints that are not inherently namespaced.\n\nThis patch deprecates support for applying network policies for the\nreserved:init Identity via CiliumNetworkPolicy in favour of\nCiliumClusterwideNetworkPolicy. As a benefit, this allows us to simplify\nthe logic that applies the namespaces into the policies and reduce the\nlikelihood of misconfigurations.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
      "author": "Joe Stringer",
      "date": "2023-09-05T21:38:03Z"
    },
    {
      "type": "pr_commit",
      "hash": "f5557613de9e694a1ebfb5291e5f88f721e4dac6",
      "url": "https://github.com/cilium/cilium/commit/f5557613de9e694a1ebfb5291e5f88f721e4dac6",
      "pr_url": "https://github.com/cilium/cilium/pull/28007",
      "pr_number": "28007",
      "owner": "cilium",
      "repo": "cilium",
      "message": "k8s: Add validation for init policy selection\n\nExtend the CNP validation (including preflight checks) to warn users\nthat they are using a policy configuration that is no longer supported.\n\nSigned-off-by: Joe Stringer <joe@cilium.io>",
      "author": "Joe Stringer",
      "date": "2023-09-07T20:16:27Z"
    }
  ]
}