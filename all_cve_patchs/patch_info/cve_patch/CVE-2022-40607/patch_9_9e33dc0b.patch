From fa32d7328ee2721b8bdc1ee5a06fc962084b8bba Mon Sep 17 00:00:00 2001
From: vrushch <Vrushal.Chaudhari@ibm.com>
Date: Tue, 12 Jul 2022 14:20:49 +0530
Subject: [PATCH] Automation: Fixing permissions testcases for version:2 (#760)

Signed-off-by: vrushch <Vrushal.Chaudhari@ibm.com>
---
 .../ibm_spectrum_scale_csi/base_class.py      | 14 +++++-------
 .../kubernetes_apis/csi_storage_function.py   | 22 ++++++++++++++-----
 .../spectrum_scale_apis/fileset_functions.py  |  7 ++++--
 .../tests/consistency_group_test.py           |  1 -
 .../remotecluster_consistency_group_test.py   |  1 -
 5 files changed, 28 insertions(+), 17 deletions(-)

diff --git a/tests/functional-tests/ibm_spectrum_scale_csi/base_class.py b/tests/functional-tests/ibm_spectrum_scale_csi/base_class.py
index 89cdde166..ab92dc262 100644
--- a/tests/functional-tests/ibm_spectrum_scale_csi/base_class.py
+++ b/tests/functional-tests/ibm_spectrum_scale_csi/base_class.py
@@ -290,9 +290,8 @@ def test_dynamic(self, value_sc, value_pvc_passed=None, value_pod_passed=None, v
             csistoragefunc.create_pvc(value_pvc_pass, sc_name, pvc_name, created_objects)
             val = csistoragefunc.check_pvc(value_pvc_pass, pvc_name, created_objects)
             if val is True:
-                if "permissions" in value_sc.keys():
-                    csistoragefunc.check_permissions_for_pvc(
-                        pvc_name, value_sc["permissions"], created_objects)
+                csistoragefunc.check_permissions_for_pvc(
+                        pvc_name, value_sc, created_objects)
 
                 for num2, _ in enumerate(value_pod_passed):
                     LOGGER.info(100*"-")
@@ -480,9 +479,9 @@ def test_dynamic(self, value_sc, test_restore, value_vs_class=None, number_of_sn
             csistoragefunc.create_pvc(pvc_value, sc_name, pvc_name, created_objects)
             val = csistoragefunc.check_pvc(pvc_value, pvc_name, created_objects)
 
-            if val is True and "permissions" in value_sc.keys():
+            if val is True:
                 csistoragefunc.check_permissions_for_pvc(
-                    pvc_name, value_sc["permissions"], created_objects)
+                    pvc_name, value_sc, created_objects)
 
             pod_name = csistoragefunc.get_random_name("snap-start-pod")
             if value_pod is None:
@@ -531,11 +530,10 @@ def test_dynamic(self, value_sc, test_restore, value_vs_class=None, number_of_sn
                     csistoragefunc.create_pvc_from_snapshot(
                         pvc_value, restore_sc_name, restored_pvc_name, vs_name+"-"+str(num), created_objects)
                     val = csistoragefunc.check_pvc(pvc_value, restored_pvc_name, created_objects)
-                    if val is True and "permissions" in value_sc.keys():
-                        csistoragefunc.check_permissions_for_pvc(
-                            pvc_name, value_sc["permissions"], created_objects)
 
                     if val is True:
+                        csistoragefunc.check_permissions_for_pvc(
+                            pvc_name, value_sc, created_objects)
                         csistoragefunc.create_pod(
                             value_pod, restored_pvc_name, snap_pod_name, created_objects, self.image_name)
                         csistoragefunc.check_pod(value_pod, snap_pod_name, created_objects)
diff --git a/tests/functional-tests/ibm_spectrum_scale_csi/kubernetes_apis/csi_storage_function.py b/tests/functional-tests/ibm_spectrum_scale_csi/kubernetes_apis/csi_storage_function.py
index 455da901f..66f6f0bce 100644
--- a/tests/functional-tests/ibm_spectrum_scale_csi/kubernetes_apis/csi_storage_function.py
+++ b/tests/functional-tests/ibm_spectrum_scale_csi/kubernetes_apis/csi_storage_function.py
@@ -1086,15 +1086,28 @@ def get_pv_for_pvc(pvc_name, created_objects):
     return api_response.spec.volume_name
 
 
-def check_permissions_for_pvc(pvc_name, permissions, created_objects):
+def check_permissions_for_pvc(pvc_name, storage_class_parameters, created_objects):
     """
     get pv and verify permissions for pv
     """
+    if "permissions" not in value_sc.keys() or "shared" not in value_sc.keys():
+        return
+
+    if "permissions" in value_sc.keys():
+        permissions = storage_class_parameters["permissions"]
+    elif storage_class_parameters["shared"]=="True":
+        permissions = "777"
+    else:
+        return 
+
     pv_name = get_pv_for_pvc(pvc_name, created_objects)
     fileset_name = get_filesetname_from_pv(pv_name, created_objects)
+    cg_fileset_name = None
+    if "version" in storage_class_parameters and storage_class_parameters["version"] == "2":
+        cg_fileset_name = get_cg_filesetname_from_pv(pv_name, created_objects)
     if permissions == "":  # assign default permissions 771
         permissions = "771"
-    status = filesetfunc.get_and_verify_fileset_permissions(fileset_name, permissions)
+    status = filesetfunc.get_and_verify_fileset_permissions(fileset_name, permissions, cg_fileset_name)
     if status is True:
         LOGGER.info(f'PASS: Testing storageclass parameter permissions={permissions} passed.')
     else:
@@ -1172,9 +1185,8 @@ def clone_and_check_pvc(sc_name, value_sc, pvc_name, pod_name, value_pod, clone_
                              clone_pvc_name, pvc_name, created_objects)
             val = check_pvc(clone_pvc_value, clone_pvc_name, created_objects)
             if val is True:
-                if "permissions" in value_sc.keys():
-                    check_permissions_for_pvc(
-                        clone_pvc_name, value_sc["permissions"], created_objects)
+                check_permissions_for_pvc(
+                        clone_pvc_name, value_sc, created_objects)
 
                 if value_sc.keys() >= {"permissions", "gid", "uid"}:
                     value_pod["runAsGroup"] = value_sc["gid"]
diff --git a/tests/functional-tests/ibm_spectrum_scale_csi/spectrum_scale_apis/fileset_functions.py b/tests/functional-tests/ibm_spectrum_scale_csi/spectrum_scale_apis/fileset_functions.py
index bb1836102..38df4f1f8 100644
--- a/tests/functional-tests/ibm_spectrum_scale_csi/spectrum_scale_apis/fileset_functions.py
+++ b/tests/functional-tests/ibm_spectrum_scale_csi/spectrum_scale_apis/fileset_functions.py
@@ -688,7 +688,7 @@ def get_scale_version(test_data):
     LOGGER.info(f'scale version is {response_dict["info"]["serverVersion"]}')
 
 
-def get_and_verify_fileset_permissions(volume_name, mode):
+def get_and_verify_fileset_permissions(volume_name, mode, cg_fileset_name):
     """
 
     Get permissions for pv path and ensure they match with parameter mode.
@@ -720,7 +720,10 @@ def get_and_verify_fileset_permissions(volume_name, mode):
     """
 
     # get acl for a path
-    get_link = f'https://{test["guiHost"]}:{test["port"]}/scalemgmt/v2/filesystems/{test["primaryFs"]}/acl/{volume_name}%2F{volume_name}-data'
+    if cg_fileset_name is not None:
+        get_link = f'https://{test["guiHost"]}:{test["port"]}/scalemgmt/v2/filesystems/{test["primaryFs"]}/acl/{cg_fileset_name}%2F{volume_name}'
+    else:
+        get_link = f'https://{test["guiHost"]}:{test["port"]}/scalemgmt/v2/filesystems/{test["primaryFs"]}/acl/{volume_name}%2F{volume_name}-data'
 
     response = requests.get(get_link, verify=False, auth=(test["username"], test["password"]))
     LOGGER.debug(response.text)
diff --git a/tests/functional-tests/tests/consistency_group_test.py b/tests/functional-tests/tests/consistency_group_test.py
index 8dec0fd94..25b68b636 100644
--- a/tests/functional-tests/tests/consistency_group_test.py
+++ b/tests/functional-tests/tests/consistency_group_test.py
@@ -120,7 +120,6 @@ def test_driver_cg_expansion_2():
     driver_object.test_dynamic(value_sc, value_pvc_passed=value_pvc, value_pod_passed=value_pod)
 
 
-@pytest.mark.xfail
 def test_driver_cg_permissions_777_1():
     value_pod = [{"mount_path": "/usr/share/nginx/html/scale", "read_only": "False", "sub_path": ["sub_path_mnt"], "volumemount_readonly":[False], "runAsUser": "2000", "runAsGroup": "5000"},
                  {"mount_path": "/usr/share/nginx/html/scale", "read_only": "False", "sub_path": ["sub_path_mnt"], "volumemount_readonly":[True],
diff --git a/tests/functional-tests/tests/remotecluster_consistency_group_test.py b/tests/functional-tests/tests/remotecluster_consistency_group_test.py
index bf204b0f5..bb5ddd933 100644
--- a/tests/functional-tests/tests/remotecluster_consistency_group_test.py
+++ b/tests/functional-tests/tests/remotecluster_consistency_group_test.py
@@ -124,7 +124,6 @@ def test_driver_cg_expansion_2():
     driver_object.test_dynamic(value_sc, value_pvc_passed=value_pvc, value_pod_passed=value_pod)
 
 
-@pytest.mark.xfail
 def test_driver_cg_permissions_777_1():
     value_pod = [{"mount_path": "/usr/share/nginx/html/scale", "read_only": "False", "sub_path": ["sub_path_mnt"], "volumemount_readonly":[False], "runAsUser": "2000", "runAsGroup": "5000"},
                  {"mount_path": "/usr/share/nginx/html/scale", "read_only": "False", "sub_path": ["sub_path_mnt"], "volumemount_readonly":[True],
