From ad5e6a1700e6efb969711747f047c19b2f9b330f Mon Sep 17 00:00:00 2001
From: amdabhad <amdabhad@in.ibm.com>
Date: Wed, 6 Jul 2022 07:58:59 -0700
Subject: [PATCH] Fix PV mounting

* Before mounting a volume, check whether the path is of type "gpfs"

Signed-off-by: amdabhad <amdabhad@in.ibm.com>
---
 driver/csiplugin/nodeserver.go | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/driver/csiplugin/nodeserver.go b/driver/csiplugin/nodeserver.go
index 8619aec2b..04cd0cb84 100644
--- a/driver/csiplugin/nodeserver.go
+++ b/driver/csiplugin/nodeserver.go
@@ -19,6 +19,7 @@ package scale
 import (
 	"fmt"
 	"os"
+	"strings"
 	"sync"
 
 	"github.com/IBM/ibm-spectrum-scale-csi/driver/csiplugin/utils"
@@ -95,6 +96,17 @@ func (ns *ScaleNodeServer) NodePublishVolume(ctx context.Context, req *csi.NodeP
 		}
 	} else {
 		//Use bind mount
+		volScalePathInContainer := hostDir + volScalePath
+		args := []string{"-f", "-c", "%T", volScalePathInContainer}
+		out, err := executeCmd("stat", args)
+		if err != nil {
+			return nil, fmt.Errorf("NodePublishVolume: failed to get stat of [%s]. Error [%v]", volScalePathInContainer, err)
+		}
+		outString := fmt.Sprintf("%s", out)
+		outString = strings.TrimRight(outString, "\n")
+		if outString != "gpfs" {
+			return nil, fmt.Errorf("NodePublishVolume: the path [%s] is not a valid gpfs path, the path is of type [%s]", volScalePath, outString)
+		}
 		notMP, err := mount.IsNotMountPoint(mount.New(""), targetPath)
 		if err != nil {
 			if os.IsNotExist(err) {
