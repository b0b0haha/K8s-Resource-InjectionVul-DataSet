From 3f4e369bb29a2d9b54ec054a6617ec068676881f Mon Sep 17 00:00:00 2001
From: amdabhad <amdabhad@in.ibm.com>
Date: Wed, 13 Jul 2022 02:06:33 -0700
Subject: [PATCH] Follow the symlink to check the type of target path

Signed-off-by: amdabhad <amdabhad@in.ibm.com>
---
 driver/csiplugin/nodeserver.go | 15 +++++++++------
 1 file changed, 9 insertions(+), 6 deletions(-)

diff --git a/driver/csiplugin/nodeserver.go b/driver/csiplugin/nodeserver.go
index d28f14359..86663867d 100644
--- a/driver/csiplugin/nodeserver.go
+++ b/driver/csiplugin/nodeserver.go
@@ -69,15 +69,18 @@ func (ns *ScaleNodeServer) NodePublishVolume(ctx context.Context, req *csi.NodeP
 	glog.V(4).Infof("Target SpectrumScale Path : %v\n", volScalePath)
 
 	volScalePathInContainer := hostDir + volScalePath
-
-	pathInfo, err := os.Stat(volScalePathInContainer)
+	f, err := os.Lstat(volScalePathInContainer)
 	if err != nil {
-		return nil, fmt.Errorf("NodePublishVolume: failed to get stat of [%s]. Error [%v]", volScalePathInContainer, err)
+		return nil, fmt.Errorf("NodePublishVolume: failed to get lstat of [%s]. Error %v", volScalePathInContainer, err)
 	}
-	if !pathInfo.IsDir() {
-		return nil, fmt.Errorf("NodePublishVolume: [%s] is not directory", volScalePathInContainer)
+	if f.Mode()&os.ModeSymlink != 0 {
+		symlinkTarget, readlinkErr := os.Readlink(volScalePathInContainer)
+		if readlinkErr != nil {
+			return nil, fmt.Errorf("NodePublishVolume: failed to get symlink target for [%s]. Error [%v]", volScalePathInContainer, readlinkErr)
+		}
+		volScalePathInContainer = hostDir + symlinkTarget
+		glog.V(4).Infof("NodePublishVolume: symlink tarrget path is [%s]\n", volScalePathInContainer)
 	}
-
 	args := []string{"-f", "-c", "%T", volScalePathInContainer}
 
 	out, err := executeCmd("stat", args)
