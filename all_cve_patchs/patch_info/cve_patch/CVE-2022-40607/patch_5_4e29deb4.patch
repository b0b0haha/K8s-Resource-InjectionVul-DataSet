From 4e29deb44b48ac7cd9d18a0b54109a96fc0b3d11 Mon Sep 17 00:00:00 2001
From: amdabhad <amdabhad@in.ibm.com>
Date: Thu, 7 Jul 2022 03:40:34 -0700
Subject: [PATCH] - Removed deprecated symlink code - Added a check to block
 using symlink as source for bind mount

Signed-off-by: amdabhad <amdabhad@in.ibm.com>
---
 driver/csiplugin/nodeserver.go | 89 +++++++++++++---------------------
 1 file changed, 35 insertions(+), 54 deletions(-)

diff --git a/driver/csiplugin/nodeserver.go b/driver/csiplugin/nodeserver.go
index 04cd0cb84..d28f14359 100644
--- a/driver/csiplugin/nodeserver.go
+++ b/driver/csiplugin/nodeserver.go
@@ -68,66 +68,47 @@ func (ns *ScaleNodeServer) NodePublishVolume(ctx context.Context, req *csi.NodeP
 
 	glog.V(4).Infof("Target SpectrumScale Path : %v\n", volScalePath)
 
-	// Check if /host directory exists, if exists use bind mount,
-	// otherwise use symlink
-	hostDirMounted := false
-	if _, err = os.Stat(hostDir); err == nil {
-		hostDirMounted = true
-	} else if !os.IsNotExist(err) {
-		return nil, fmt.Errorf("failed to get stat of [%s]. Error [%v]", hostDir, err)
+	volScalePathInContainer := hostDir + volScalePath
+
+	pathInfo, err := os.Stat(volScalePathInContainer)
+	if err != nil {
+		return nil, fmt.Errorf("NodePublishVolume: failed to get stat of [%s]. Error [%v]", volScalePathInContainer, err)
+	}
+	if !pathInfo.IsDir() {
+		return nil, fmt.Errorf("NodePublishVolume: [%s] is not directory", volScalePathInContainer)
 	}
 
-	if !hostDirMounted {
-		//Use symlink
-		//Check if mount dir/slink exists, if yes delete it
-		if _, err := os.Lstat(targetPath); !os.IsNotExist(err) {
-			glog.V(4).Infof("NodePublishVolume - deleting the targetPath - [%v]", targetPath)
-			err := os.Remove(targetPath)
-			if err != nil {
-				return nil, status.Error(codes.Internal, fmt.Sprintf("failed to delete the target path - [%s]. Error [%v]", targetPath, err.Error()))
-			}
-		}
+	args := []string{"-f", "-c", "%T", volScalePathInContainer}
 
-		// create symlink
-		glog.V(4).Infof("NodePublishVolume - creating symlink [%v] -> [%v]", targetPath, volScalePath)
-		symlinkerr := os.Symlink(volScalePath, targetPath)
-		if symlinkerr != nil {
-			return nil, status.Error(codes.Internal, fmt.Sprintf("failed to create symlink [%s] -> [%s]. Error [%v]", targetPath, volScalePath, symlinkerr.Error()))
-		}
-	} else {
-		//Use bind mount
-		volScalePathInContainer := hostDir + volScalePath
-		args := []string{"-f", "-c", "%T", volScalePathInContainer}
-		out, err := executeCmd("stat", args)
-		if err != nil {
-			return nil, fmt.Errorf("NodePublishVolume: failed to get stat of [%s]. Error [%v]", volScalePathInContainer, err)
-		}
-		outString := fmt.Sprintf("%s", out)
-		outString = strings.TrimRight(outString, "\n")
-		if outString != "gpfs" {
-			return nil, fmt.Errorf("NodePublishVolume: the path [%s] is not a valid gpfs path, the path is of type [%s]", volScalePath, outString)
-		}
-		notMP, err := mount.IsNotMountPoint(mount.New(""), targetPath)
-		if err != nil {
-			if os.IsNotExist(err) {
-				if err = os.Mkdir(targetPath, 0750); err != nil {
-					return nil, fmt.Errorf("failed to create target path [%s]. Error [%v]", targetPath, err)
-				}
-			} else {
-				return nil, fmt.Errorf("failed to check target path [%s]. Error [%v]", targetPath, err)
+	out, err := executeCmd("stat", args)
+	if err != nil {
+		return nil, fmt.Errorf("NodePublishVolume: failed to get type of file with stat of [%s]. Error [%v]", volScalePathInContainer, err)
+	}
+	outString := fmt.Sprintf("%s", out)
+	outString = strings.TrimRight(outString, "\n")
+	if outString != "gpfs" {
+		return nil, fmt.Errorf("NodePublishVolume: the path [%s] is not a valid gpfs path, the path is of type [%s]", volScalePath, outString)
+	}
+	notMP, err := mount.IsNotMountPoint(mount.New(""), targetPath)
+	if err != nil {
+		if os.IsNotExist(err) {
+			if err = os.Mkdir(targetPath, 0750); err != nil {
+				return nil, fmt.Errorf("failed to create target path [%s]. Error [%v]", targetPath, err)
 			}
+		} else {
+			return nil, fmt.Errorf("failed to check target path [%s]. Error [%v]", targetPath, err)
 		}
-		if !notMP {
-			return &csi.NodePublishVolumeResponse{}, nil
-		}
+	}
+	if !notMP {
+		return &csi.NodePublishVolumeResponse{}, nil
+	}
 
-		// create bind mount
-		options := []string{"bind"}
-		mounter := mount.New("")
-		glog.V(4).Infof("NodePublishVolume - creating bind mount [%v] -> [%v]", targetPath, volScalePath)
-		if err := mounter.Mount(volScalePath, targetPath, "", options); err != nil {
-			return nil, fmt.Errorf("failed to mount: [%s] at [%s]. Error [%v]", volScalePath, targetPath, err)
-		}
+	// create bind mount
+	options := []string{"bind"}
+	mounter := mount.New("")
+	glog.V(4).Infof("NodePublishVolume - creating bind mount [%v] -> [%v]", targetPath, volScalePath)
+	if err := mounter.Mount(volScalePath, targetPath, "", options); err != nil {
+		return nil, fmt.Errorf("failed to mount: [%s] at [%s]. Error [%v]", volScalePath, targetPath, err)
 	}
 
 	glog.V(4).Infof("successfully mounted %s", targetPath)
