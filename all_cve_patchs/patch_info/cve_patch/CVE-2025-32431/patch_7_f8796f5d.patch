From f8796f5d7016749421e9a88d2cb1c9b632b3630e Mon Sep 17 00:00:00 2001
From: romain <rtribotte@users.noreply.github.com>
Date: Tue, 15 Apr 2025 12:06:53 +0200
Subject: [PATCH] review: denyfragment before cleaning the path

---
 pkg/server/server_entrypoint_tcp.go | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/pkg/server/server_entrypoint_tcp.go b/pkg/server/server_entrypoint_tcp.go
index 8e400c5f4e..723d6a1d0b 100644
--- a/pkg/server/server_entrypoint_tcp.go
+++ b/pkg/server/server_entrypoint_tcp.go
@@ -571,7 +571,6 @@ func createHTTPServer(ctx context.Context, ln net.Listener, configuration *stati
 		return nil, err
 	}
 
-	handler = denyFragment(handler)
 	// cleanPath is used to clean the URL path by removing /../, /./ and duplicate slash sequences,
 	// to make sure the path is interpreted by the backends as it is evaluated inside rule matchers.
 	handler = cleanPath(handler)
@@ -593,6 +592,8 @@ func createHTTPServer(ctx context.Context, ln net.Listener, configuration *stati
 		})
 	}
 
+	handler = denyFragment(handler)
+
 	serverHTTP := &http.Server{
 		Handler:      handler,
 		ErrorLog:     httpServerLogger,
