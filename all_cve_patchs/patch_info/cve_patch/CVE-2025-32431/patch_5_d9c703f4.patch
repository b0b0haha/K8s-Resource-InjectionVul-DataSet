From d9c703f40692998efe918a375bf40078e1198a80 Mon Sep 17 00:00:00 2001
From: romain <rtribotte@users.noreply.github.com>
Date: Tue, 15 Apr 2025 10:46:55 +0200
Subject: [PATCH] review

---
 pkg/server/server_entrypoint_tcp.go      | 15 +++++----------
 pkg/server/server_entrypoint_tcp_test.go |  5 +++++
 2 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/pkg/server/server_entrypoint_tcp.go b/pkg/server/server_entrypoint_tcp.go
index 462655dd56..7e785a7f96 100644
--- a/pkg/server/server_entrypoint_tcp.go
+++ b/pkg/server/server_entrypoint_tcp.go
@@ -765,32 +765,27 @@ func removeDotDotSegments(path string) string {
 	}
 
 	var stack []string
-
 	for _, seg := range strings.Split(path, "/") {
 		if seg == ".." {
-			// Remove the last valid segment if possible
+			// Remove the last valid segment if possible.
 			if len(stack) > 0 {
 				stack = stack[:len(stack)-1]
 			}
 			continue
 		}
 
-		// Keep everything else (including empty strings)
+		// Keep everything else (including empty strings).
 		stack = append(stack, seg)
 	}
 
-	// Reassemble the path with original slash pattern
+	// Reassemble the path with original slash pattern.
 	cleanPath := strings.Join(stack, "/")
 
-	// Ensure the path starts with a slash.
+	// Ensure the path starts with a slash,
+	// in case a dotdot segment removed it.
 	if cleanPath[0] != '/' {
 		cleanPath = "/" + cleanPath
 	}
 
-	// Ensure the path ends with a slash if the original path did.
-	if path[len(path)-1] == '/' && cleanPath[len(cleanPath)-1] != '/' {
-		cleanPath = cleanPath + "/"
-	}
-
 	return cleanPath
 }
diff --git a/pkg/server/server_entrypoint_tcp_test.go b/pkg/server/server_entrypoint_tcp_test.go
index f4008dc7c6..98219e8e5b 100644
--- a/pkg/server/server_entrypoint_tcp_test.go
+++ b/pkg/server/server_entrypoint_tcp_test.go
@@ -389,7 +389,12 @@ func TestCleanDotDotSegments(t *testing.T) {
 		path     string
 		expected string
 	}{
+		{path: "/b", expected: "/b"},
+		{path: "/b/", expected: "/b/"},
+		{path: "/../../b/", expected: "/b/"},
 		{path: "/../../b", expected: "/b"},
+		{path: "/a/b/..", expected: "/a"},
+		{path: "/a/b/../", expected: "/a/"},
 		{path: "/a/../../b", expected: "/b"},
 		{path: "/..///b///", expected: "//b///"},
 		{path: "/a/../b", expected: "/b"},
