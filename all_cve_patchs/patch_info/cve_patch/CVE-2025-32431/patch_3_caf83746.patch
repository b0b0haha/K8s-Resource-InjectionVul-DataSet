From caf83746bc7c22c04dab6603c9315de12fb265a8 Mon Sep 17 00:00:00 2001
From: romain <rtribotte@users.noreply.github.com>
Date: Mon, 14 Apr 2025 11:51:26 +0200
Subject: [PATCH] review: use JoinPath

---
 pkg/server/server_entrypoint_tcp.go | 9 ++-------
 1 file changed, 2 insertions(+), 7 deletions(-)

diff --git a/pkg/server/server_entrypoint_tcp.go b/pkg/server/server_entrypoint_tcp.go
index d8807574b2..01ae62ebda 100644
--- a/pkg/server/server_entrypoint_tcp.go
+++ b/pkg/server/server_entrypoint_tcp.go
@@ -10,7 +10,6 @@ import (
 	"net/http"
 	"net/url"
 	"os"
-	"path"
 	"strings"
 	"sync"
 	"syscall"
@@ -725,13 +724,9 @@ func cleanPath(h http.Handler) http.Handler {
 	return http.HandlerFunc(func(rw http.ResponseWriter, req *http.Request) {
 		r2 := new(http.Request)
 		*r2 = *req
-		r2.URL = new(url.URL)
-		*r2.URL = *req.URL
 
-		r2.URL.Path = path.Clean(req.URL.Path)
-		if r2.URL.Path != req.URL.Path && req.URL.RawPath != "" {
-			r2.URL.RawPath = url.PathEscape(r2.URL.Path)
-		}
+		// JoinPath cleans the URL path and rawPath, using the escaped version if needed.
+		r2.URL = req.URL.JoinPath()
 		// Because the reverse proxy director is building query params from requestURI it needs to be updated as well.
 		r2.RequestURI = r2.URL.RequestURI()
 
