From 9ee74e9532c4e3bf5d2ebcec08d5ba043d0cdd95 Mon Sep 17 00:00:00 2001
From: romain <rtribotte@users.noreply.github.com>
Date: Tue, 15 Apr 2025 11:17:43 +0200
Subject: [PATCH] review: circle back to url.JoinPath clean method

---
 docs/content/migration/v2.md             |  2 +-
 integration/https_test.go                | 15 ------
 pkg/server/server_entrypoint_tcp.go      | 67 +++---------------------
 pkg/server/server_entrypoint_tcp_test.go | 12 ++---
 4 files changed, 13 insertions(+), 83 deletions(-)

diff --git a/docs/content/migration/v2.md b/docs/content/migration/v2.md
index 86ba3f92fc..c9e6a939ed 100644
--- a/docs/content/migration/v2.md
+++ b/docs/content/migration/v2.md
@@ -660,4 +660,4 @@ Please refer to the Forwarded headers [documentation](../routing/entrypoints.md#
 ## v2.11.23
 
 In `v2.11.23`, the incoming request path is now cleaned before being used to match the router rules and sent to the backends.
-Any `/../` sequence is interpreted and removed from the path.
+Any `/../`, `/./` or duplicate slash segments in the request path is interpreted and/or collapsed.
diff --git a/integration/https_test.go b/integration/https_test.go
index 87a05480cb..9ced3ffb9d 100644
--- a/integration/https_test.go
+++ b/integration/https_test.go
@@ -937,11 +937,6 @@ func (s *HTTPSSuite) TestEntryPointHttpsRedirectAndPathModification() {
 			hosts: []string{"example.com", "example2.com", "foo.com", "foo2.com", "bar.com", "bar2.com"},
 			path:  "/api/",
 		},
-		{
-			desc:  "Stripped URL with double trailing slash redirect",
-			hosts: []string{"example.com", "example2.com", "foo.com", "foo2.com", "bar.com", "bar2.com"},
-			path:  "/api//",
-		},
 		{
 			desc:  "Stripped URL with path redirect",
 			hosts: []string{"example.com", "example2.com", "foo.com", "foo2.com", "bar.com", "bar2.com"},
@@ -952,21 +947,11 @@ func (s *HTTPSSuite) TestEntryPointHttpsRedirectAndPathModification() {
 			hosts: []string{"example.com", "example2.com", "foo.com", "foo2.com", "bar.com", "bar2.com"},
 			path:  "/api/bacon/",
 		},
-		{
-			desc:  "Stripped URL with path and double trailing slash redirect",
-			hosts: []string{"example.com", "example2.com", "foo.com", "foo2.com", "bar.com", "bar2.com"},
-			path:  "/api/bacon//",
-		},
 		{
 			desc:  "Root Path with redirect",
 			hosts: []string{"test.com", "test2.com", "pow.com", "pow2.com"},
 			path:  "/",
 		},
-		{
-			desc:  "Root Path with double trailing slash redirect",
-			hosts: []string{"test.com", "test2.com", "pow.com", "pow2.com"},
-			path:  "//",
-		},
 		{
 			desc:  "Path modify with redirect",
 			hosts: []string{"test.com", "test2.com", "pow.com", "pow2.com"},
diff --git a/pkg/server/server_entrypoint_tcp.go b/pkg/server/server_entrypoint_tcp.go
index 7e785a7f96..8e400c5f4e 100644
--- a/pkg/server/server_entrypoint_tcp.go
+++ b/pkg/server/server_entrypoint_tcp.go
@@ -572,9 +572,9 @@ func createHTTPServer(ctx context.Context, ln net.Listener, configuration *stati
 	}
 
 	handler = denyFragment(handler)
-	// cleanDotDotSegments is used to clean the URL path by removing /../ sequences,
+	// cleanPath is used to clean the URL path by removing /../, /./ and duplicate slash sequences,
 	// to make sure the path is interpreted by the backends as it is evaluated inside rule matchers.
-	handler = cleanDotDotSegments(handler)
+	handler = cleanPath(handler)
 
 	if configuration.HTTP.EncodeQuerySemicolons {
 		handler = encodeQuerySemicolons(handler)
@@ -718,33 +718,15 @@ func denyFragment(h http.Handler) http.Handler {
 	})
 }
 
-// cleanDotDotSegments removes the ".." segments from the URL path.
+// cleanPath removes the "..", "." and duplicate slash segments from the URL.
 // It cleans the request URL Path and RawPath, and updates the request URI.
-func cleanDotDotSegments(h http.Handler) http.Handler {
+func cleanPath(h http.Handler) http.Handler {
 	return http.HandlerFunc(func(rw http.ResponseWriter, req *http.Request) {
 		r2 := new(http.Request)
 		*r2 = *req
-		r2.URL = new(url.URL)
-		*r2.URL = *req.URL
 
-		escapedPath := removeDotDotSegments(r2.URL.EscapedPath())
-
-		// Set the cleaned path to the URL.
-		// This behaves like url.setPath.
-		var err error
-		r2.URL.Path, err = url.PathUnescape(escapedPath)
-		// This error is not expected to happen, but if it does, we log it and return a 500 error.
-		if err != nil {
-			log.WithoutContext().WithError(err).Error("Cleaning dotdot segments: unescape path")
-			rw.WriteHeader(http.StatusInternalServerError)
-			return
-		}
-
-		if r2.URL.Path != escapedPath {
-			r2.URL.RawPath = escapedPath
-		} else {
-			r2.URL.RawPath = ""
-		}
+		// Cleans the URL raw path and path.
+		r2.URL = r2.URL.JoinPath()
 
 		// Because the reverse proxy director is building query params from requestURI it needs to be updated as well.
 		r2.RequestURI = r2.URL.RequestURI()
@@ -752,40 +734,3 @@ func cleanDotDotSegments(h http.Handler) http.Handler {
 		h.ServeHTTP(rw, r2)
 	})
 }
-
-// removeDotDotSegments removes ".." segments from the given path, preserving other parts like double slashes.
-func removeDotDotSegments(path string) string {
-	if path == "" {
-		return ""
-	}
-
-	// Ensure the path starts with a slash.
-	if path[0] != '/' {
-		path = "/" + path
-	}
-
-	var stack []string
-	for _, seg := range strings.Split(path, "/") {
-		if seg == ".." {
-			// Remove the last valid segment if possible.
-			if len(stack) > 0 {
-				stack = stack[:len(stack)-1]
-			}
-			continue
-		}
-
-		// Keep everything else (including empty strings).
-		stack = append(stack, seg)
-	}
-
-	// Reassemble the path with original slash pattern.
-	cleanPath := strings.Join(stack, "/")
-
-	// Ensure the path starts with a slash,
-	// in case a dotdot segment removed it.
-	if cleanPath[0] != '/' {
-		cleanPath = "/" + cleanPath
-	}
-
-	return cleanPath
-}
diff --git a/pkg/server/server_entrypoint_tcp_test.go b/pkg/server/server_entrypoint_tcp_test.go
index 98219e8e5b..f845479f04 100644
--- a/pkg/server/server_entrypoint_tcp_test.go
+++ b/pkg/server/server_entrypoint_tcp_test.go
@@ -384,7 +384,7 @@ func TestKeepAliveH2c(t *testing.T) {
 	require.Contains(t, err.Error(), "use of closed network connection")
 }
 
-func TestCleanDotDotSegments(t *testing.T) {
+func TestCleanPath(t *testing.T) {
 	tests := []struct {
 		path     string
 		expected string
@@ -396,15 +396,15 @@ func TestCleanDotDotSegments(t *testing.T) {
 		{path: "/a/b/..", expected: "/a"},
 		{path: "/a/b/../", expected: "/a/"},
 		{path: "/a/../../b", expected: "/b"},
-		{path: "/..///b///", expected: "//b///"},
+		{path: "/..///b///", expected: "/b/"},
 		{path: "/a/../b", expected: "/b"},
-		{path: "/a/./b", expected: "/a/./b"},
-		{path: "/a//b", expected: "/a//b"},
+		{path: "/a/./b", expected: "/a/b"},
+		{path: "/a//b", expected: "/a/b"},
 		{path: "/a/../../b", expected: "/b"},
 		{path: "/a/../c/../b", expected: "/b"},
 		{path: "/a/../../../c/../b", expected: "/b"},
 		{path: "/a/../c/../../b", expected: "/b"},
-		{path: "/a/..//c/.././b", expected: "//./b"},
+		{path: "/a/..//c/.././b", expected: "/b"},
 	}
 
 	for _, test := range tests {
@@ -412,7 +412,7 @@ func TestCleanDotDotSegments(t *testing.T) {
 			t.Parallel()
 
 			var callCount int
-			clean := cleanDotDotSegments(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
+			clean := cleanPath(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
 				callCount++
 				assert.Equal(t, test.expected, r.URL.Path)
 			}))
