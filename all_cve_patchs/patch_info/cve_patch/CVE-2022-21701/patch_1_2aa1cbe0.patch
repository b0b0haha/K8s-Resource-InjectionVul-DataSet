From 2aa1cbe02c968483f7aa5a32c6f0c0efe484c425 Mon Sep 17 00:00:00 2001
From: John Howard <howardjohn@google.com>
Date: Fri, 19 Nov 2021 10:41:24 -0800
Subject: [PATCH] Improve validation for gateway types

---
 .../pkg/config/kube/gateway/deploymentcontroller.go  | 12 ++++++------
 pilot/pkg/config/kube/gateway/templates/service.yaml |  6 +++---
 2 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/pilot/pkg/config/kube/gateway/deploymentcontroller.go b/pilot/pkg/config/kube/gateway/deploymentcontroller.go
index f4e435c9ed3e..6e79c170e462 100644
--- a/pilot/pkg/config/kube/gateway/deploymentcontroller.go
+++ b/pilot/pkg/config/kube/gateway/deploymentcontroller.go
@@ -184,13 +184,13 @@ func (d *DeploymentController) configureIstioGateway(log *istiolog.Scope, gw gat
 	}
 	log.Info("reconciling")
 
-	svc := serviceInput{Gateway: gw, Ports: extractServicePorts(gw)}
+	svc := serviceInput{Gateway: &gw, Ports: extractServicePorts(gw)}
 	if err := d.ApplyTemplate("service.yaml", svc); err != nil {
 		return fmt.Errorf("update service: %v", err)
 	}
 	log.Info("service updated")
 
-	dep := deploymentInput{Gateway: gw, KubeVersion122: kube.IsAtLeastVersion(d.client, 22)}
+	dep := deploymentInput{Gateway: &gw, KubeVersion122: kube.IsAtLeastVersion(d.client, 22)}
 	if err := d.ApplyTemplate("deployment.yaml", dep); err != nil {
 		return fmt.Errorf("update deployment: %v", err)
 	}
@@ -222,7 +222,7 @@ func (d *DeploymentController) configureIstioGateway(log *istiolog.Scope, gw gat
 }
 
 // ApplyTemplate renders a template with the given input and (server-side) applies the results to the cluster.
-func (d *DeploymentController) ApplyTemplate(template string, input interface{}, subresources ...string) error {
+func (d *DeploymentController) ApplyTemplate(template string, input metav1.Object, subresources ...string) error {
 	var buf bytes.Buffer
 	if err := d.templates.ExecuteTemplate(&buf, template, input); err != nil {
 		return err
@@ -243,7 +243,7 @@ func (d *DeploymentController) ApplyTemplate(template string, input interface{},
 	}
 
 	log.Debugf("applying %v", string(j))
-	return d.patcher(gvr, us.GetName(), us.GetNamespace(), j, subresources...)
+	return d.patcher(gvr, us.GetName(), input.GetNamespace(), j, subresources...)
 }
 
 // ApplyObject renders an object with the given input and (server-side) applies the results to the cluster.
@@ -277,12 +277,12 @@ func mergeMaps(maps ...map[string]string) map[string]string {
 }
 
 type serviceInput struct {
-	gateway.Gateway
+	*gateway.Gateway
 	Ports []corev1.ServicePort
 }
 
 type deploymentInput struct {
-	gateway.Gateway
+	*gateway.Gateway
 	KubeVersion122 bool
 }
 
diff --git a/pilot/pkg/config/kube/gateway/templates/service.yaml b/pilot/pkg/config/kube/gateway/templates/service.yaml
index 0988994d2043..31581c6dbcc1 100644
--- a/pilot/pkg/config/kube/gateway/templates/service.yaml
+++ b/pilot/pkg/config/kube/gateway/templates/service.yaml
@@ -17,14 +17,14 @@ metadata:
 spec:
   ports:
   {{- range $key, $val := .Ports }}
-  - name: {{ $val.Name }}
+  - name: {{ $val.Name | quote }}
     port: {{ $val.Port }}
     protocol: TCP
   {{- end }}
   selector:
     istio.io/gateway-name: {{.Name}}
   {{- if .Spec.Addresses }}
-  loadBalancerIP: {{ (index .Spec.Addresses 0).Value}}
+  loadBalancerIP: {{ (index .Spec.Addresses 0).Value | quote}}
   {{- end }}
-  type: {{ index .Annotations "networking.istio.io/service-type" | default "LoadBalancer" }}
+  type: {{ index .Annotations "networking.istio.io/service-type" | default "LoadBalancer" | quote }}
 
