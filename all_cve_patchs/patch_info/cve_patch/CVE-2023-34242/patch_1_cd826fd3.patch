From cd826fd3a275ca4841bf8e62f37da9931980cd28 Mon Sep 17 00:00:00 2001
From: Maartje Eyskens <maartje.eyskens@isovalent.com>
Date: Tue, 30 May 2023 13:59:23 +0200
Subject: [PATCH] Fix checking of reference grants for gateway secrets

This fixes the namespace check for TLS secret references in the Gateway
API. This adds the correct check to the status function as well as the
ingestion logic.

Signed-off-by: Maartje Eyskens <maartje.eyskens@isovalent.com>
---
 operator/pkg/gateway-api/gateway_reconcile.go | 13 ++++++------
 .../gateway-api/helpers/referencegrants.go    | 21 ++++++++++++-------
 .../pkg/gateway-api/httproute_reconcile.go    |  3 ++-
 operator/pkg/model/ingestion/gateway.go       |  8 +++++--
 4 files changed, 29 insertions(+), 16 deletions(-)

diff --git a/operator/pkg/gateway-api/gateway_reconcile.go b/operator/pkg/gateway-api/gateway_reconcile.go
index a88f607767440..18d37f1b8ba60 100644
--- a/operator/pkg/gateway-api/gateway_reconcile.go
+++ b/operator/pkg/gateway-api/gateway_reconcile.go
@@ -18,6 +18,7 @@ import (
 	gatewayv1alpha2 "sigs.k8s.io/gateway-api/apis/v1alpha2"
 	gatewayv1beta1 "sigs.k8s.io/gateway-api/apis/v1beta1"
 
+	"github.com/cilium/cilium/operator/pkg/gateway-api/helpers"
 	"github.com/cilium/cilium/operator/pkg/model"
 	"github.com/cilium/cilium/operator/pkg/model/ingestion"
 	translation "github.com/cilium/cilium/operator/pkg/model/translation/gateway-api"
@@ -275,6 +276,11 @@ func (r *gatewayReconciler) setAddressStatus(ctx context.Context, gw *gatewayv1b
 }
 
 func (r *gatewayReconciler) setListenerStatus(ctx context.Context, gw *gatewayv1beta1.Gateway) error {
+	grants := &gatewayv1alpha2.ReferenceGrantList{}
+	if err := r.Client.List(ctx, grants); err != nil {
+		return fmt.Errorf("failed to retrieve reference grants: %w", err)
+	}
+
 	for _, l := range gw.Spec.Listeners {
 		cond := gatewayListenerReadyCondition(gw, true, "Listener Ready")
 		if l.TLS != nil {
@@ -283,12 +289,7 @@ func (r *gatewayReconciler) setListenerStatus(ctx context.Context, gw *gatewayv1
 					continue
 				}
 
-				allowed, err := isReferenceAllowed(ctx, r.Client, gw, cert)
-				if err != nil {
-					return err
-				}
-
-				if !allowed {
+				if !helpers.IsSecretReferenceAllowed(gw.Namespace, cert, gatewayv1beta1.SchemeGroupVersion.WithKind("Gateway"), grants.Items) {
 					cond = metav1.Condition{
 						Type:               string(gatewayv1beta1.ListenerConditionResolvedRefs),
 						Status:             metav1.ConditionFalse,
diff --git a/operator/pkg/gateway-api/helpers/referencegrants.go b/operator/pkg/gateway-api/helpers/referencegrants.go
index c3b5195f67d26..c6101c0eecadc 100644
--- a/operator/pkg/gateway-api/helpers/referencegrants.go
+++ b/operator/pkg/gateway-api/helpers/referencegrants.go
@@ -10,11 +10,18 @@ import (
 	gatewayv1beta1 "sigs.k8s.io/gateway-api/apis/v1beta1"
 )
 
-// isReferenceAllowed returns true if the reference is allowed by the reference grant.
-// TODO(tam): only HTTP and TLS with Service is supported right now.
-// We need to support other routes (e.g. grpc, etc.) later.
+// IsBackendReferenceAllowed returns true if the backend reference is allowed by the reference grant.
 func IsBackendReferenceAllowed(originatingNamespace string, be gatewayv1beta1.BackendRef, gvk schema.GroupVersionKind, grants []gatewayv1alpha2.ReferenceGrant) bool {
-	ns := NamespaceDerefOr(be.Namespace, originatingNamespace)
+	return isReferenceAllowed(originatingNamespace, string(be.Name), be.Namespace, gvk, corev1.SchemeGroupVersion.WithKind("Service"), grants)
+}
+
+// IsSecretReferenceAllowed returns true if the secret reference is allowed by the reference grant.
+func IsSecretReferenceAllowed(originatingNamespace string, sr gatewayv1beta1.SecretObjectReference, gvk schema.GroupVersionKind, grants []gatewayv1alpha2.ReferenceGrant) bool {
+	return isReferenceAllowed(originatingNamespace, string(sr.Name), sr.Namespace, gvk, corev1.SchemeGroupVersion.WithKind("Secret"), grants)
+}
+
+func isReferenceAllowed(originatingNamespace, name string, namespace *gatewayv1beta1.Namespace, fromGVK, toGVK schema.GroupVersionKind, grants []gatewayv1alpha2.ReferenceGrant) bool {
+	ns := NamespaceDerefOr(namespace, originatingNamespace)
 	if originatingNamespace == ns {
 		return true // same namespace is always allowed
 	}
@@ -24,11 +31,11 @@ func IsBackendReferenceAllowed(originatingNamespace string, be gatewayv1beta1.Ba
 			continue
 		}
 		for _, from := range g.Spec.From {
-			if (from.Group == gatewayv1alpha2.Group(gvk.Group) && from.Kind == gatewayv1alpha2.Kind(gvk.Kind)) &&
+			if (from.Group == gatewayv1alpha2.Group(fromGVK.Group) && from.Kind == gatewayv1alpha2.Kind(fromGVK.Kind)) &&
 				(string)(from.Namespace) == originatingNamespace {
 				for _, to := range g.Spec.To {
-					if to.Group == corev1.GroupName && to.Kind == "Service" &&
-						(to.Name == nil || string(*to.Name) == string(be.Name)) {
+					if to.Group == gatewayv1alpha2.Group(toGVK.Group) && to.Kind == gatewayv1alpha2.Kind(toGVK.Kind) &&
+						(to.Name == nil || string(*to.Name) == name) {
 						return true
 					}
 				}
diff --git a/operator/pkg/gateway-api/httproute_reconcile.go b/operator/pkg/gateway-api/httproute_reconcile.go
index bbdccf92b916e..aa238e7c864de 100644
--- a/operator/pkg/gateway-api/httproute_reconcile.go
+++ b/operator/pkg/gateway-api/httproute_reconcile.go
@@ -5,6 +5,7 @@ package gateway_api
 
 import (
 	"context"
+	"fmt"
 
 	"github.com/google/go-cmp/cmp"
 	"github.com/google/go-cmp/cmp/cmpopts"
@@ -59,7 +60,7 @@ func (r *httpRouteReconciler) Reconcile(ctx context.Context, req ctrl.Request) (
 	// check if this cert is allowed to be used by this gateway
 	grants := &gatewayv1alpha2.ReferenceGrantList{}
 	if err := r.Client.List(ctx, grants); err != nil {
-		return fail(err)
+		return fail(fmt.Errorf("failed to retrieve reference grants: %w", err))
 	}
 
 	for _, fn := range []httpRouteChecker{
diff --git a/operator/pkg/model/ingestion/gateway.go b/operator/pkg/model/ingestion/gateway.go
index c129723662c4b..1e0d6eb4b0bd9 100644
--- a/operator/pkg/model/ingestion/gateway.go
+++ b/operator/pkg/model/ingestion/gateway.go
@@ -123,7 +123,7 @@ func GatewayAPI(input Input) []model.HTTPListener {
 			},
 			Port:     uint32(l.Port),
 			Hostname: toHostname(l.Hostname),
-			TLS:      toTLS(l.TLS, input.Gateway.GetNamespace()),
+			TLS:      toTLS(l.TLS, input.ReferenceGrants, input.Gateway.GetNamespace()),
 			Routes:   routes,
 		})
 	}
@@ -272,13 +272,17 @@ func toQueryMatch(match gatewayv1beta1.HTTPRouteMatch) []model.KeyValueMatch {
 	return res
 }
 
-func toTLS(tls *gatewayv1beta1.GatewayTLSConfig, defaultNamespace string) []model.TLSSecret {
+func toTLS(tls *gatewayv1beta1.GatewayTLSConfig, grants []gatewayv1alpha2.ReferenceGrant, defaultNamespace string) []model.TLSSecret {
 	if tls == nil {
 		return nil
 	}
 
 	res := make([]model.TLSSecret, 0, len(tls.CertificateRefs))
 	for _, cert := range tls.CertificateRefs {
+		if !helpers.IsSecretReferenceAllowed(defaultNamespace, cert, gatewayv1beta1.SchemeGroupVersion.WithKind("Gateway"), grants) {
+			// not allowed to be referred to, skipping
+			continue
+		}
 		res = append(res, model.TLSSecret{
 			Name:      string(cert.Name),
 			Namespace: namespaceDerefOr(cert.Namespace, defaultNamespace),
