From d75a0539046877443b0be5f625854dc01eadf78a Mon Sep 17 00:00:00 2001
From: Tom Proctor <tomhjp@users.noreply.github.com>
Date: Fri, 6 Nov 2020 16:55:48 +0000
Subject: [PATCH] Add os.MkdirAll call when required

---
 provider.go      | 16 +++++++++++-----
 provider_test.go |  4 ++--
 2 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/provider.go b/provider.go
index fc1b2e3..4741f50 100644
--- a/provider.go
+++ b/provider.go
@@ -10,7 +10,6 @@ import (
 	"io/ioutil"
 	"net/http"
 	"os"
-	"path"
 	"path/filepath"
 	"regexp"
 	"strconv"
@@ -449,13 +448,20 @@ func (p *Provider) MountSecretsStoreObjectContent(ctx context.Context, attrib ma
 			return err
 		}
 		objectContent := []byte(content)
-		if err := validateFilePath(keyValueObject.ObjectName); err != nil {
+		path := keyValueObject.ObjectName
+		if err := validateFilePath(path); err != nil {
 			return err
 		}
-		if err := ioutil.WriteFile(path.Join(targetPath, keyValueObject.ObjectName), objectContent, permission); err != nil {
-			return errors.Wrapf(err, "secrets-store csi driver failed to write %s at %s", keyValueObject.ObjectName, targetPath)
+		if filepath.Base(path) != path {
+			err = os.MkdirAll(filepath.Join(targetPath, filepath.Dir(path)), 0755)
+			if err != nil {
+				return err
+			}
+		}
+		if err := ioutil.WriteFile(filepath.Join(targetPath, path), objectContent, permission); err != nil {
+			return errors.Wrapf(err, "secrets-store csi driver failed to write %s at %s", path, targetPath)
 		}
-		log.Infof("secrets-store csi driver wrote %s at %s", keyValueObject.ObjectName, targetPath)
+		log.Infof("secrets-store csi driver wrote %s at %s", path, targetPath)
 	}
 
 	return nil
diff --git a/provider_test.go b/provider_test.go
index bee5c4c..2ba6320 100644
--- a/provider_test.go
+++ b/provider_test.go
@@ -8,7 +8,7 @@ import (
 func TestValidateFilePath(t *testing.T) {
 	// Don't use filepath.Join to generate the test cases because it calls filepath.Clean
 	// which simplifies some of the test cases into less interesting paths.
-	for _, tc := range []string {
+	for _, tc := range []string{
 		"",
 		".",
 		"/",
@@ -44,4 +44,4 @@ func TestValidatePath_Malformed(t *testing.T) {
 			t.Fatalf("Expected error for %q but got none", tc)
 		}
 	}
-}
\ No newline at end of file
+}
