From 0e83a68159111e4ee510f5aa56d47ba97bda60c7 Mon Sep 17 00:00:00 2001
From: James Sturtevant <jstur@microsoft.com>
Date: Thu, 3 Aug 2023 08:45:47 -0700
Subject: [PATCH] When using Powershell all strings must be passed as env vars

Signed-off-by: James Sturtevant <jstur@microsoft.com>
Co-authored-by: Mark Rossetti <marosset@microsoft.com>
---
 pkg/os/volume/api.go | 73 ++++++++++++++++++++++++++++----------------
 1 file changed, 47 insertions(+), 26 deletions(-)

diff --git a/pkg/os/volume/api.go b/pkg/os/volume/api.go
index ee59f8d4..a3b7a550 100644
--- a/pkg/os/volume/api.go
+++ b/pkg/os/volume/api.go
@@ -62,8 +62,9 @@ func New() VolumeAPI {
 }
 
 func getVolumeSize(volumeID string) (int64, error) {
-	cmd := fmt.Sprintf("(Get-Volume -UniqueId \"%s\" | Get-partition).Size", volumeID)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Volume -UniqueId "$Env:volumeID" | Get-partition).Size`
+	cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 
 	if err != nil || len(out) == 0 {
 		return -1, fmt.Errorf("error getting size of the partition from mount. cmd %s, output: %s, error: %v", cmd, string(out), err)
@@ -98,8 +99,9 @@ func (VolumeAPI) ListVolumesOnDisk(diskNumber uint32, partitionNumber uint32) (v
 
 // FormatVolume - Formats a volume with the NTFS format.
 func (VolumeAPI) FormatVolume(volumeID string) (err error) {
-	cmd := fmt.Sprintf("Get-Volume -UniqueId \"%s\" | Format-Volume -FileSystem ntfs -Confirm:$false", volumeID)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `Get-Volume -UniqueId "$Env:volumeID" | Format-Volume -FileSystem ntfs -Confirm:$false`
+	cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 	if err != nil {
 		return fmt.Errorf("error formatting volume. cmd: %s, output: %s, error: %v", cmd, string(out), err)
 	}
@@ -114,8 +116,9 @@ func (VolumeAPI) WriteVolumeCache(volumeID string) (err error) {
 
 // IsVolumeFormatted - Check if the volume is formatted with the pre specified filesystem(typically ntfs).
 func (VolumeAPI) IsVolumeFormatted(volumeID string) (bool, error) {
-	cmd := fmt.Sprintf("(Get-Volume -UniqueId \"%s\" -ErrorAction Stop).FileSystemType", volumeID)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Volume -UniqueId "$Env:volumeID" -ErrorAction Stop).FileSystemType`
+	cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 	if err != nil {
 		return false, fmt.Errorf("error checking if volume is formatted. cmd: %s, output: %s, error: %v", cmd, string(out), err)
 	}
@@ -128,8 +131,12 @@ func (VolumeAPI) IsVolumeFormatted(volumeID string) (bool, error) {
 
 // MountVolume - mounts a volume to a path. This is done using the Add-PartitionAccessPath for presenting the volume via a path.
 func (VolumeAPI) MountVolume(volumeID, path string) error {
-	cmd := fmt.Sprintf("Get-Volume -UniqueId \"%s\" | Get-Partition | Add-PartitionAccessPath -AccessPath %s", volumeID, path)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `Get-Volume -UniqueId "$Env:volumeID" | Get-Partition | Add-PartitionAccessPath -AccessPath $Env:mountpath`
+	cmdEnv := []string{}
+	cmdEnv = append(cmdEnv, fmt.Sprintf("volumeID=%s", volumeID))
+	cmdEnv = append(cmdEnv, fmt.Sprintf("mountpath=%s", path))
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv...)
+
 	if err != nil {
 		return fmt.Errorf("error mount volume to path. cmd: %s, output: %s, error: %v", cmd, string(out), err)
 	}
@@ -141,8 +148,13 @@ func (VolumeAPI) UnmountVolume(volumeID, path string) error {
 	if err := writeCache(volumeID); err != nil {
 		return err
 	}
-	cmd := fmt.Sprintf("Get-Volume -UniqueId \"%s\" | Get-Partition | Remove-PartitionAccessPath -AccessPath %s", volumeID, path)
-	out, err := utils.RunPowershellCmd(cmd)
+
+	cmd := `Get-Volume -UniqueId "$Env:volumeID" | Get-Partition | Remove-PartitionAccessPath -AccessPath $Env:mountpath`
+	cmdEnv := []string{}
+	cmdEnv = append(cmdEnv, fmt.Sprintf("volumeID=%s", volumeID))
+	cmdEnv = append(cmdEnv, fmt.Sprintf("mountpath=%s", path))
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv...)
+
 	if err != nil {
 		return fmt.Errorf("error getting driver letter to mount volume. cmd: %s, output: %s,error: %v", cmd, string(out), err)
 	}
@@ -158,8 +170,9 @@ func (VolumeAPI) ResizeVolume(volumeID string, size int64) error {
 	var finalSize int64
 	var outString string
 	if size == 0 {
-		cmd = fmt.Sprintf("Get-Volume -UniqueId \"%s\" | Get-partition | Get-PartitionSupportedSize | Select SizeMax | ConvertTo-Json", volumeID)
-		out, err := utils.RunPowershellCmd(cmd)
+		cmd = `Get-Volume -UniqueId "$Env:volumeID" | Get-partition | Get-PartitionSupportedSize | Select SizeMax | ConvertTo-Json`
+		cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+		out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 
 		if err != nil || len(out) == 0 {
 			return fmt.Errorf("error getting sizemin,sizemax from mount. cmd: %s, output: %s, error: %v", cmd, string(out), err)
@@ -190,8 +203,10 @@ func (VolumeAPI) ResizeVolume(volumeID string, size int64) error {
 		return nil
 	}
 
-	cmd = fmt.Sprintf("Get-Volume -UniqueId \"%s\" | Get-Partition | Resize-Partition -Size %d", volumeID, finalSize)
-	out, err = utils.RunPowershellCmd(cmd)
+	cmd = fmt.Sprintf(`Get-Volume -UniqueId "$Env:volumeID" | Get-Partition | Resize-Partition -Size %d`, finalSize)
+	cmdEnv := []string{}
+	cmdEnv = append(cmdEnv, fmt.Sprintf("volumeID=%s", volumeID))
+	out, err = utils.RunPowershellCmd(cmd, cmdEnv...)
 	if err != nil {
 		return fmt.Errorf("error resizing volume. cmd: %s, output: %s size:%v, finalSize %v, error: %v", cmd, string(out), size, finalSize, err)
 	}
@@ -201,8 +216,9 @@ func (VolumeAPI) ResizeVolume(volumeID string, size int64) error {
 // GetVolumeStats - retrieves the volume stats for a given volume
 func (VolumeAPI) GetVolumeStats(volumeID string) (int64, int64, error) {
 	// get the size and sizeRemaining for the volume
-	cmd := fmt.Sprintf("(Get-Volume -UniqueId \"%s\" | Select SizeRemaining,Size) | ConvertTo-Json", volumeID)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Volume -UniqueId "$Env:volumeID" | Select SizeRemaining,Size) | ConvertTo-Json`
+	cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 
 	if err != nil {
 		return -1, -1, fmt.Errorf("error getting capacity and used size of volume. cmd: %s, output: %s, error: %v", cmd, string(out), err)
@@ -227,8 +243,9 @@ func (VolumeAPI) GetVolumeStats(volumeID string) (int64, int64, error) {
 // GetDiskNumberFromVolumeID - gets the disk number where the volume is.
 func (VolumeAPI) GetDiskNumberFromVolumeID(volumeID string) (uint32, error) {
 	// get the size and sizeRemaining for the volume
-	cmd := fmt.Sprintf("(Get-Volume -UniqueId \"%s\" | Get-Partition).DiskNumber", volumeID)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Volume -UniqueId "$Env:volumeID" | Get-Partition).DiskNumber`
+	cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 
 	if err != nil || len(out) == 0 {
 		return 0, fmt.Errorf("error getting disk number. cmd: %s, output: %s, error: %v", cmd, string(out), err)
@@ -261,8 +278,9 @@ func (VolumeAPI) GetVolumeIDFromTargetPath(mount string) (string, error) {
 }
 
 func getTarget(mount string) (string, error) {
-	cmd := fmt.Sprintf("(Get-Item -Path %s).Target", mount)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Item -Path $Env:mountpath).Target`
+	cmdEnv := fmt.Sprintf("mountpath=%s", mount)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 	if err != nil || len(out) == 0 {
 		return "", fmt.Errorf("error getting volume from mount. cmd: %s, output: %s, error: %v", cmd, string(out), err)
 	}
@@ -352,8 +370,9 @@ func ensureVolumePrefix(volume string) string {
 
 // dereferenceSymlink dereferences the symlink `path` and returns the stdout.
 func dereferenceSymlink(path string) (string, error) {
-	cmd := fmt.Sprintf(`(Get-Item -Path %s).Target`, path)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Item -Path $Env:linkpath).Target`
+	cmdEnv := fmt.Sprintf("linkpath=%s", path)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 	if err != nil {
 		return "", err
 	}
@@ -368,8 +387,9 @@ func getVolumeForDriveLetter(path string) (string, error) {
 		return "", fmt.Errorf("The path=%s is not a valid DriverLetter", path)
 	}
 
-	cmd := fmt.Sprintf(`(Get-Partition -DriveLetter %s | Get-Volume).UniqueId`, path)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `(Get-Partition -DriveLetter $Env:drivepath | Get-Volume).UniqueId`
+	cmdEnv := fmt.Sprintf("drivepath=%s", path)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 	if err != nil {
 		return "", err
 	}
@@ -379,8 +399,9 @@ func getVolumeForDriveLetter(path string) (string, error) {
 }
 
 func writeCache(volumeID string) error {
-	cmd := fmt.Sprintf("Get-Volume -UniqueId \"%s\" | Write-Volumecache", volumeID)
-	out, err := utils.RunPowershellCmd(cmd)
+	cmd := `Get-Volume -UniqueId "$Env:volumeID" | Write-Volumecache`
+	cmdEnv := fmt.Sprintf("volumeID=%s", volumeID)
+	out, err := utils.RunPowershellCmd(cmd, cmdEnv)
 	if err != nil {
 		return fmt.Errorf("error writing volume cache. cmd: %s, output: %s, error: %v", cmd, string(out), err)
 	}
