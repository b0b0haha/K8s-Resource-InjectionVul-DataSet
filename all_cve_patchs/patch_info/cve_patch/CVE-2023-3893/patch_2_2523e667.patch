From 2523e6674dedf3de27f84235efec28555da24664 Mon Sep 17 00:00:00 2001
From: James Sturtevant <jstur@microsoft.com>
Date: Thu, 3 Aug 2023 08:46:46 -0700
Subject: [PATCH] Enable tests than can now run on GH actions

Signed-off-by: James Sturtevant <jstur@microsoft.com>
---
 .github/workflows/windows.yml          |  5 ++++-
 integrationtests/disk_v1_test.go       |  4 ----
 integrationtests/disk_v1alpha1_test.go |  4 ----
 integrationtests/disk_v1beta1_test.go  |  4 ----
 integrationtests/disk_v1beta2_test.go  |  4 ----
 integrationtests/disk_v1beta3_test.go  |  4 ----
 integrationtests/volume_test.go        | 10 ++--------
 7 files changed, 6 insertions(+), 29 deletions(-)

diff --git a/.github/workflows/windows.yml b/.github/workflows/windows.yml
index c218ce7e..33214784 100644
--- a/.github/workflows/windows.yml
+++ b/.github/workflows/windows.yml
@@ -20,6 +20,9 @@ jobs:
           go build -v -a -o ./bin/csi-proxy-api-gen.exe ./cmd/csi-proxy-api-gen
       - name: Run Windows Integration Tests
         run: |
+          # required for running Volume and Disk tests
+          Install-WindowsFeature -name Hyper-V-PowerShell
+          
           # start the CSI Proxy before running tests on windows
           Start-Job -Name CSIProxy -ScriptBlock {
             .\bin\csi-proxy.exe
@@ -28,7 +31,7 @@ jobs:
           Write-Output "getting named pipes"
           [System.IO.Directory]::GetFiles("\\.\\pipe\\")
           $env:CSI_PROXY_GH_ACTIONS="TRUE"
-          go test -v -race ./integrationtests/...
+          go test -timeout 20m -v -race ./integrationtests/...
   unit_tests:
     strategy:
       matrix:
diff --git a/integrationtests/disk_v1_test.go b/integrationtests/disk_v1_test.go
index 28724c2f..7888216e 100644
--- a/integrationtests/disk_v1_test.go
+++ b/integrationtests/disk_v1_test.go
@@ -77,8 +77,6 @@ func v1DiskTests(t *testing.T) {
 	})
 
 	t.Run("Get/SetDiskState", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		client, err := diskv1client.NewClient()
 		require.NoError(t, err)
 
@@ -144,8 +142,6 @@ func v1DiskTests(t *testing.T) {
 	})
 
 	t.Run("PartitionDisk", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		var err error
 		client, err := diskv1client.NewClient()
 		require.NoError(t, err)
diff --git a/integrationtests/disk_v1alpha1_test.go b/integrationtests/disk_v1alpha1_test.go
index d251656d..60e38bd0 100644
--- a/integrationtests/disk_v1alpha1_test.go
+++ b/integrationtests/disk_v1alpha1_test.go
@@ -34,8 +34,6 @@ func v1alpha1DiskTests(t *testing.T) {
 	})
 
 	t.Run("Rescan", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		client, err := diskv1alpha1client.NewClient()
 		require.NoError(t, err)
 
@@ -47,8 +45,6 @@ func v1alpha1DiskTests(t *testing.T) {
 	})
 
 	t.Run("PartitionDisk", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		var err error
 		client, err := diskv1alpha1client.NewClient()
 		require.NoError(t, err)
diff --git a/integrationtests/disk_v1beta1_test.go b/integrationtests/disk_v1beta1_test.go
index d0b37dcc..422ef55d 100644
--- a/integrationtests/disk_v1beta1_test.go
+++ b/integrationtests/disk_v1beta1_test.go
@@ -57,8 +57,6 @@ func v1beta1DiskTests(t *testing.T) {
 	})
 
 	t.Run("Get/SetDiskState", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		client, err := diskv1beta1client.NewClient()
 		require.NoError(t, err)
 
@@ -86,8 +84,6 @@ func v1beta1DiskTests(t *testing.T) {
 	})
 
 	t.Run("PartitionDisk", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		var err error
 		client, err := diskv1beta1client.NewClient()
 		require.NoError(t, err)
diff --git a/integrationtests/disk_v1beta2_test.go b/integrationtests/disk_v1beta2_test.go
index 8c431b6a..1848b561 100644
--- a/integrationtests/disk_v1beta2_test.go
+++ b/integrationtests/disk_v1beta2_test.go
@@ -58,8 +58,6 @@ func v1beta2DiskTests(t *testing.T) {
 	})
 
 	t.Run("Get/SetDiskState", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		client, err := diskv1beta2client.NewClient()
 		require.NoError(t, err)
 
@@ -127,8 +125,6 @@ func v1beta2DiskTests(t *testing.T) {
 	})
 
 	t.Run("PartitionDisk", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		var err error
 		client, err := diskv1beta2client.NewClient()
 		require.NoError(t, err)
diff --git a/integrationtests/disk_v1beta3_test.go b/integrationtests/disk_v1beta3_test.go
index 57e7a262..6b1e9c8a 100644
--- a/integrationtests/disk_v1beta3_test.go
+++ b/integrationtests/disk_v1beta3_test.go
@@ -77,8 +77,6 @@ func v1beta3DiskTests(t *testing.T) {
 	})
 
 	t.Run("Get/SetDiskState", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		client, err := diskv1beta3client.NewClient()
 		require.NoError(t, err)
 
@@ -144,8 +142,6 @@ func v1beta3DiskTests(t *testing.T) {
 	})
 
 	t.Run("PartitionDisk", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
-
 		var err error
 		client, err := diskv1beta3client.NewClient()
 		require.NoError(t, err)
diff --git a/integrationtests/volume_test.go b/integrationtests/volume_test.go
index afd99b70..d03d00eb 100644
--- a/integrationtests/volume_test.go
+++ b/integrationtests/volume_test.go
@@ -148,32 +148,26 @@ func TestVolumeAPIs(t *testing.T) {
 		negativeVolumeTests(t)
 	})
 
-	// TODO: These tests will fail on Github Actions because Hyper-V is disabled
-	// see https://github.com/actions/virtual-environments/pull/2525
+	// Github Actions WS 2022 supports hyper-v
+	// must install management tools manually
 
 	// these tests should be considered frozen from the API point of view
 	t.Run("v1alpha1Tests", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
 		v1alpha1VolumeTests(t)
 	})
 	t.Run("v1beta1Tests", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
 		v1beta1VolumeTests(t)
 	})
 	t.Run("v1beta2Tests", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
 		v1beta2VolumeTests(t)
 	})
 	t.Run("v1beta3Tests", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
 		v1beta3VolumeTests(t)
 	})
 	t.Run("v1Tests", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
 		v1VolumeTests(t)
 	})
 	t.Run("v2alpha1Tests", func(t *testing.T) {
-		skipTestOnCondition(t, isRunningOnGhActions())
 		v2alpha1VolumeTests(t)
 	})
 }
