From 41dca27cb53bca3c9255287f53e241b9d3bfd7de Mon Sep 17 00:00:00 2001
From: Peter Hunt~ <pehunt@redhat.com>
Date: Wed, 14 Dec 2022 18:15:50 -0500
Subject: [PATCH] server: fail if HOME variable has a newline

to prevent CVE-2022-4318

Signed-off-by: Peter Hunt~ <pehunt@redhat.com>
---
 server/container_create.go | 3 +++
 test/ctr.bats              | 8 ++++++++
 2 files changed, 11 insertions(+)

diff --git a/server/container_create.go b/server/container_create.go
index 629618208bf..7f108c0b744 100644
--- a/server/container_create.go
+++ b/server/container_create.go
@@ -201,6 +201,9 @@ func setupContainerUser(ctx context.Context, specgen *generate.Generator, rootfs
 	for _, env := range specgen.Config.Process.Env {
 		if strings.HasPrefix(env, "HOME=") {
 			homedir = strings.TrimPrefix(env, "HOME=")
+			if idx := strings.Index(homedir, `\n`); idx > -1 {
+				return fmt.Errorf("invalid HOME environment; newline not allowed")
+			}
 			break
 		}
 	}
diff --git a/test/ctr.bats b/test/ctr.bats
index 29f63cf2077..c2208cdfe5e 100644
--- a/test/ctr.bats
+++ b/test/ctr.bats
@@ -1024,3 +1024,11 @@ function check_oci_annotation() {
 		! ps -p "$process" o pid=,stat= | grep -v 'Z'
 	done
 }
+
+@test "ctr HOME env newline invalid" {
+	start_crio
+	jq ' .envs = [{"key": "HOME=", "value": "/root:/sbin/nologin\\ntest::0:0::/:/bin/bash"}]' \
+		"$TESTDATA"/container_config.json > "$newconfig"
+
+	! crictl run "$newconfig" "$TESTDATA"/sandbox_config.json
+}
