From f1d58e60b1981cb7d4e6dcbf83e2a43d4ec3d7a7 Mon Sep 17 00:00:00 2001
From: Alex Collins <alex_collins@intuit.com>
Date: Wed, 22 Sep 2021 09:36:29 -0700
Subject: [PATCH] ok

Signed-off-by: Alex Collins <alex_collins@intuit.com>
---
 util/template/expression_template.go | 35 +++++++---------------------
 util/template/template_test.go       | 10 ++------
 2 files changed, 11 insertions(+), 34 deletions(-)

diff --git a/util/template/expression_template.go b/util/template/expression_template.go
index 219ef55abe14..d11a113af756 100644
--- a/util/template/expression_template.go
+++ b/util/template/expression_template.go
@@ -1,7 +1,6 @@
 package template
 
 import (
-	"encoding/json"
 	"fmt"
 	"io"
 	"os"
@@ -9,6 +8,7 @@ import (
 	"github.com/antonmedv/expr"
 	"github.com/antonmedv/expr/file"
 	"github.com/antonmedv/expr/parser/lexer"
+	log "github.com/sirupsen/logrus"
 )
 
 func init() {
@@ -18,44 +18,27 @@ func init() {
 }
 
 func expressionReplace(w io.Writer, expression string, env map[string]interface{}, allowUnresolved bool) (int, error) {
-	// The template is JSON-marshaled. This JSON-unmarshals the expression to undo any character escapes.
-	var unmarshalledExpression string
-	err := json.Unmarshal([]byte(fmt.Sprintf(`"%s"`, expression)), &unmarshalledExpression)
-	if err != nil && allowUnresolved {
-		return w.Write([]byte(fmt.Sprintf("{{%s%s}}", kindExpression, expression)))
-	}
-	if err != nil {
-		return 0, fmt.Errorf("failed to unmarshall JSON expression: %w", err)
-	}
-
-	if _, ok := env["retries"]; !ok && hasRetries(unmarshalledExpression) && allowUnresolved {
+	log := log.WithField("ALEX", "true")
+	if _, ok := env["retries"]; !ok && hasRetries(expression) && allowUnresolved {
 		// this is to make sure expressions like `sprig.int(retries)` don't get resolved to 0 when `retries` don't exist in the env
 		// See https://github.com/argoproj/argo-workflows/issues/5388
+		log.WithField("allowUnresolved", allowUnresolved).WithField("hasRetries", true).Debug("expression template noop")
 		return w.Write([]byte(fmt.Sprintf("{{%s%s}}", kindExpression, expression)))
 	}
-	result, err := expr.Eval(unmarshalledExpression, env)
+	result, err := expr.Eval(expression, env)
 	if (err != nil || result == nil) && allowUnresolved { //  <nil> result is also un-resolved, and any error can be unresolved
+		log.WithError(err).WithField("result", result).WithField("allowUnresolved", allowUnresolved).Debug("expression template noop")
 		return w.Write([]byte(fmt.Sprintf("{{%s%s}}", kindExpression, expression)))
 	}
 	if err != nil {
+		log.WithError(err).Debug()
 		return 0, fmt.Errorf("failed to evaluate expression: %w", err)
 	}
 	if result == nil {
+		log.Debug("result is nil")
 		return 0, fmt.Errorf("failed to evaluate expression %q", expression)
 	}
-	resultMarshaled, err := json.Marshal(fmt.Sprintf("%v", result))
-	if (err != nil || resultMarshaled == nil) && allowUnresolved {
-		return w.Write([]byte(fmt.Sprintf("{{%s%s}}", kindExpression, expression)))
-	}
-	if err != nil {
-		return 0, fmt.Errorf("failed to marshal evaluated expression: %w", err)
-	}
-	if resultMarshaled == nil {
-		return 0, fmt.Errorf("failed to marshal evaluated marshaled expression %q", expression)
-	}
-	// Trim leading and trailing quotes. The value is being inserted into something that's already a string.
-	marshaledLength := len(resultMarshaled)
-	return w.Write(resultMarshaled[1 : marshaledLength-1])
+	return w.Write([]byte(fmt.Sprintf("%v", result)))
 }
 
 func envMap(replaceMap map[string]string) map[string]interface{} {
diff --git a/util/template/template_test.go b/util/template/template_test.go
index f108c90cd39e..8e083b303a58 100644
--- a/util/template/template_test.go
+++ b/util/template/template_test.go
@@ -1,7 +1,6 @@
 package template
 
 import (
-	"encoding/json"
 	"testing"
 
 	"github.com/stretchr/testify/assert"
@@ -12,14 +11,9 @@ type SimpleValue struct {
 }
 
 func processTemplate(t *testing.T, tmpl SimpleValue) SimpleValue {
-	tmplBytes, err := json.Marshal(tmpl)
+	err := Replace(&tmpl, map[string]string{}, true)
 	assert.NoError(t, err)
-	r, err := Replace(string(tmplBytes), map[string]string{}, true)
-	assert.NoError(t, err)
-	var newTmpl SimpleValue
-	err = json.Unmarshal([]byte(r), &newTmpl)
-	assert.NoError(t, err)
-	return newTmpl
+	return tmpl
 }
 
 func Test_Template_Replace(t *testing.T) {
