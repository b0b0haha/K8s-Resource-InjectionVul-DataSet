From a1abad28c1d4dfb3e3aee595e0b2d18b8d3f5625 Mon Sep 17 00:00:00 2001
From: Jan Safranek <jsafrane@redhat.com>
Date: Wed, 2 Oct 2019 14:10:32 +0200
Subject: [PATCH] Sanitize error messages

So they do not leak SnapshotContent / PV existence
---
 pkg/controller/controller.go | 31 ++++++++++++++++++++-----------
 1 file changed, 20 insertions(+), 11 deletions(-)

diff --git a/pkg/controller/controller.go b/pkg/controller/controller.go
index c467b2d04b..f57d6b92d4 100644
--- a/pkg/controller/controller.go
+++ b/pkg/controller/controller.go
@@ -735,23 +735,28 @@ func (p *csiProvisioner) getPVCSource(options controller.ProvisionOptions) (*csi
 
 	sourcePV, err := p.client.CoreV1().PersistentVolumes().Get(sourcePVC.Spec.VolumeName, metav1.GetOptions{})
 	if err != nil {
-		return nil, fmt.Errorf("error getting PV %s from api server: %v", sourcePVC.Spec.VolumeName, err)
+		klog.Warningf("error getting volume %s for PVC %s/%s: %s", sourcePVC.Spec.VolumeName, sourcePVC.Namespace, sourcePVC.Name, err)
+		return nil, fmt.Errorf("claim in dataSource not bound or invalid")
 	}
 
 	if sourcePV.Spec.CSI == nil {
-		return nil, fmt.Errorf("error getting volume source from persistentVolumeClaim:persistentVolume %s:%s", sourcePVC.Name, sourcePVC.Spec.VolumeName)
+		klog.Warningf("error getting volume source from %s for PVC %s/%s", sourcePVC.Spec.VolumeName, sourcePVC.Namespace, sourcePVC.Name)
+		return nil, fmt.Errorf("claim in dataSource not bound or invalid")
 	}
 
 	if sourcePV.Spec.CSI.Driver != options.StorageClass.Provisioner {
-		return nil, fmt.Errorf("the source volume %s is handled by a different CSI driver than requested by StorageClass %s", sourcePVC.Name, *options.PVC.Spec.StorageClassName)
+		klog.Warningf("the source volume %s for PVC %s/%s is handled by a different CSI driver than requested by StorageClass %s", sourcePVC.Spec.VolumeName, sourcePVC.Namespace, sourcePVC.Name, *options.PVC.Spec.StorageClassName)
+		return nil, fmt.Errorf("claim in dataSource not bound or invalid")
 	}
 
 	if sourcePV.Spec.ClaimRef == nil {
-		return nil, fmt.Errorf("the source volume %s is not bound", sourcePVC.Spec.VolumeName)
+		klog.Warningf("the source volume %s for PVC %s/%s is not bound", sourcePVC.Spec.VolumeName, sourcePVC.Namespace, sourcePVC.Name)
+		return nil, fmt.Errorf("claim in dataSource not bound or invalid")
 	}
 
 	if sourcePV.Spec.ClaimRef.UID != sourcePVC.UID || sourcePV.Spec.ClaimRef.Namespace != sourcePVC.Namespace || sourcePV.Spec.ClaimRef.Name != sourcePVC.Name {
-		return nil, fmt.Errorf("the source volume %s is bound to a different PVC than requested", sourcePVC.Spec.VolumeName)
+		klog.Warningf("the source volume %s for PVC %s/%s is bound to a different PVC than requested", sourcePVC.Spec.VolumeName, sourcePVC.Namespace, sourcePVC.Name)
+		return nil, fmt.Errorf("claim in dataSource not bound or invalid")
 	}
 
 	volumeSource := csi.VolumeContentSource_Volume{
@@ -785,24 +790,28 @@ func (p *csiProvisioner) getSnapshotSource(options controller.ProvisionOptions)
 
 	snapContentObj, err := p.snapshotClient.VolumesnapshotV1alpha1().VolumeSnapshotContents().Get(snapshotObj.Spec.SnapshotContentName, metav1.GetOptions{})
 	if err != nil {
-		klog.Warningf("error getting snapshotcontent %s for snapshot %s/$s from api server: %s", snapshotObj.Spec.SnapshotContentName, snapshotObj.Namespace, snapshotObj.Name,  err)")
-		return nil, fmt.Errorf("error getting snapshotcontent from API server")
+		klog.Warningf("error getting snapshotcontent %s for snapshot %s/%s from api server: %s", snapshotObj.Spec.SnapshotContentName, snapshotObj.Namespace, snapshotObj.Name, err)
+		return nil, fmt.Errorf("snapshot in dataSource not bound or invalid")
 	}
 
 	if snapContentObj.Spec.VolumeSnapshotRef == nil {
-		return nil, fmt.Errorf("the source snapshotContent is not bound")
+		klog.Warningf("snapshotcontent %s for snapshot %s/%s is not bound", snapshotObj.Spec.SnapshotContentName, snapshotObj.Namespace, snapshotObj.Name)
+		return nil, fmt.Errorf("snapshot in dataSource not bound or invalid")
 	}
 
 	if snapContentObj.Spec.VolumeSnapshotRef.UID != snapshotObj.UID || snapContentObj.Spec.VolumeSnapshotRef.Namespace != snapshotObj.Namespace || snapContentObj.Spec.VolumeSnapshotRef.Name != snapshotObj.Name {
-		return nil, fmt.Errorf("the source snapshotContent is bound to a different snapshot than requested")
+		klog.Warningf("snapshotcontent %s for snapshot %s/%s is bound to a different snapshot", snapshotObj.Spec.SnapshotContentName, snapshotObj.Namespace, snapshotObj.Name)
+		return nil, fmt.Errorf("snapshot in dataSource not bound or invalid")
 	}
 
 	if snapContentObj.Spec.VolumeSnapshotSource.CSI == nil {
-		return nil, fmt.Errorf("error getting snapshot source from snapshotcontent")
+		klog.Warningf("error getting snapshot source from snapshotcontent %s for snapshot %s/%s", snapshotObj.Spec.SnapshotContentName, snapshotObj.Namespace, snapshotObj.Name)
+		return nil, fmt.Errorf("snapshot in dataSource not bound or invalid")
 	}
 
 	if snapContentObj.Spec.VolumeSnapshotSource.CSI.Driver != options.StorageClass.Provisioner {
-		return nil, fmt.Errorf("the snapshot content is handled by a different CSI driver than requested by StorageClass %s", options.StorageClass.Name)
+		klog.Warningf("snapshotcontent %s for snapshot %s/%s is handled by a different CSI driver than requested by StorageClass %s", snapshotObj.Spec.SnapshotContentName, snapshotObj.Namespace, snapshotObj.Name, options.StorageClass.Name)
+		return nil, fmt.Errorf("snapshot in dataSource not bound or invalid")
 	}
 
 	klog.V(5).Infof("VolumeSnapshotContent %+v", snapContentObj)
