From e44f73f2a73512671c5f6a25d4ad0ac193394657 Mon Sep 17 00:00:00 2001
From: Philippe Scorsolini <p.scorsolini@gmail.com>
Date: Thu, 13 Jul 2023 16:11:35 +0200
Subject: [PATCH] fix: max size of package parsed limited to 200MB

Signed-off-by: Philippe Scorsolini <p.scorsolini@gmail.com>
---
 internal/controller/pkg/revision/reconciler.go | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/internal/controller/pkg/revision/reconciler.go b/internal/controller/pkg/revision/reconciler.go
index 9eb95720b43..a2069a18ac0 100644
--- a/internal/controller/pkg/revision/reconciler.go
+++ b/internal/controller/pkg/revision/reconciler.go
@@ -54,6 +54,8 @@ import (
 
 const (
 	reconcileTimeout = 3 * time.Minute
+	// the max size of a package parsed by the parser
+	maxPackageSize = 200 << 20 // 100 MB
 )
 
 const (
@@ -474,7 +476,13 @@ func (r *Reconciler) Reconcile(ctx context.Context, req reconcile.Request) (reco
 	}
 
 	// Parse package contents.
-	pkg, err := r.parser.Parse(ctx, rc)
+	pkg, err := r.parser.Parse(ctx, struct {
+		io.Reader
+		io.Closer
+	}{
+		Reader: io.LimitReader(rc, maxPackageSize),
+		Closer: rc,
+	})
 	// Wait until we finish writing to cache. Parser closes the reader.
 	if err := <-cacheWrite; err != nil {
 		// If we failed to cache we want to cleanup, but we don't abort unless
