From 806f5687962951fefb4942064983bf1ed0cd9435 Mon Sep 17 00:00:00 2001
From: Sergiusz Urbaniak <sergiusz.urbaniak@gmail.com>
Date: Mon, 8 May 2023 15:37:40 +0200
Subject: [PATCH] pkg/securitycontextconstraints/sccadmission: simplify
 retrieving SCCs

---
 .../sccadmission/admission.go                        | 12 +++---------
 1 file changed, 3 insertions(+), 9 deletions(-)

diff --git a/pkg/securitycontextconstraints/sccadmission/admission.go b/pkg/securitycontextconstraints/sccadmission/admission.go
index f29ce7b55..a970e18ee 100644
--- a/pkg/securitycontextconstraints/sccadmission/admission.go
+++ b/pkg/securitycontextconstraints/sccadmission/admission.go
@@ -206,20 +206,14 @@ func (c *constraint) computeSecurityContext(ctx context.Context, a admission.Att
 		return nil, "", nil, admission.NewForbidden(a, fmt.Errorf("securitycontextconstraints.security.openshift.io required check failed oddly"))
 	}
 
-	constraints, err := sccmatching.NewDefaultSCCMatcher(c.sccLister, nil).FindApplicableSCCs(ctx, a.GetNamespace())
+	constraints, err := c.sccLister.List(labels.Everything())
 	if err != nil {
 		return nil, "", nil, admission.NewForbidden(a, err)
 	}
 	if len(constraints) == 0 {
-		sccs, err := c.sccLister.List(labels.Everything())
-		if err != nil {
-			return nil, "", nil, admission.NewForbidden(a, err)
-		}
-		if len(sccs) == 0 {
-			return nil, "", nil, admission.NewForbidden(a, fmt.Errorf("no SecurityContextConstraints found in cluster"))
-		}
-		return nil, "", nil, admission.NewForbidden(a, fmt.Errorf("no SecurityContextConstraints found in namespace %s", a.GetNamespace()))
+		return nil, "", nil, admission.NewForbidden(a, fmt.Errorf("no SecurityContextConstraints found in cluster"))
 	}
+	sort.Sort(sccsort.ByPriority(constraints))
 
 	// If mutation is not allowed and validatedSCCHint is provided, check the validated policy first.
 	// Keep the order the same for everything else
