From 423165120229bf9df34b0b86de221efdaf8c9a4f Mon Sep 17 00:00:00 2001
From: Jed Lejosne <jed@redhat.com>
Date: Mon, 22 Jun 2020 16:35:52 -0400
Subject: [PATCH] Add a feature gate to enable hostDisks

Signed-off-by: Jed Lejosne <jed@redhat.com>
(cherry picked from commit 0594cfff9a99538c32bf3bd209b70b60d24fc581)
Signed-off-by: Jed Lejosne <jed@redhat.com>
---
 .../admitters/vmi-create-admitter.go          |  7 ++++
 .../admitters/vmi-create-admitter_test.go     | 37 +++++++++++++++++++
 .../admitters/vms-admitter_test.go            | 21 ++++++++++-
 pkg/virt-config/feature-gates.go              |  5 +++
 tests/storage_test.go                         | 36 ++++++++++++++++++
 tests/vmi_configuration_test.go               | 11 ++++++
 tools/vms-generator/vms-generator.go          |  2 +-
 7 files changed, 117 insertions(+), 2 deletions(-)

diff --git a/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter.go b/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter.go
index 9bc4fad0c382..8d5bab655020 100644
--- a/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter.go
+++ b/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter.go
@@ -1348,6 +1348,13 @@ func validateVolumes(field *k8sfield.Path, volumes []v1.Volume, config *virtconf
 
 		// validate HostDisk data
 		if hostDisk := volume.HostDisk; hostDisk != nil {
+			if !config.HostDiskEnabled() {
+				causes = append(causes, metav1.StatusCause{
+					Type:    metav1.CauseTypeFieldValueInvalid,
+					Message: "HostDisk feature gate is not enabled",
+					Field:   field.Index(idx).String(),
+				})
+			}
 			if hostDisk.Path == "" {
 				causes = append(causes, metav1.StatusCause{
 					Type:    metav1.CauseTypeFieldValueNotFound,
diff --git a/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter_test.go b/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter_test.go
index 37339b26cdcf..5c0bc535686f 100644
--- a/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter_test.go
+++ b/pkg/virt-api/webhooks/validating-webhook/admitters/vmi-create-admitter_test.go
@@ -2259,6 +2259,43 @@ var _ = Describe("Validating VMICreate Admitter", func() {
 
 	})
 
+	Context("with volume", func() {
+		It("should reject hostDisk volumes if the feature gate is not enabled", func() {
+			vmi := v1.NewMinimalVMI("testvmi")
+
+			vmi.Spec.Volumes = append(vmi.Spec.Volumes, v1.Volume{
+				Name: "testHostDisk",
+				VolumeSource: v1.VolumeSource{
+					HostDisk: &v1.HostDisk{
+						Type: v1.HostDiskExistsOrCreate,
+						Path: "/hostdisktest.img",
+					},
+				},
+			})
+
+			causes := validateVolumes(k8sfield.NewPath("fake"), vmi.Spec.Volumes, config)
+			Expect(len(causes)).To(Equal(1))
+		})
+
+		It("should accept hostDisk volumes if the feature gate is enabled", func() {
+			enableFeatureGate(virtconfig.HostDiskGate)
+			vmi := v1.NewMinimalVMI("testvmi")
+
+			vmi.Spec.Volumes = append(vmi.Spec.Volumes, v1.Volume{
+				Name: "testHostDisk",
+				VolumeSource: v1.VolumeSource{
+					HostDisk: &v1.HostDisk{
+						Type: v1.HostDiskExistsOrCreate,
+						Path: "/hostdisktest.img",
+					},
+				},
+			})
+
+			causes := validateVolumes(k8sfield.NewPath("fake"), vmi.Spec.Volumes, config)
+			Expect(len(causes)).To(Equal(0))
+		})
+	})
+
 	Context("with bootloader", func() {
 		It("should accept empty bootloader setting", func() {
 			vmi := v1.NewMinimalVMI("testvmi")
diff --git a/pkg/virt-api/webhooks/validating-webhook/admitters/vms-admitter_test.go b/pkg/virt-api/webhooks/validating-webhook/admitters/vms-admitter_test.go
index 41a1f1a8a974..40205ae3fccf 100644
--- a/pkg/virt-api/webhooks/validating-webhook/admitters/vms-admitter_test.go
+++ b/pkg/virt-api/webhooks/validating-webhook/admitters/vms-admitter_test.go
@@ -40,12 +40,22 @@ import (
 	cdiv1 "kubevirt.io/containerized-data-importer/pkg/apis/core/v1alpha1"
 	"kubevirt.io/kubevirt/pkg/testutils"
 	"kubevirt.io/kubevirt/pkg/virt-api/webhooks"
+	virtconfig "kubevirt.io/kubevirt/pkg/virt-config"
 )
 
 var _ = Describe("Validating VM Admitter", func() {
-	config, _, crdInformer := testutils.NewFakeClusterConfig(&k8sv1.ConfigMap{})
+	config, configMapInformer, crdInformer := testutils.NewFakeClusterConfig(&k8sv1.ConfigMap{})
 	var vmsAdmitter *VMsAdmitter
 
+	enableFeatureGate := func(featureGate string) {
+		testutils.UpdateFakeClusterConfig(configMapInformer, &k8sv1.ConfigMap{
+			Data: map[string]string{virtconfig.FeatureGatesKey: featureGate},
+		})
+	}
+	disableFeatureGates := func() {
+		testutils.UpdateFakeClusterConfig(configMapInformer, &k8sv1.ConfigMap{})
+	}
+
 	notRunning := false
 
 	BeforeEach(func() {
@@ -414,6 +424,15 @@ var _ = Describe("Validating VM Admitter", func() {
 	})
 
 	Context("with Volume", func() {
+
+		BeforeEach(func() {
+			enableFeatureGate(virtconfig.HostDiskGate)
+		})
+
+		AfterEach(func() {
+			disableFeatureGates()
+		})
+
 		table.DescribeTable("should accept valid volumes",
 			func(volumeSource v1.VolumeSource) {
 				vmi := v1.NewMinimalVMI("testvmi")
diff --git a/pkg/virt-config/feature-gates.go b/pkg/virt-config/feature-gates.go
index 68c2ffee30b7..a673af92537b 100644
--- a/pkg/virt-config/feature-gates.go
+++ b/pkg/virt-config/feature-gates.go
@@ -35,6 +35,7 @@ const (
 	HypervStrictCheckGate = "HypervStrictCheck"
 	SidecarGate           = "Sidecar"
 	GPUGate               = "GPU"
+	HostDiskGate          = "HostDisk"
 )
 
 func (c *ClusterConfig) isFeatureGateEnabled(featureGate string) bool {
@@ -68,3 +69,7 @@ func (config *ClusterConfig) SidecarEnabled() bool {
 func (config *ClusterConfig) GPUPassthroughEnabled() bool {
 	return config.isFeatureGateEnabled(GPUGate)
 }
+
+func (config *ClusterConfig) HostDiskEnabled() bool {
+	return config.isFeatureGateEnabled(HostDiskGate)
+}
diff --git a/tests/storage_test.go b/tests/storage_test.go
index 6708e57ddf74..d597cd4df4de 100644
--- a/tests/storage_test.go
+++ b/tests/storage_test.go
@@ -384,12 +384,20 @@ var _ = Describe("Storage", func() {
 
 				hostDiskDir := tests.RandTmpDir()
 				var nodeName string
+				var cfgMap *k8sv1.ConfigMap
+				var originalFeatureGates string
 
 				BeforeEach(func() {
 					nodeName = ""
+					cfgMap, err = virtClient.CoreV1().ConfigMaps(tests.KubeVirtInstallNamespace).Get(kubevirtConfig, metav1.GetOptions{})
+					Expect(err).ToNot(HaveOccurred())
+					originalFeatureGates = cfgMap.Data[virtconfig.FeatureGatesKey]
+					tests.EnableFeatureGate(virtconfig.HostDiskGate)
 				})
 
 				AfterEach(func() {
+					tests.UpdateClusterConfigValueAndWait(virtconfig.FeatureGatesKey, originalFeatureGates)
+
 					// Delete all VMIs and wait until they disappear to ensure that no disk is in use and that we can delete the whole folder
 					Expect(virtClient.RestClient().Delete().Namespace(tests.NamespaceTestDefault).Resource("virtualmachineinstances").Do().Error()).ToNot(HaveOccurred())
 					Eventually(func() int {
@@ -402,6 +410,23 @@ var _ = Describe("Storage", func() {
 					}
 				})
 
+				Context("Without the HostDisk feature gate enabled", func() {
+					BeforeEach(func() {
+						tests.DisableFeatureGate(virtconfig.HostDiskGate)
+					})
+
+					It("Should fail to start a VMI", func() {
+						diskName := "disk-" + uuid.NewRandom().String() + ".img"
+						diskPath := filepath.Join(hostDiskDir, diskName)
+						vmi = tests.NewRandomVMIWithHostDisk(diskPath, v1.HostDiskExistsOrCreate, "")
+						virtClient, err := kubecli.GetKubevirtClient()
+						Expect(err).ToNot(HaveOccurred())
+						_, err = virtClient.VirtualMachineInstance(tests.NamespaceTestDefault).Create(vmi)
+						Expect(err).To(HaveOccurred())
+						Expect(err.Error()).To(ContainSubstring("HostDisk feature gate is not enabled"))
+					})
+				})
+
 				Context("With 'DiskExistsOrCreate' type", func() {
 					diskName := "disk-" + uuid.NewRandom().String() + ".img"
 					diskPath := filepath.Join(hostDiskDir, diskName)
@@ -577,8 +602,15 @@ var _ = Describe("Storage", func() {
 				var diskPath string
 				var pod *k8sv1.Pod
 				var diskSize int
+				var cfgMap *k8sv1.ConfigMap
+				var originalFeatureGates string
 
 				BeforeEach(func() {
+					By("Enabling the HostDisk feature gate")
+					cfgMap, err = virtClient.CoreV1().ConfigMaps(tests.KubeVirtInstallNamespace).Get(kubevirtConfig, metav1.GetOptions{})
+					Expect(err).ToNot(HaveOccurred())
+					originalFeatureGates = cfgMap.Data[virtconfig.FeatureGatesKey]
+					tests.EnableFeatureGate(virtconfig.HostDiskGate)
 
 					By("Creating a hostPath pod which prepares a mounted directory which goes away when the pod dies")
 					tmpDir := tests.RandTmpDir()
@@ -618,6 +650,10 @@ var _ = Describe("Storage", func() {
 
 				})
 
+				AfterEach(func() {
+					tests.UpdateClusterConfigValueAndWait(virtconfig.FeatureGatesKey, originalFeatureGates)
+				})
+
 				configureToleration := func(toleration int) {
 					By("By configuring toleration")
 					tests.UpdateClusterConfigValueAndWait(virtconfig.LessPVCSpaceTolerationKey, strconv.Itoa(toleration))
diff --git a/tests/vmi_configuration_test.go b/tests/vmi_configuration_test.go
index dac1c620c072..7f9916be2e23 100644
--- a/tests/vmi_configuration_test.go
+++ b/tests/vmi_configuration_test.go
@@ -1616,11 +1616,22 @@ var _ = Describe("Configurations", func() {
 	})
 
 	Context("[rfe_id:904][crit:medium][vendor:cnv-qe@redhat.com][level:component]with driver cache settings and PVC", func() {
+		var cfgMap *kubev1.ConfigMap
+		var originalFeatureGates string
+
 		BeforeEach(func() {
+			cfgMap, err = virtClient.CoreV1().ConfigMaps(tests.KubeVirtInstallNamespace).Get(kubevirtConfig, metav1.GetOptions{})
+			Expect(err).ToNot(HaveOccurred())
+			originalFeatureGates = cfgMap.Data[virtconfig.FeatureGatesKey]
+			tests.EnableFeatureGate(virtconfig.HostDiskGate)
 			// create a new PV and PVC (PVs can't be reused)
 			tests.CreateBlockVolumePvAndPvc("1Gi")
 		}, 60)
 
+		AfterEach(func() {
+			tests.UpdateClusterConfigValueAndWait(virtconfig.FeatureGatesKey, originalFeatureGates)
+		})
+
 		It("[test_id:1681]should set appropriate cache modes", func() {
 			tests.SkipPVCTestIfRunnigOnKindInfra()
 
diff --git a/tools/vms-generator/vms-generator.go b/tools/vms-generator/vms-generator.go
index 59bc6950fed2..a7500bc6c093 100644
--- a/tools/vms-generator/vms-generator.go
+++ b/tools/vms-generator/vms-generator.go
@@ -48,7 +48,7 @@ func main() {
 	config, _, _ := testutils.NewFakeClusterConfig(&k8sv1.ConfigMap{
 		Data: map[string]string{
 			// Required to validate DataVolume usage
-			virtconfig.FeatureGatesKey:                   "DataVolumes,LiveMigration,SRIOV,GPU",
+			virtconfig.FeatureGatesKey:                   "DataVolumes,LiveMigration,SRIOV,GPU,HostDisk",
 			virtconfig.PermitSlirpInterface:              "true",
 			virtconfig.PermitBridgeInterfaceOnPodNetwork: "true",
 		},
