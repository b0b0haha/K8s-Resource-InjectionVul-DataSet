From 468f00e416bd6609338f4ab2f11ad8d19d6849a6 Mon Sep 17 00:00:00 2001
From: Stefan Prodan <stefan.prodan@gmail.com>
Date: Mon, 13 Sep 2021 16:18:44 +0300
Subject: [PATCH] Implement health checking for all resources - Add
 `.spec.wait` optional boolean field to API - Wait for all applied resources
 to become ready when `.spec.wait` is set to `true`

Signed-off-by: Stefan Prodan <stefan.prodan@gmail.com>
---
 api/v1beta2/inventory_types.go                |  2 +-
 api/v1beta2/kustomization_types.go            | 15 ++++++----
 ...mize.toolkit.fluxcd.io_kustomizations.yaml |  7 +++--
 config/testdata/crds-crs/cert-manager.yaml    | 10 +------
 controllers/kustomization_controller.go       | 20 +++++++------
 controllers/kustomization_wait_test.go        | 19 ++-----------
 controllers/suite_test.go                     |  4 ++-
 docs/api/kustomize.md                         | 28 ++++++++++++++++++-
 main.go                                       | 11 +++++---
 9 files changed, 68 insertions(+), 48 deletions(-)

diff --git a/api/v1beta2/inventory_types.go b/api/v1beta2/inventory_types.go
index 6c63a477..f1d47202 100644
--- a/api/v1beta2/inventory_types.go
+++ b/api/v1beta2/inventory_types.go
@@ -29,5 +29,5 @@ type Entry struct {
 	ObjectID string `json:"id"`
 
 	// ObjectVersion is the API version of this  Kubernetes object kind.
-	ObjectVersion string `json:"ver"`
+	ObjectVersion string `json:"v"`
 }
diff --git a/api/v1beta2/kustomization_types.go b/api/v1beta2/kustomization_types.go
index 54b52081..d23a1004 100644
--- a/api/v1beta2/kustomization_types.go
+++ b/api/v1beta2/kustomization_types.go
@@ -17,11 +17,10 @@ limitations under the License.
 package v1beta2
 
 import (
+	apimeta "k8s.io/apimachinery/pkg/api/meta"
 	"time"
 
 	apiextensionsv1 "k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/v1"
-	apimeta "k8s.io/apimachinery/pkg/api/meta"
-
 	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
 	"k8s.io/apimachinery/pkg/types"
 
@@ -31,7 +30,6 @@ import (
 )
 
 const (
-	KustomizationController   = "kustomize-controller"
 	KustomizationKind         = "Kustomization"
 	KustomizationFinalizer    = "finalizers.fluxcd.io"
 	MaxConditionMessageLength = 20000
@@ -137,6 +135,11 @@ type KustomizationSpec struct {
 	// +kubebuilder:default:=false
 	// +optional
 	Force bool `json:"force,omitempty"`
+
+	// Wait instructs the controller to check the health of all the reconciled resources.
+	// When enabled, the HealthChecks are ignored. Defaults to false.
+	// +optional
+	Wait bool `json:"wait,omitempty"`
 }
 
 // Decryption defines how decryption is handled for Kubernetes manifests.
@@ -235,12 +238,12 @@ func KustomizationProgressing(k Kustomization, message string) Kustomization {
 
 // SetKustomizationHealthiness sets the HealthyCondition status for a Kustomization.
 func SetKustomizationHealthiness(k *Kustomization, status metav1.ConditionStatus, reason, message string) {
-	switch len(k.Spec.HealthChecks) {
-	case 0:
+	if !k.Spec.Wait && len(k.Spec.HealthChecks) == 0 {
 		apimeta.RemoveStatusCondition(k.GetStatusConditions(), HealthyCondition)
-	default:
+	} else {
 		meta.SetResourceCondition(k, HealthyCondition, status, reason, trimString(message, MaxConditionMessageLength))
 	}
+
 }
 
 // SetKustomizationReadiness sets the ReadyCondition, ObservedGeneration, and LastAttemptedRevision, on the Kustomization.
diff --git a/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml b/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
index c278c1ec..7094da0b 100644
--- a/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
+++ b/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
@@ -722,6 +722,9 @@ spec:
               timeout:
                 description: Timeout for validation, apply and health checking operations. Defaults to 'Interval' duration.
                 type: string
+              wait:
+                description: Wait instructs the controller to check the health of all the reconciled resources. When enabled, the HealthChecks are ignored. Defaults to false.
+                type: boolean
             required:
             - interval
             - prune
@@ -786,12 +789,12 @@ spec:
                         id:
                           description: ObjectID is the string representation of a Kubernetes object metadata, in the format '<namespace>_<name>_<group>_<kind>'.
                           type: string
-                        ver:
+                        v:
                           description: ObjectVersion is the API version of this  Kubernetes object kind.
                           type: string
                       required:
                       - id
-                      - ver
+                      - v
                       type: object
                     type: array
                 required:
diff --git a/config/testdata/crds-crs/cert-manager.yaml b/config/testdata/crds-crs/cert-manager.yaml
index db9fd8ca..1cec3dc5 100644
--- a/config/testdata/crds-crs/cert-manager.yaml
+++ b/config/testdata/crds-crs/cert-manager.yaml
@@ -19,13 +19,5 @@ spec:
   sourceRef:
     kind: GitRepository
     name: certs
-  healthChecks:
-    - apiVersion: apps/v1
-      kind: Deployment
-      name: cert-manager
-      namespace: cert-manager
-    - apiVersion: apps/v1
-      kind: Deployment
-      name: cert-manager-webhook
-      namespace: cert-manager
+  wait: true
   timeout: 2m
diff --git a/controllers/kustomization_controller.go b/controllers/kustomization_controller.go
index de52b935..1a02d904 100644
--- a/controllers/kustomization_controller.go
+++ b/controllers/kustomization_controller.go
@@ -80,6 +80,7 @@ type KustomizationReconciler struct {
 	ExternalEventRecorder *events.Recorder
 	MetricsRecorder       *metrics.Recorder
 	StatusPoller          *polling.StatusPoller
+	ControllerName        string
 }
 
 type KustomizationReconcilerOptions struct {
@@ -365,7 +366,7 @@ func (r *KustomizationReconciler) reconcile(
 	}
 
 	resourceManager := ssa.NewResourceManager(kubeClient, statusPoller, ssa.Owner{
-		Field: kustomizev1.KustomizationController,
+		Field: r.ControllerName,
 		Group: kustomizev1.GroupVersion.Group,
 	})
 	resourceManager.SetOwnerLabels(objects, kustomization.GetName(), kustomization.GetNamespace())
@@ -420,7 +421,7 @@ func (r *KustomizationReconciler) reconcile(
 	}
 
 	// health assessment
-	if err := r.checkHealth(ctx, resourceManager, kustomization, revision, drifted); err != nil {
+	if err := r.checkHealth(ctx, resourceManager, kustomization, revision, drifted, objects); err != nil {
 		return kustomizev1.KustomizationNotReadyInventory(
 			kustomization,
 			newInventory,
@@ -669,15 +670,18 @@ func (r *KustomizationReconciler) apply(ctx context.Context, manager *ssa.Resour
 	return applyLog != "", nil
 }
 
-func (r *KustomizationReconciler) checkHealth(ctx context.Context, manager *ssa.ResourceManager, kustomization kustomizev1.Kustomization, revision string, drifted bool) error {
-	if len(kustomization.Spec.HealthChecks) == 0 {
+func (r *KustomizationReconciler) checkHealth(ctx context.Context, manager *ssa.ResourceManager, kustomization kustomizev1.Kustomization, revision string, drifted bool, objects []*unstructured.Unstructured) error {
+	if len(kustomization.Spec.HealthChecks) == 0 && !kustomization.Spec.Wait {
 		return nil
 	}
 
 	checkStart := time.Now()
-	objects, err := referenceToUnstructured(kustomization.Spec.HealthChecks)
-	if err != nil {
-		return err
+	var err error
+	if !kustomization.Spec.Wait {
+		objects, err = referenceToUnstructured(kustomization.Spec.HealthChecks)
+		if err != nil {
+			return err
+		}
 	}
 
 	// find the previous health check result
@@ -744,7 +748,7 @@ func (r *KustomizationReconciler) finalize(ctx context.Context, kustomization ku
 			r.event(ctx, kustomization, kustomization.Status.LastAppliedRevision, events.EventSeverityError, msg, nil)
 		} else {
 			resourceManager := ssa.NewResourceManager(kubeClient, nil, ssa.Owner{
-				Field: kustomizev1.KustomizationController,
+				Field: r.ControllerName,
 				Group: kustomizev1.GroupVersion.Group,
 			})
 
diff --git a/controllers/kustomization_wait_test.go b/controllers/kustomization_wait_test.go
index b779f83a..b7f3319b 100644
--- a/controllers/kustomization_wait_test.go
+++ b/controllers/kustomization_wait_test.go
@@ -99,14 +99,7 @@ data:
 			TargetNamespace: id,
 			Prune:           true,
 			Timeout:         &metav1.Duration{Duration: time.Second},
-			HealthChecks: []meta.NamespacedObjectKindReference{
-				{
-					APIVersion: "v1",
-					Kind:       "ConfigMap",
-					Name:       id,
-					Namespace:  id,
-				},
-			},
+			Wait:            true,
 		},
 	}
 
@@ -135,6 +128,7 @@ data:
 			resultK.SetAnnotations(map[string]string{
 				meta.ReconcileRequestAnnotation: reconcileRequestAt,
 			})
+			resultK.Spec.Wait = false
 			resultK.Spec.HealthChecks = []meta.NamespacedObjectKindReference{
 				{
 					APIVersion: "v1",
@@ -184,14 +178,7 @@ data:
 	t.Run("recovers and reports healthy status", func(t *testing.T) {
 		g.Eventually(func() error {
 			_ = k8sClient.Get(context.Background(), client.ObjectKeyFromObject(kustomization), resultK)
-			resultK.Spec.HealthChecks = []meta.NamespacedObjectKindReference{
-				{
-					APIVersion: "v1",
-					Kind:       "ConfigMap",
-					Name:       id,
-					Namespace:  id,
-				},
-			}
+			resultK.Spec.Wait = true
 			return k8sClient.Update(context.Background(), resultK)
 		}, timeout, time.Second).Should(BeNil())
 
diff --git a/controllers/suite_test.go b/controllers/suite_test.go
index f6b6a1d2..d806bd1d 100644
--- a/controllers/suite_test.go
+++ b/controllers/suite_test.go
@@ -113,9 +113,11 @@ func TestMain(m *testing.M) {
 		Scheme: scheme.Scheme,
 	})
 
-	testEventsH = controller.MakeEvents(k8sManager, "kustomize-controller-test", nil)
+	controllerName := "kustomize-controller"
+	testEventsH = controller.MakeEvents(k8sManager, controllerName, nil)
 	testMetricsH = controller.MustMakeMetrics(k8sManager)
 	reconciler := &KustomizationReconciler{
+		ControllerName:  controllerName,
 		Client:          k8sManager.GetClient(),
 		EventRecorder:   testEventsH.EventRecorder,
 		MetricsRecorder: testMetricsH.MetricsRecorder,
diff --git a/docs/api/kustomize.md b/docs/api/kustomize.md
index dbc6ea0b..fb2ac18c 100644
--- a/docs/api/kustomize.md
+++ b/docs/api/kustomize.md
@@ -337,6 +337,19 @@ bool
 when patching fails due to an immutable field change.</p>
 </td>
 </tr>
+<tr>
+<td>
+<code>wait</code><br>
+<em>
+bool
+</em>
+</td>
+<td>
+<em>(Optional)</em>
+<p>Wait instructs the controller to check the health of all the reconciled resources.
+When enabled, the HealthChecks are ignored. Defaults to false.</p>
+</td>
+</tr>
 </table>
 </td>
 </tr>
@@ -501,7 +514,7 @@ in the format &lsquo;<namespace><em><name></em><group>_<kind>&rsquo;.</p>
 </tr>
 <tr>
 <td>
-<code>ver</code><br>
+<code>v</code><br>
 <em>
 string
 </em>
@@ -875,6 +888,19 @@ bool
 when patching fails due to an immutable field change.</p>
 </td>
 </tr>
+<tr>
+<td>
+<code>wait</code><br>
+<em>
+bool
+</em>
+</td>
+<td>
+<em>(Optional)</em>
+<p>Wait instructs the controller to check the health of all the reconciled resources.
+When enabled, the HealthChecks are ignored. Defaults to false.</p>
+</td>
+</tr>
 </tbody>
 </table>
 </div>
diff --git a/main.go b/main.go
index 1d577f43..e0537004 100644
--- a/main.go
+++ b/main.go
@@ -43,6 +43,8 @@ import (
 	// +kubebuilder:scaffold:imports
 )
 
+const controllerName = "kustomize-controller"
+
 var (
 	scheme   = runtime.NewScheme()
 	setupLog = ctrl.Log.WithName("setup")
@@ -87,7 +89,7 @@ func main() {
 
 	var eventRecorder *events.Recorder
 	if eventsAddr != "" {
-		if er, err := events.NewRecorder(eventsAddr, kustomizev1.KustomizationController); err != nil {
+		if er, err := events.NewRecorder(eventsAddr, controllerName); err != nil {
 			setupLog.Error(err, "unable to create event recorder")
 			os.Exit(1)
 		} else {
@@ -114,7 +116,7 @@ func main() {
 		LeaseDuration:                 &leaderElectionOptions.LeaseDuration,
 		RenewDeadline:                 &leaderElectionOptions.RenewDeadline,
 		RetryPeriod:                   &leaderElectionOptions.RetryPeriod,
-		LeaderElectionID:              fmt.Sprintf("%s-leader-election", kustomizev1.KustomizationController),
+		LeaderElectionID:              fmt.Sprintf("%s-leader-election", controllerName),
 		Namespace:                     watchNamespace,
 		Logger:                        ctrl.Log,
 	})
@@ -127,9 +129,10 @@ func main() {
 	pprof.SetupHandlers(mgr, setupLog)
 
 	if err = (&controllers.KustomizationReconciler{
+		ControllerName:        controllerName,
 		Client:                mgr.GetClient(),
 		Scheme:                mgr.GetScheme(),
-		EventRecorder:         mgr.GetEventRecorderFor(kustomizev1.KustomizationController),
+		EventRecorder:         mgr.GetEventRecorderFor(controllerName),
 		ExternalEventRecorder: eventRecorder,
 		MetricsRecorder:       metricsRecorder,
 		StatusPoller:          polling.NewStatusPoller(mgr.GetClient(), mgr.GetRESTMapper()),
@@ -138,7 +141,7 @@ func main() {
 		DependencyRequeueInterval: requeueDependency,
 		HTTPRetry:                 httpRetry,
 	}); err != nil {
-		setupLog.Error(err, "unable to create controller", "controller", kustomizev1.KustomizationKind)
+		setupLog.Error(err, "unable to create controller", "controller", controllerName)
 		os.Exit(1)
 	}
 	// +kubebuilder:scaffold:builder
