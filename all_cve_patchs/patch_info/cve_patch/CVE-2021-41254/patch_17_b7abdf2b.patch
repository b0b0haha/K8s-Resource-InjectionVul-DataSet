From b7abdf2b844eb2237a53b7ecb1e0a84aa70f08e0 Mon Sep 17 00:00:00 2001
From: Sunny <darkowlzz@protonmail.com>
Date: Wed, 6 Oct 2021 19:15:47 +0530
Subject: [PATCH] envtest: Add cancellable context to stop controllers

In suite test, the context created by SetupSignalHandler() watches for
shutdown signal to cancel the context. This makes it possible to stop
the controllers by sending a kill signal that cancels the context.

This change allows controller context cancellation by creating another
context from SetupSignalHandler() context with a CancelFunc that's
called at the end of the test, instead of sending a kill signal.

Signed-off-by: Sunny <darkowlzz@protonmail.com>
---
 controllers/suite_test.go | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/controllers/suite_test.go b/controllers/suite_test.go
index d806bd1d..6060bfcb 100644
--- a/controllers/suite_test.go
+++ b/controllers/suite_test.go
@@ -27,7 +27,6 @@ import (
 	"os"
 	"path/filepath"
 	"strings"
-	"syscall"
 	"testing"
 	"time"
 
@@ -66,6 +65,7 @@ var (
 	testEventsH  controller.Events
 	testMetricsH controller.Metrics
 	ctx          = ctrl.SetupSignalHandler()
+	cancel       context.CancelFunc
 	kubeConfig   []byte
 	debugMode    = os.Getenv("DEBUG_TEST") != ""
 )
@@ -76,6 +76,9 @@ func TestMain(m *testing.M) {
 	utilruntime.Must(sourcev1.AddToScheme(scheme.Scheme))
 	utilruntime.Must(kustomizev1.AddToScheme(scheme.Scheme))
 
+	// Cancellable context to stop the controllers.
+	ctx, cancel = context.WithCancel(ctx)
+
 	if debugMode {
 		controllerLog.SetLogger(zap.New(zap.WriteTo(os.Stderr), zap.UseDevMode(false)))
 	}
@@ -148,7 +151,7 @@ func TestMain(m *testing.M) {
 	}
 
 	fmt.Println("Stopping the controller")
-	syscall.Kill(syscall.Getpid(), syscall.SIGINT)
+	cancel()
 
 	fmt.Println("Stopping the file server")
 	testServer.Stop()
