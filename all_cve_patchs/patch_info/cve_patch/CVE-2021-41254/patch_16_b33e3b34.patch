From b33e3b3449c12314580c7548ec043934620f5efd Mon Sep 17 00:00:00 2001
From: Stefan Prodan <stefan.prodan@gmail.com>
Date: Sat, 11 Sep 2021 23:30:48 +0300
Subject: [PATCH] Update the status when health checking starts Set the
 healthiness status to progressing and specify the health check timeout in the
 condition message.

Signed-off-by: Stefan Prodan <stefan.prodan@gmail.com>
---
 api/v1beta2/kustomization_types.go      |  4 ++--
 controllers/kustomization_controller.go | 14 ++++++++++++--
 controllers/kustomization_wait_test.go  | 17 +++++++++++++----
 3 files changed, 27 insertions(+), 8 deletions(-)

diff --git a/api/v1beta2/kustomization_types.go b/api/v1beta2/kustomization_types.go
index 248a66e4..c1198380 100644
--- a/api/v1beta2/kustomization_types.go
+++ b/api/v1beta2/kustomization_types.go
@@ -228,8 +228,8 @@ type KustomizationStatus struct {
 
 // KustomizationProgressing resets the conditions of the given Kustomization to a single
 // ReadyCondition with status ConditionUnknown.
-func KustomizationProgressing(k Kustomization) Kustomization {
-	meta.SetResourceCondition(&k, meta.ReadyCondition, metav1.ConditionUnknown, meta.ProgressingReason, "reconciliation in progress")
+func KustomizationProgressing(k Kustomization, message string) Kustomization {
+	meta.SetResourceCondition(&k, meta.ReadyCondition, metav1.ConditionUnknown, meta.ProgressingReason, message)
 	return k
 }
 
diff --git a/controllers/kustomization_controller.go b/controllers/kustomization_controller.go
index ab91be14..792efd45 100644
--- a/controllers/kustomization_controller.go
+++ b/controllers/kustomization_controller.go
@@ -53,6 +53,7 @@ import (
 	"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil"
 	"sigs.k8s.io/controller-runtime/pkg/handler"
 	"sigs.k8s.io/controller-runtime/pkg/predicate"
+	"sigs.k8s.io/controller-runtime/pkg/reconcile"
 	"sigs.k8s.io/controller-runtime/pkg/source"
 	"sigs.k8s.io/kustomize/api/filesys"
 
@@ -224,7 +225,7 @@ func (r *KustomizationReconciler) Reconcile(ctx context.Context, req ctrl.Reques
 	}
 
 	// set the reconciliation status to progressing
-	kustomization = kustomizev1.KustomizationProgressing(kustomization)
+	kustomization = kustomizev1.KustomizationProgressing(kustomization, "reconciliation in progress")
 	if err := r.patchStatus(ctx, req, kustomization.Status); err != nil {
 		log.Error(err, "unable to update status to progressing")
 		return ctrl.Result{Requeue: true}, err
@@ -692,13 +693,22 @@ func (r *KustomizationReconciler) checkHealth(ctx context.Context, man *ssa.Reso
 		return err
 	}
 
+	// set the Healthy and Ready conditions to progressing
+	message := fmt.Sprintf("running health checks with a timeout of %d", kustomization.GetTimeout())
+	kustomization = kustomizev1.KustomizationProgressing(kustomization, message)
+	kustomizev1.SetKustomizationHealthiness(&kustomization, metav1.ConditionUnknown, meta.ProgressingReason, message)
+	if err := r.patchStatus(ctx, reconcile.Request{NamespacedName: client.ObjectKeyFromObject(&kustomization)}, kustomization.Status); err != nil {
+		return fmt.Errorf("unable to update status to progressing, error: %w", err)
+	}
+
+	// check the health with a default timeout of 30sec shorter than the reconciliation interval
 	if err := man.Wait(objects, time.Second, kustomization.GetTimeout()); err != nil {
 		return err
 	}
 
+	// emit event if the previous health check result differs
 	healthiness := apimeta.FindStatusCondition(kustomization.Status.Conditions, kustomizev1.HealthyCondition)
 	healthy := healthiness != nil && healthiness.Status == metav1.ConditionTrue
-
 	if !healthy || (kustomization.Status.LastAppliedRevision != revision && changed) {
 		r.event(ctx, kustomization, revision, events.EventSeverityInfo, "Health check passed", nil)
 	}
diff --git a/controllers/kustomization_wait_test.go b/controllers/kustomization_wait_test.go
index 9e773d4d..eaec26da 100644
--- a/controllers/kustomization_wait_test.go
+++ b/controllers/kustomization_wait_test.go
@@ -142,16 +142,25 @@ data:
 			return k8sClient.Update(context.Background(), resultK)
 		}, timeout, time.Second).Should(BeNil())
 
+		readyCondition := &metav1.Condition{}
+		healthyCondition := &metav1.Condition{}
 		g.Eventually(func() bool {
 			_ = k8sClient.Get(context.Background(), client.ObjectKeyFromObject(kustomization), resultK)
-			ready := apimeta.FindStatusCondition(resultK.Status.Conditions, meta.ReadyCondition)
-			return ready.Reason == meta.ProgressingReason
+			readyCondition = apimeta.FindStatusCondition(resultK.Status.Conditions, meta.ReadyCondition)
+			healthyCondition = apimeta.FindStatusCondition(resultK.Status.Conditions, kustomizev1.HealthyCondition)
+			return readyCondition.Reason == meta.ProgressingReason
 		}, timeout, time.Second).Should(BeTrue())
 
+		expectedMessage := "running health checks"
+		g.Expect(readyCondition.Status).To(BeIdenticalTo(metav1.ConditionUnknown))
+		g.Expect(readyCondition.Message).To(ContainSubstring(expectedMessage))
+		g.Expect(healthyCondition.Status).To(BeIdenticalTo(metav1.ConditionUnknown))
+		g.Expect(healthyCondition.Message).To(ContainSubstring(expectedMessage))
+
 		g.Eventually(func() bool {
 			_ = k8sClient.Get(context.Background(), client.ObjectKeyFromObject(kustomization), resultK)
-			healthy := apimeta.FindStatusCondition(resultK.Status.Conditions, kustomizev1.HealthyCondition)
-			return healthy.Reason == kustomizev1.HealthCheckFailedReason
+			healthyCondition = apimeta.FindStatusCondition(resultK.Status.Conditions, kustomizev1.HealthyCondition)
+			return healthyCondition.Reason == kustomizev1.HealthCheckFailedReason
 		}, time.Minute, time.Second).Should(BeTrue())
 	})
 
