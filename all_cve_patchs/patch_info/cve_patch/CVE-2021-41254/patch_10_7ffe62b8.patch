From 7ffe62b8e739450ad55d66e61cbae70d1da32bba Mon Sep 17 00:00:00 2001
From: Stefan Prodan <stefan.prodan@gmail.com>
Date: Sat, 11 Sep 2021 18:38:39 +0300
Subject: [PATCH] Introduce v1beta2 API Changes from v1beta1: -
 `spec.validation` removed (server-side validation is implicit) -
 `spec.status.snapshot` replaced by `spec.status.inventory` -
 `spec.patchesStrategicMerge` deprecated in favour of `spec.patches` -
 `spec.patchesJson6902` deprecated in favour of `spec.patches`

Signed-off-by: Stefan Prodan <stefan.prodan@gmail.com>
---
 PROJECT                                       |    3 +
 api/v1beta2/condition_types.go                |   43 +
 api/v1beta2/doc.go                            |   20 +
 api/v1beta2/groupversion_info.go              |   33 +
 api/v1beta2/inventory_types.go                |   33 +
 api/v1beta2/kustomization_types.go            |  361 ++++++
 api/v1beta2/reference_types.go                |   47 +
 api/v1beta2/zz_generated.deepcopy.go          |  321 +++++
 ...mize.toolkit.fluxcd.io_kustomizations.yaml |  393 +++++++
 config/kubeconfig                             |   12 -
 docs/api/kustomize.md                         |  311 +++--
 docs/spec/v1beta2/README.md                   |   24 +
 docs/spec/v1beta2/kustomization.md            | 1040 +++++++++++++++++
 13 files changed, 2453 insertions(+), 188 deletions(-)
 create mode 100644 api/v1beta2/condition_types.go
 create mode 100644 api/v1beta2/doc.go
 create mode 100644 api/v1beta2/groupversion_info.go
 create mode 100644 api/v1beta2/inventory_types.go
 create mode 100644 api/v1beta2/kustomization_types.go
 create mode 100644 api/v1beta2/reference_types.go
 create mode 100644 api/v1beta2/zz_generated.deepcopy.go
 delete mode 100644 config/kubeconfig
 create mode 100644 docs/spec/v1beta2/README.md
 create mode 100644 docs/spec/v1beta2/kustomization.md

diff --git a/PROJECT b/PROJECT
index b2971b95..97afa1d1 100644
--- a/PROJECT
+++ b/PROJECT
@@ -1,6 +1,9 @@
 domain: toolkit.fluxcd.io
 repo: github.com/fluxcd/kustomize-controller
 resources:
+- group: kustomize
+  kind: Kustomization
+  version: v1beta2
 - group: kustomize
   kind: Kustomization
   version: v1beta1
diff --git a/api/v1beta2/condition_types.go b/api/v1beta2/condition_types.go
new file mode 100644
index 00000000..3fcc5ebd
--- /dev/null
+++ b/api/v1beta2/condition_types.go
@@ -0,0 +1,43 @@
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+package v1beta2
+
+const (
+	// HealthyCondition is the condition type used
+	// to record the last health assessment result.
+	HealthyCondition string = "Healthy"
+
+	// PruneFailedReason represents the fact that the
+	// pruning of the Kustomization failed.
+	PruneFailedReason string = "PruneFailed"
+
+	// ArtifactFailedReason represents the fact that the
+	// artifact download of the kustomization failed.
+	ArtifactFailedReason string = "ArtifactFailed"
+
+	// BuildFailedReason represents the fact that the
+	// kustomize build of the Kustomization failed.
+	BuildFailedReason string = "BuildFailed"
+
+	// HealthCheckFailedReason represents the fact that
+	// one of the health checks of the Kustomization failed.
+	HealthCheckFailedReason string = "HealthCheckFailed"
+
+	// ValidationFailedReason represents the fact that the
+	// validation of the Kustomization manifests has failed.
+	ValidationFailedReason string = "ValidationFailed"
+)
diff --git a/api/v1beta2/doc.go b/api/v1beta2/doc.go
new file mode 100644
index 00000000..209d876d
--- /dev/null
+++ b/api/v1beta2/doc.go
@@ -0,0 +1,20 @@
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+// Package v1beta2 contains API Schema definitions for the kustomize v1beta2 API group
+// +kubebuilder:object:generate=true
+// +groupName=kustomize.toolkit.fluxcd.io
+package v1beta2
diff --git a/api/v1beta2/groupversion_info.go b/api/v1beta2/groupversion_info.go
new file mode 100644
index 00000000..802205bc
--- /dev/null
+++ b/api/v1beta2/groupversion_info.go
@@ -0,0 +1,33 @@
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+package v1beta2
+
+import (
+	"k8s.io/apimachinery/pkg/runtime/schema"
+	"sigs.k8s.io/controller-runtime/pkg/scheme"
+)
+
+var (
+	// GroupVersion is group version used to register these objects
+	GroupVersion = schema.GroupVersion{Group: "kustomize.toolkit.fluxcd.io", Version: "v1beta2"}
+
+	// SchemeBuilder is used to add go types to the GroupVersionKind scheme
+	SchemeBuilder = &scheme.Builder{GroupVersion: GroupVersion}
+
+	// AddToScheme adds the types in this group-version to the given scheme.
+	AddToScheme = SchemeBuilder.AddToScheme
+)
diff --git a/api/v1beta2/inventory_types.go b/api/v1beta2/inventory_types.go
new file mode 100644
index 00000000..6c63a477
--- /dev/null
+++ b/api/v1beta2/inventory_types.go
@@ -0,0 +1,33 @@
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+package v1beta2
+
+// Inventory is a record of objects that have been reconciled.
+type Inventory struct {
+	// Entries of Kubernetes objects IDs.
+	Entries []Entry `json:"entries"`
+}
+
+// Entry contains the information necessary to locate a resource within a cluster.
+type Entry struct {
+	// ObjectID is the string representation of a Kubernetes object metadata,
+	// in the format '<namespace>_<name>_<group>_<kind>'.
+	ObjectID string `json:"id"`
+
+	// ObjectVersion is the API version of this  Kubernetes object kind.
+	ObjectVersion string `json:"ver"`
+}
diff --git a/api/v1beta2/kustomization_types.go b/api/v1beta2/kustomization_types.go
new file mode 100644
index 00000000..248a66e4
--- /dev/null
+++ b/api/v1beta2/kustomization_types.go
@@ -0,0 +1,361 @@
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+package v1beta2
+
+import (
+	"time"
+
+	apiextensionsv1 "k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/v1"
+	apimeta "k8s.io/apimachinery/pkg/api/meta"
+
+	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
+	"k8s.io/apimachinery/pkg/types"
+
+	"github.com/fluxcd/pkg/apis/kustomize"
+	"github.com/fluxcd/pkg/apis/meta"
+	"github.com/fluxcd/pkg/runtime/dependency"
+)
+
+const (
+	KustomizationController   = "kustomize-controller"
+	KustomizationKind         = "Kustomization"
+	KustomizationFinalizer    = "finalizers.fluxcd.io"
+	MaxConditionMessageLength = 20000
+	DisabledValue             = "disabled"
+)
+
+// KustomizationSpec defines the desired state of a kustomization.
+type KustomizationSpec struct {
+	// DependsOn may contain a dependency.CrossNamespaceDependencyReference slice
+	// with references to Kustomization resources that must be ready before this
+	// Kustomization can be reconciled.
+	// +optional
+	DependsOn []dependency.CrossNamespaceDependencyReference `json:"dependsOn,omitempty"`
+
+	// Decrypt Kubernetes secrets before applying them on the cluster.
+	// +optional
+	Decryption *Decryption `json:"decryption,omitempty"`
+
+	// The interval at which to reconcile the Kustomization.
+	// +required
+	Interval metav1.Duration `json:"interval"`
+
+	// The interval at which to retry a previously failed reconciliation.
+	// When not specified, the controller uses the KustomizationSpec.Interval
+	// value to retry failures.
+	// +optional
+	RetryInterval *metav1.Duration `json:"retryInterval,omitempty"`
+
+	// The KubeConfig for reconciling the Kustomization on a remote cluster.
+	// When specified, KubeConfig takes precedence over ServiceAccountName.
+	// +optional
+	KubeConfig *KubeConfig `json:"kubeConfig,omitempty"`
+
+	// Path to the directory containing the kustomization.yaml file, or the
+	// set of plain YAMLs a kustomization.yaml should be generated for.
+	// Defaults to 'None', which translates to the root path of the SourceRef.
+	// +optional
+	Path string `json:"path,omitempty"`
+
+	// PostBuild describes which actions to perform on the YAML manifest
+	// generated by building the kustomize overlay.
+	// +optional
+	PostBuild *PostBuild `json:"postBuild,omitempty"`
+
+	// Prune enables garbage collection.
+	// +required
+	Prune bool `json:"prune"`
+
+	// A list of resources to be included in the health assessment.
+	// +optional
+	HealthChecks []meta.NamespacedObjectKindReference `json:"healthChecks,omitempty"`
+
+	// Strategic merge and JSON patches, defined as inline YAML objects,
+	// capable of targeting objects based on kind, label and annotation selectors.
+	// +optional
+	Patches []kustomize.Patch `json:"patches,omitempty"`
+
+	// Strategic merge patches, defined as inline YAML objects.
+	// Deprecated: Use Patches instead.
+	// +optional
+	PatchesStrategicMerge []apiextensionsv1.JSON `json:"patchesStrategicMerge,omitempty"`
+
+	// JSON 6902 patches, defined as inline YAML objects.
+	// Deprecated: Use Patches instead.
+	// +optional
+	PatchesJSON6902 []kustomize.JSON6902Patch `json:"patchesJson6902,omitempty"`
+
+	// Images is a list of (image name, new name, new tag or digest)
+	// for changing image names, tags or digests. This can also be achieved with a
+	// patch, but this operator is simpler to specify.
+	// +optional
+	Images []kustomize.Image `json:"images,omitempty"`
+
+	// The name of the Kubernetes service account to impersonate
+	// when reconciling this Kustomization.
+	// +optional
+	ServiceAccountName string `json:"serviceAccountName,omitempty"`
+
+	// Reference of the source where the kustomization file is.
+	// +required
+	SourceRef CrossNamespaceSourceReference `json:"sourceRef"`
+
+	// This flag tells the controller to suspend subsequent kustomize executions,
+	// it does not apply to already started executions. Defaults to false.
+	// +optional
+	Suspend bool `json:"suspend,omitempty"`
+
+	// TargetNamespace sets or overrides the namespace in the
+	// kustomization.yaml file.
+	// +kubebuilder:validation:MinLength=1
+	// +kubebuilder:validation:MaxLength=63
+	// +kubebuilder:validation:Optional
+	// +optional
+	TargetNamespace string `json:"targetNamespace,omitempty"`
+
+	// Timeout for validation, apply and health checking operations.
+	// Defaults to 'Interval' duration.
+	// +optional
+	Timeout *metav1.Duration `json:"timeout,omitempty"`
+
+	// Force instructs the controller to recreate resources
+	// when patching fails due to an immutable field change.
+	// +kubebuilder:default:=false
+	// +optional
+	Force bool `json:"force,omitempty"`
+}
+
+// Decryption defines how decryption is handled for Kubernetes manifests.
+type Decryption struct {
+	// Provider is the name of the decryption engine.
+	// +kubebuilder:validation:Enum=sops
+	// +required
+	Provider string `json:"provider"`
+
+	// The secret name containing the private OpenPGP keys used for decryption.
+	// +optional
+	SecretRef *meta.LocalObjectReference `json:"secretRef,omitempty"`
+}
+
+// KubeConfig references a Kubernetes secret that contains a kubeconfig file.
+type KubeConfig struct {
+	// SecretRef holds the name to a secret that contains a 'value' key with
+	// the kubeconfig file as the value. It must be in the same namespace as
+	// the Kustomization.
+	// It is recommended that the kubeconfig is self-contained, and the secret
+	// is regularly updated if credentials such as a cloud-access-token expire.
+	// Cloud specific `cmd-path` auth helpers will not function without adding
+	// binaries and credentials to the Pod that is responsible for reconciling
+	// the Kustomization.
+	// +required
+	SecretRef meta.LocalObjectReference `json:"secretRef,omitempty"`
+}
+
+// PostBuild describes which actions to perform on the YAML manifest
+// generated by building the kustomize overlay.
+type PostBuild struct {
+	// Substitute holds a map of key/value pairs.
+	// The variables defined in your YAML manifests
+	// that match any of the keys defined in the map
+	// will be substituted with the set value.
+	// Includes support for bash string replacement functions
+	// e.g. ${var:=default}, ${var:position} and ${var/substring/replacement}.
+	// +optional
+	Substitute map[string]string `json:"substitute,omitempty"`
+
+	// SubstituteFrom holds references to ConfigMaps and Secrets containing
+	// the variables and their values to be substituted in the YAML manifests.
+	// The ConfigMap and the Secret data keys represent the var names and they
+	// must match the vars declared in the manifests for the substitution to happen.
+	// +optional
+	SubstituteFrom []SubstituteReference `json:"substituteFrom,omitempty"`
+}
+
+// SubstituteReference contains a reference to a resource containing
+// the variables name and value.
+type SubstituteReference struct {
+	// Kind of the values referent, valid values are ('Secret', 'ConfigMap').
+	// +kubebuilder:validation:Enum=Secret;ConfigMap
+	// +required
+	Kind string `json:"kind"`
+
+	// Name of the values referent. Should reside in the same namespace as the
+	// referring resource.
+	// +kubebuilder:validation:MinLength=1
+	// +kubebuilder:validation:MaxLength=253
+	// +required
+	Name string `json:"name"`
+}
+
+// KustomizationStatus defines the observed state of a kustomization.
+type KustomizationStatus struct {
+	meta.ReconcileRequestStatus `json:",inline"`
+
+	// ObservedGeneration is the last reconciled generation.
+	// +optional
+	ObservedGeneration int64 `json:"observedGeneration,omitempty"`
+
+	// +optional
+	Conditions []metav1.Condition `json:"conditions,omitempty"`
+
+	// The last successfully applied revision.
+	// The revision format for Git sources is <branch|tag>/<commit-sha>.
+	// +optional
+	LastAppliedRevision string `json:"lastAppliedRevision,omitempty"`
+
+	// LastAttemptedRevision is the revision of the last reconciliation attempt.
+	// +optional
+	LastAttemptedRevision string `json:"lastAttemptedRevision,omitempty"`
+
+	// The last successfully applied revision metadata.
+	// +optional
+	Inventory *Inventory `json:"inventory,omitempty"`
+}
+
+// KustomizationProgressing resets the conditions of the given Kustomization to a single
+// ReadyCondition with status ConditionUnknown.
+func KustomizationProgressing(k Kustomization) Kustomization {
+	meta.SetResourceCondition(&k, meta.ReadyCondition, metav1.ConditionUnknown, meta.ProgressingReason, "reconciliation in progress")
+	return k
+}
+
+// SetKustomizationHealthiness sets the HealthyCondition status for a Kustomization.
+func SetKustomizationHealthiness(k *Kustomization, status metav1.ConditionStatus, reason, message string) {
+	switch len(k.Spec.HealthChecks) {
+	case 0:
+		apimeta.RemoveStatusCondition(k.GetStatusConditions(), HealthyCondition)
+	default:
+		meta.SetResourceCondition(k, HealthyCondition, status, reason, trimString(message, MaxConditionMessageLength))
+	}
+}
+
+// SetKustomizationReadiness sets the ReadyCondition, ObservedGeneration, and LastAttemptedRevision, on the Kustomization.
+func SetKustomizationReadiness(k *Kustomization, status metav1.ConditionStatus, reason, message string, revision string) {
+	meta.SetResourceCondition(k, meta.ReadyCondition, status, reason, trimString(message, MaxConditionMessageLength))
+	k.Status.ObservedGeneration = k.Generation
+	k.Status.LastAttemptedRevision = revision
+}
+
+// KustomizationNotReady registers a failed apply attempt of the given Kustomization.
+func KustomizationNotReady(k Kustomization, revision, reason, message string) Kustomization {
+	SetKustomizationReadiness(&k, metav1.ConditionFalse, reason, trimString(message, MaxConditionMessageLength), revision)
+	if revision != "" {
+		k.Status.LastAttemptedRevision = revision
+	}
+	return k
+}
+
+// KustomizationNotReadyInventory registers a failed apply attempt of the given Kustomization.
+func KustomizationNotReadyInventory(k Kustomization, inventory *Inventory, revision, reason, message string) Kustomization {
+	SetKustomizationReadiness(&k, metav1.ConditionFalse, reason, trimString(message, MaxConditionMessageLength), revision)
+	SetKustomizationHealthiness(&k, metav1.ConditionTrue, reason, reason)
+	if revision != "" {
+		k.Status.LastAttemptedRevision = revision
+	}
+	k.Status.Inventory = inventory
+	return k
+}
+
+// KustomizationReadyInventory registers a successful apply attempt of the given Kustomization.
+func KustomizationReadyInventory(k Kustomization, inventory *Inventory, revision, reason, message string) Kustomization {
+	SetKustomizationReadiness(&k, metav1.ConditionTrue, reason, trimString(message, MaxConditionMessageLength), revision)
+	SetKustomizationHealthiness(&k, metav1.ConditionTrue, reason, reason)
+	k.Status.Inventory = inventory
+	k.Status.LastAppliedRevision = revision
+	return k
+}
+
+// GetTimeout returns the timeout with default.
+func (in Kustomization) GetTimeout() time.Duration {
+	duration := in.Spec.Interval.Duration - 30*time.Second
+	if in.Spec.Timeout != nil {
+		duration = in.Spec.Timeout.Duration
+	}
+	if duration < 30*time.Second {
+		return 30 * time.Second
+	}
+	return duration
+}
+
+// GetRetryInterval returns the retry interval
+func (in Kustomization) GetRetryInterval() time.Duration {
+	if in.Spec.RetryInterval != nil {
+		return in.Spec.RetryInterval.Duration
+	}
+	return in.Spec.Interval.Duration
+}
+
+// GetDependsOn returns the list of dependencies across-namespaces.
+func (in Kustomization) GetDependsOn() (types.NamespacedName, []dependency.CrossNamespaceDependencyReference) {
+	return types.NamespacedName{
+		Namespace: in.Namespace,
+		Name:      in.Name,
+	}, in.Spec.DependsOn
+}
+
+// GetStatusConditions returns a pointer to the Status.Conditions slice.
+func (in *Kustomization) GetStatusConditions() *[]metav1.Condition {
+	return &in.Status.Conditions
+}
+
+const (
+	// GitRepositoryIndexKey is the key used for indexing kustomizations based on their Git sources.
+	GitRepositoryIndexKey string = ".metadata.gitRepository"
+	// BucketIndexKey is the key used for indexing kustomizations based on their S3 sources.
+	BucketIndexKey string = ".metadata.bucket"
+)
+
+// +genclient
+// +genclient:Namespaced
+// +kubebuilder:storageversion
+// +kubebuilder:object:root=true
+// +kubebuilder:resource:shortName=ks
+// +kubebuilder:subresource:status
+// +kubebuilder:printcolumn:name="Ready",type="string",JSONPath=".status.conditions[?(@.type==\"Ready\")].status",description=""
+// +kubebuilder:printcolumn:name="Status",type="string",JSONPath=".status.conditions[?(@.type==\"Ready\")].message",description=""
+// +kubebuilder:printcolumn:name="Age",type="date",JSONPath=".metadata.creationTimestamp",description=""
+
+// Kustomization is the Schema for the kustomizations API.
+type Kustomization struct {
+	metav1.TypeMeta   `json:",inline"`
+	metav1.ObjectMeta `json:"metadata,omitempty"`
+
+	Spec KustomizationSpec `json:"spec,omitempty"`
+	// +kubebuilder:default:={"observedGeneration":-1}
+	Status KustomizationStatus `json:"status,omitempty"`
+}
+
+// +kubebuilder:object:root=true
+
+// KustomizationList contains a list of kustomizations.
+type KustomizationList struct {
+	metav1.TypeMeta `json:",inline"`
+	metav1.ListMeta `json:"metadata,omitempty"`
+	Items           []Kustomization `json:"items"`
+}
+
+func init() {
+	SchemeBuilder.Register(&Kustomization{}, &KustomizationList{})
+}
+
+func trimString(str string, limit int) string {
+	if len(str) <= limit {
+		return str
+	}
+
+	return str[0:limit] + "..."
+}
diff --git a/api/v1beta2/reference_types.go b/api/v1beta2/reference_types.go
new file mode 100644
index 00000000..bb069114
--- /dev/null
+++ b/api/v1beta2/reference_types.go
@@ -0,0 +1,47 @@
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+package v1beta2
+
+import "fmt"
+
+// CrossNamespaceSourceReference contains enough information to let you locate the
+// typed referenced object at cluster level
+type CrossNamespaceSourceReference struct {
+	// API version of the referent
+	// +optional
+	APIVersion string `json:"apiVersion,omitempty"`
+
+	// Kind of the referent
+	// +kubebuilder:validation:Enum=GitRepository;Bucket
+	// +required
+	Kind string `json:"kind"`
+
+	// Name of the referent
+	// +required
+	Name string `json:"name"`
+
+	// Namespace of the referent, defaults to the Kustomization namespace
+	// +optional
+	Namespace string `json:"namespace,omitempty"`
+}
+
+func (s *CrossNamespaceSourceReference) String() string {
+	if s.Namespace != "" {
+		return fmt.Sprintf("%s/%s/%s", s.Kind, s.Namespace, s.Name)
+	}
+	return fmt.Sprintf("%s/%s", s.Kind, s.Name)
+}
diff --git a/api/v1beta2/zz_generated.deepcopy.go b/api/v1beta2/zz_generated.deepcopy.go
new file mode 100644
index 00000000..e6a5db62
--- /dev/null
+++ b/api/v1beta2/zz_generated.deepcopy.go
@@ -0,0 +1,321 @@
+// +build !ignore_autogenerated
+
+/*
+Copyright 2021 The Flux authors
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+*/
+
+// Code generated by controller-gen. DO NOT EDIT.
+
+package v1beta2
+
+import (
+	"github.com/fluxcd/pkg/apis/kustomize"
+	"github.com/fluxcd/pkg/apis/meta"
+	"github.com/fluxcd/pkg/runtime/dependency"
+	apiextensionsv1 "k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/v1"
+	"k8s.io/apimachinery/pkg/apis/meta/v1"
+	runtime "k8s.io/apimachinery/pkg/runtime"
+)
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *CrossNamespaceSourceReference) DeepCopyInto(out *CrossNamespaceSourceReference) {
+	*out = *in
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new CrossNamespaceSourceReference.
+func (in *CrossNamespaceSourceReference) DeepCopy() *CrossNamespaceSourceReference {
+	if in == nil {
+		return nil
+	}
+	out := new(CrossNamespaceSourceReference)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *Decryption) DeepCopyInto(out *Decryption) {
+	*out = *in
+	if in.SecretRef != nil {
+		in, out := &in.SecretRef, &out.SecretRef
+		*out = new(meta.LocalObjectReference)
+		**out = **in
+	}
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Decryption.
+func (in *Decryption) DeepCopy() *Decryption {
+	if in == nil {
+		return nil
+	}
+	out := new(Decryption)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *Entry) DeepCopyInto(out *Entry) {
+	*out = *in
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Entry.
+func (in *Entry) DeepCopy() *Entry {
+	if in == nil {
+		return nil
+	}
+	out := new(Entry)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *Inventory) DeepCopyInto(out *Inventory) {
+	*out = *in
+	if in.Entries != nil {
+		in, out := &in.Entries, &out.Entries
+		*out = make([]Entry, len(*in))
+		copy(*out, *in)
+	}
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Inventory.
+func (in *Inventory) DeepCopy() *Inventory {
+	if in == nil {
+		return nil
+	}
+	out := new(Inventory)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *KubeConfig) DeepCopyInto(out *KubeConfig) {
+	*out = *in
+	out.SecretRef = in.SecretRef
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new KubeConfig.
+func (in *KubeConfig) DeepCopy() *KubeConfig {
+	if in == nil {
+		return nil
+	}
+	out := new(KubeConfig)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *Kustomization) DeepCopyInto(out *Kustomization) {
+	*out = *in
+	out.TypeMeta = in.TypeMeta
+	in.ObjectMeta.DeepCopyInto(&out.ObjectMeta)
+	in.Spec.DeepCopyInto(&out.Spec)
+	in.Status.DeepCopyInto(&out.Status)
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Kustomization.
+func (in *Kustomization) DeepCopy() *Kustomization {
+	if in == nil {
+		return nil
+	}
+	out := new(Kustomization)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyObject is an autogenerated deepcopy function, copying the receiver, creating a new runtime.Object.
+func (in *Kustomization) DeepCopyObject() runtime.Object {
+	if c := in.DeepCopy(); c != nil {
+		return c
+	}
+	return nil
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *KustomizationList) DeepCopyInto(out *KustomizationList) {
+	*out = *in
+	out.TypeMeta = in.TypeMeta
+	in.ListMeta.DeepCopyInto(&out.ListMeta)
+	if in.Items != nil {
+		in, out := &in.Items, &out.Items
+		*out = make([]Kustomization, len(*in))
+		for i := range *in {
+			(*in)[i].DeepCopyInto(&(*out)[i])
+		}
+	}
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new KustomizationList.
+func (in *KustomizationList) DeepCopy() *KustomizationList {
+	if in == nil {
+		return nil
+	}
+	out := new(KustomizationList)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyObject is an autogenerated deepcopy function, copying the receiver, creating a new runtime.Object.
+func (in *KustomizationList) DeepCopyObject() runtime.Object {
+	if c := in.DeepCopy(); c != nil {
+		return c
+	}
+	return nil
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *KustomizationSpec) DeepCopyInto(out *KustomizationSpec) {
+	*out = *in
+	if in.DependsOn != nil {
+		in, out := &in.DependsOn, &out.DependsOn
+		*out = make([]dependency.CrossNamespaceDependencyReference, len(*in))
+		copy(*out, *in)
+	}
+	if in.Decryption != nil {
+		in, out := &in.Decryption, &out.Decryption
+		*out = new(Decryption)
+		(*in).DeepCopyInto(*out)
+	}
+	out.Interval = in.Interval
+	if in.RetryInterval != nil {
+		in, out := &in.RetryInterval, &out.RetryInterval
+		*out = new(v1.Duration)
+		**out = **in
+	}
+	if in.KubeConfig != nil {
+		in, out := &in.KubeConfig, &out.KubeConfig
+		*out = new(KubeConfig)
+		**out = **in
+	}
+	if in.PostBuild != nil {
+		in, out := &in.PostBuild, &out.PostBuild
+		*out = new(PostBuild)
+		(*in).DeepCopyInto(*out)
+	}
+	if in.HealthChecks != nil {
+		in, out := &in.HealthChecks, &out.HealthChecks
+		*out = make([]meta.NamespacedObjectKindReference, len(*in))
+		copy(*out, *in)
+	}
+	if in.Patches != nil {
+		in, out := &in.Patches, &out.Patches
+		*out = make([]kustomize.Patch, len(*in))
+		copy(*out, *in)
+	}
+	if in.PatchesStrategicMerge != nil {
+		in, out := &in.PatchesStrategicMerge, &out.PatchesStrategicMerge
+		*out = make([]apiextensionsv1.JSON, len(*in))
+		for i := range *in {
+			(*in)[i].DeepCopyInto(&(*out)[i])
+		}
+	}
+	if in.PatchesJSON6902 != nil {
+		in, out := &in.PatchesJSON6902, &out.PatchesJSON6902
+		*out = make([]kustomize.JSON6902Patch, len(*in))
+		for i := range *in {
+			(*in)[i].DeepCopyInto(&(*out)[i])
+		}
+	}
+	if in.Images != nil {
+		in, out := &in.Images, &out.Images
+		*out = make([]kustomize.Image, len(*in))
+		copy(*out, *in)
+	}
+	out.SourceRef = in.SourceRef
+	if in.Timeout != nil {
+		in, out := &in.Timeout, &out.Timeout
+		*out = new(v1.Duration)
+		**out = **in
+	}
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new KustomizationSpec.
+func (in *KustomizationSpec) DeepCopy() *KustomizationSpec {
+	if in == nil {
+		return nil
+	}
+	out := new(KustomizationSpec)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *KustomizationStatus) DeepCopyInto(out *KustomizationStatus) {
+	*out = *in
+	out.ReconcileRequestStatus = in.ReconcileRequestStatus
+	if in.Conditions != nil {
+		in, out := &in.Conditions, &out.Conditions
+		*out = make([]v1.Condition, len(*in))
+		for i := range *in {
+			(*in)[i].DeepCopyInto(&(*out)[i])
+		}
+	}
+	if in.Inventory != nil {
+		in, out := &in.Inventory, &out.Inventory
+		*out = new(Inventory)
+		(*in).DeepCopyInto(*out)
+	}
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new KustomizationStatus.
+func (in *KustomizationStatus) DeepCopy() *KustomizationStatus {
+	if in == nil {
+		return nil
+	}
+	out := new(KustomizationStatus)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *PostBuild) DeepCopyInto(out *PostBuild) {
+	*out = *in
+	if in.Substitute != nil {
+		in, out := &in.Substitute, &out.Substitute
+		*out = make(map[string]string, len(*in))
+		for key, val := range *in {
+			(*out)[key] = val
+		}
+	}
+	if in.SubstituteFrom != nil {
+		in, out := &in.SubstituteFrom, &out.SubstituteFrom
+		*out = make([]SubstituteReference, len(*in))
+		copy(*out, *in)
+	}
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new PostBuild.
+func (in *PostBuild) DeepCopy() *PostBuild {
+	if in == nil {
+		return nil
+	}
+	out := new(PostBuild)
+	in.DeepCopyInto(out)
+	return out
+}
+
+// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
+func (in *SubstituteReference) DeepCopyInto(out *SubstituteReference) {
+	*out = *in
+}
+
+// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new SubstituteReference.
+func (in *SubstituteReference) DeepCopy() *SubstituteReference {
+	if in == nil {
+		return nil
+	}
+	out := new(SubstituteReference)
+	in.DeepCopyInto(out)
+	return out
+}
diff --git a/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml b/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
index a1654447..c278c1ec 100644
--- a/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
+++ b/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
@@ -420,6 +420,399 @@ spec:
             type: object
         type: object
     served: true
+    storage: false
+    subresources:
+      status: {}
+  - additionalPrinterColumns:
+    - jsonPath: .status.conditions[?(@.type=="Ready")].status
+      name: Ready
+      type: string
+    - jsonPath: .status.conditions[?(@.type=="Ready")].message
+      name: Status
+      type: string
+    - jsonPath: .metadata.creationTimestamp
+      name: Age
+      type: date
+    name: v1beta2
+    schema:
+      openAPIV3Schema:
+        description: Kustomization is the Schema for the kustomizations API.
+        properties:
+          apiVersion:
+            description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
+            type: string
+          kind:
+            description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
+            type: string
+          metadata:
+            type: object
+          spec:
+            description: KustomizationSpec defines the desired state of a kustomization.
+            properties:
+              decryption:
+                description: Decrypt Kubernetes secrets before applying them on the cluster.
+                properties:
+                  provider:
+                    description: Provider is the name of the decryption engine.
+                    enum:
+                    - sops
+                    type: string
+                  secretRef:
+                    description: The secret name containing the private OpenPGP keys used for decryption.
+                    properties:
+                      name:
+                        description: Name of the referent
+                        type: string
+                    required:
+                    - name
+                    type: object
+                required:
+                - provider
+                type: object
+              dependsOn:
+                description: DependsOn may contain a dependency.CrossNamespaceDependencyReference slice with references to Kustomization resources that must be ready before this Kustomization can be reconciled.
+                items:
+                  description: CrossNamespaceDependencyReference holds the reference to a dependency.
+                  properties:
+                    name:
+                      description: Name holds the name reference of a dependency.
+                      type: string
+                    namespace:
+                      description: Namespace holds the namespace reference of a dependency.
+                      type: string
+                  required:
+                  - name
+                  type: object
+                type: array
+              force:
+                default: false
+                description: Force instructs the controller to recreate resources when patching fails due to an immutable field change.
+                type: boolean
+              healthChecks:
+                description: A list of resources to be included in the health assessment.
+                items:
+                  description: NamespacedObjectKindReference contains enough information to let you locate the typed referenced object in any namespace
+                  properties:
+                    apiVersion:
+                      description: API version of the referent, if not specified the Kubernetes preferred version will be used
+                      type: string
+                    kind:
+                      description: Kind of the referent
+                      type: string
+                    name:
+                      description: Name of the referent
+                      type: string
+                    namespace:
+                      description: Namespace of the referent, when not specified it acts as LocalObjectReference
+                      type: string
+                  required:
+                  - kind
+                  - name
+                  type: object
+                type: array
+              images:
+                description: Images is a list of (image name, new name, new tag or digest) for changing image names, tags or digests. This can also be achieved with a patch, but this operator is simpler to specify.
+                items:
+                  description: Image contains an image name, a new name, a new tag or digest, which will replace the original name and tag.
+                  properties:
+                    digest:
+                      description: Digest is the value used to replace the original image tag. If digest is present NewTag value is ignored.
+                      type: string
+                    name:
+                      description: Name is a tag-less image name.
+                      type: string
+                    newName:
+                      description: NewName is the value used to replace the original name.
+                      type: string
+                    newTag:
+                      description: NewTag is the value used to replace the original tag.
+                      type: string
+                  required:
+                  - name
+                  type: object
+                type: array
+              interval:
+                description: The interval at which to reconcile the Kustomization.
+                type: string
+              kubeConfig:
+                description: The KubeConfig for reconciling the Kustomization on a remote cluster. When specified, KubeConfig takes precedence over ServiceAccountName.
+                properties:
+                  secretRef:
+                    description: SecretRef holds the name to a secret that contains a 'value' key with the kubeconfig file as the value. It must be in the same namespace as the Kustomization. It is recommended that the kubeconfig is self-contained, and the secret is regularly updated if credentials such as a cloud-access-token expire. Cloud specific `cmd-path` auth helpers will not function without adding binaries and credentials to the Pod that is responsible for reconciling the Kustomization.
+                    properties:
+                      name:
+                        description: Name of the referent
+                        type: string
+                    required:
+                    - name
+                    type: object
+                type: object
+              patches:
+                description: Strategic merge and JSON patches, defined as inline YAML objects, capable of targeting objects based on kind, label and annotation selectors.
+                items:
+                  description: Patch contains either a StrategicMerge or a JSON6902 patch, either a file or inline, and the target the patch should be applied to.
+                  properties:
+                    patch:
+                      description: Patch contains the JSON6902 patch document with an array of operation objects.
+                      type: string
+                    target:
+                      description: Target points to the resources that the patch document should be applied to.
+                      properties:
+                        annotationSelector:
+                          description: AnnotationSelector is a string that follows the label selection expression https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#api It matches with the resource annotations.
+                          type: string
+                        group:
+                          description: Group is the API group to select resources from. Together with Version and Kind it is capable of unambiguously identifying and/or selecting resources. https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/api-group.md
+                          type: string
+                        kind:
+                          description: Kind of the API Group to select resources from. Together with Group and Version it is capable of unambiguously identifying and/or selecting resources. https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/api-group.md
+                          type: string
+                        labelSelector:
+                          description: LabelSelector is a string that follows the label selection expression https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#api It matches with the resource labels.
+                          type: string
+                        name:
+                          description: Name to match resources with.
+                          type: string
+                        namespace:
+                          description: Namespace to select resources from.
+                          type: string
+                        version:
+                          description: Version of the API Group to select resources from. Together with Group and Kind it is capable of unambiguously identifying and/or selecting resources. https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/api-group.md
+                          type: string
+                      type: object
+                  type: object
+                type: array
+              patchesJson6902:
+                description: 'JSON 6902 patches, defined as inline YAML objects. Deprecated: Use Patches instead.'
+                items:
+                  description: JSON6902Patch contains a JSON6902 patch and the target the patch should be applied to.
+                  properties:
+                    patch:
+                      description: Patch contains the JSON6902 patch document with an array of operation objects.
+                      items:
+                        description: JSON6902 is a JSON6902 operation object. https://tools.ietf.org/html/rfc6902#section-4
+                        properties:
+                          from:
+                            type: string
+                          op:
+                            enum:
+                            - test
+                            - remove
+                            - add
+                            - replace
+                            - move
+                            - copy
+                            type: string
+                          path:
+                            type: string
+                          value:
+                            x-kubernetes-preserve-unknown-fields: true
+                        required:
+                        - op
+                        - path
+                        type: object
+                      type: array
+                    target:
+                      description: Target points to the resources that the patch document should be applied to.
+                      properties:
+                        annotationSelector:
+                          description: AnnotationSelector is a string that follows the label selection expression https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#api It matches with the resource annotations.
+                          type: string
+                        group:
+                          description: Group is the API group to select resources from. Together with Version and Kind it is capable of unambiguously identifying and/or selecting resources. https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/api-group.md
+                          type: string
+                        kind:
+                          description: Kind of the API Group to select resources from. Together with Group and Version it is capable of unambiguously identifying and/or selecting resources. https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/api-group.md
+                          type: string
+                        labelSelector:
+                          description: LabelSelector is a string that follows the label selection expression https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#api It matches with the resource labels.
+                          type: string
+                        name:
+                          description: Name to match resources with.
+                          type: string
+                        namespace:
+                          description: Namespace to select resources from.
+                          type: string
+                        version:
+                          description: Version of the API Group to select resources from. Together with Group and Kind it is capable of unambiguously identifying and/or selecting resources. https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/api-group.md
+                          type: string
+                      type: object
+                  required:
+                  - patch
+                  - target
+                  type: object
+                type: array
+              patchesStrategicMerge:
+                description: 'Strategic merge patches, defined as inline YAML objects. Deprecated: Use Patches instead.'
+                items:
+                  x-kubernetes-preserve-unknown-fields: true
+                type: array
+              path:
+                description: Path to the directory containing the kustomization.yaml file, or the set of plain YAMLs a kustomization.yaml should be generated for. Defaults to 'None', which translates to the root path of the SourceRef.
+                type: string
+              postBuild:
+                description: PostBuild describes which actions to perform on the YAML manifest generated by building the kustomize overlay.
+                properties:
+                  substitute:
+                    additionalProperties:
+                      type: string
+                    description: Substitute holds a map of key/value pairs. The variables defined in your YAML manifests that match any of the keys defined in the map will be substituted with the set value. Includes support for bash string replacement functions e.g. ${var:=default}, ${var:position} and ${var/substring/replacement}.
+                    type: object
+                  substituteFrom:
+                    description: SubstituteFrom holds references to ConfigMaps and Secrets containing the variables and their values to be substituted in the YAML manifests. The ConfigMap and the Secret data keys represent the var names and they must match the vars declared in the manifests for the substitution to happen.
+                    items:
+                      description: SubstituteReference contains a reference to a resource containing the variables name and value.
+                      properties:
+                        kind:
+                          description: Kind of the values referent, valid values are ('Secret', 'ConfigMap').
+                          enum:
+                          - Secret
+                          - ConfigMap
+                          type: string
+                        name:
+                          description: Name of the values referent. Should reside in the same namespace as the referring resource.
+                          maxLength: 253
+                          minLength: 1
+                          type: string
+                      required:
+                      - kind
+                      - name
+                      type: object
+                    type: array
+                type: object
+              prune:
+                description: Prune enables garbage collection.
+                type: boolean
+              retryInterval:
+                description: The interval at which to retry a previously failed reconciliation. When not specified, the controller uses the KustomizationSpec.Interval value to retry failures.
+                type: string
+              serviceAccountName:
+                description: The name of the Kubernetes service account to impersonate when reconciling this Kustomization.
+                type: string
+              sourceRef:
+                description: Reference of the source where the kustomization file is.
+                properties:
+                  apiVersion:
+                    description: API version of the referent
+                    type: string
+                  kind:
+                    description: Kind of the referent
+                    enum:
+                    - GitRepository
+                    - Bucket
+                    type: string
+                  name:
+                    description: Name of the referent
+                    type: string
+                  namespace:
+                    description: Namespace of the referent, defaults to the Kustomization namespace
+                    type: string
+                required:
+                - kind
+                - name
+                type: object
+              suspend:
+                description: This flag tells the controller to suspend subsequent kustomize executions, it does not apply to already started executions. Defaults to false.
+                type: boolean
+              targetNamespace:
+                description: TargetNamespace sets or overrides the namespace in the kustomization.yaml file.
+                maxLength: 63
+                minLength: 1
+                type: string
+              timeout:
+                description: Timeout for validation, apply and health checking operations. Defaults to 'Interval' duration.
+                type: string
+            required:
+            - interval
+            - prune
+            - sourceRef
+            type: object
+          status:
+            default:
+              observedGeneration: -1
+            description: KustomizationStatus defines the observed state of a kustomization.
+            properties:
+              conditions:
+                items:
+                  description: "Condition contains details for one aspect of the current state of this API Resource. --- This struct is intended for direct use as an array at the field path .status.conditions.  For example, type FooStatus struct{     // Represents the observations of a foo's current state.     // Known .status.conditions.type are: \"Available\", \"Progressing\", and \"Degraded\"     // +patchMergeKey=type     // +patchStrategy=merge     // +listType=map     // +listMapKey=type     Conditions []metav1.Condition `json:\"conditions,omitempty\" patchStrategy:\"merge\" patchMergeKey:\"type\" protobuf:\"bytes,1,rep,name=conditions\"` \n     // other fields }"
+                  properties:
+                    lastTransitionTime:
+                      description: lastTransitionTime is the last time the condition transitioned from one status to another. This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
+                      format: date-time
+                      type: string
+                    message:
+                      description: message is a human readable message indicating details about the transition. This may be an empty string.
+                      maxLength: 32768
+                      type: string
+                    observedGeneration:
+                      description: observedGeneration represents the .metadata.generation that the condition was set based upon. For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date with respect to the current state of the instance.
+                      format: int64
+                      minimum: 0
+                      type: integer
+                    reason:
+                      description: reason contains a programmatic identifier indicating the reason for the condition's last transition. Producers of specific condition types may define expected values and meanings for this field, and whether the values are considered a guaranteed API. The value should be a CamelCase string. This field may not be empty.
+                      maxLength: 1024
+                      minLength: 1
+                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
+                      type: string
+                    status:
+                      description: status of the condition, one of True, False, Unknown.
+                      enum:
+                      - "True"
+                      - "False"
+                      - Unknown
+                      type: string
+                    type:
+                      description: type of condition in CamelCase or in foo.example.com/CamelCase. --- Many .condition.type values are consistent across resources like Available, but because arbitrary conditions can be useful (see .node.status.conditions), the ability to deconflict is important. The regex it matches is (dns1123SubdomainFmt/)?(qualifiedNameFmt)
+                      maxLength: 316
+                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
+                      type: string
+                  required:
+                  - lastTransitionTime
+                  - message
+                  - reason
+                  - status
+                  - type
+                  type: object
+                type: array
+              inventory:
+                description: The last successfully applied revision metadata.
+                properties:
+                  entries:
+                    description: Entries of Kubernetes objects IDs.
+                    items:
+                      description: Entry contains the information necessary to locate a resource within a cluster.
+                      properties:
+                        id:
+                          description: ObjectID is the string representation of a Kubernetes object metadata, in the format '<namespace>_<name>_<group>_<kind>'.
+                          type: string
+                        ver:
+                          description: ObjectVersion is the API version of this  Kubernetes object kind.
+                          type: string
+                      required:
+                      - id
+                      - ver
+                      type: object
+                    type: array
+                required:
+                - entries
+                type: object
+              lastAppliedRevision:
+                description: The last successfully applied revision. The revision format for Git sources is <branch|tag>/<commit-sha>.
+                type: string
+              lastAttemptedRevision:
+                description: LastAttemptedRevision is the revision of the last reconciliation attempt.
+                type: string
+              lastHandledReconcileAt:
+                description: LastHandledReconcileAt holds the value of the most recent reconcile request value, so a change can be detected.
+                type: string
+              observedGeneration:
+                description: ObservedGeneration is the last reconciled generation.
+                format: int64
+                type: integer
+            type: object
+        type: object
+    served: true
     storage: true
     subresources:
       status: {}
diff --git a/config/kubeconfig b/config/kubeconfig
deleted file mode 100644
index 3911d1ab..00000000
--- a/config/kubeconfig
+++ /dev/null
@@ -1,12 +0,0 @@
-apiVersion: v1
-clusters: []
-contexts:
-- context:
-    cluster: ""
-    namespace: default
-    user: ""
-  name: default
-current-context: default
-kind: Config
-preferences: {}
-users: []
diff --git a/docs/api/kustomize.md b/docs/api/kustomize.md
index 544b52c9..dbc6ea0b 100644
--- a/docs/api/kustomize.md
+++ b/docs/api/kustomize.md
@@ -2,16 +2,16 @@
 <p>Packages:</p>
 <ul class="simple">
 <li>
-<a href="#kustomize.toolkit.fluxcd.io%2fv1beta1">kustomize.toolkit.fluxcd.io/v1beta1</a>
+<a href="#kustomize.toolkit.fluxcd.io%2fv1beta2">kustomize.toolkit.fluxcd.io/v1beta2</a>
 </li>
 </ul>
-<h2 id="kustomize.toolkit.fluxcd.io/v1beta1">kustomize.toolkit.fluxcd.io/v1beta1</h2>
-<p>Package v1beta1 contains API Schema definitions for the kustomize v1beta1 API group</p>
+<h2 id="kustomize.toolkit.fluxcd.io/v1beta2">kustomize.toolkit.fluxcd.io/v1beta2</h2>
+<p>Package v1beta2 contains API Schema definitions for the kustomize v1beta2 API group</p>
 Resource Types:
 <ul class="simple"><li>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Kustomization">Kustomization</a>
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Kustomization">Kustomization</a>
 </li></ul>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.Kustomization">Kustomization
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.Kustomization">Kustomization
 </h3>
 <p>Kustomization is the Schema for the kustomizations API.</p>
 <div class="md-typeset__scrollwrap">
@@ -29,7 +29,7 @@ Resource Types:
 <code>apiVersion</code><br>
 string</td>
 <td>
-<code>kustomize.toolkit.fluxcd.io/v1beta1</code>
+<code>kustomize.toolkit.fluxcd.io/v1beta2</code>
 </td>
 </tr>
 <tr>
@@ -59,7 +59,7 @@ Refer to the Kubernetes API documentation for the fields of the
 <td>
 <code>spec</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationSpec">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationSpec">
 KustomizationSpec
 </a>
 </em>
@@ -88,7 +88,7 @@ Kustomization can be reconciled.</p>
 <td>
 <code>decryption</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Decryption">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Decryption">
 Decryption
 </a>
 </em>
@@ -131,7 +131,7 @@ value to retry failures.</p>
 <td>
 <code>kubeConfig</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KubeConfig">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KubeConfig">
 KubeConfig
 </a>
 </em>
@@ -160,7 +160,7 @@ Defaults to &lsquo;None&rsquo;, which translates to the root path of the SourceR
 <td>
 <code>postBuild</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.PostBuild">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.PostBuild">
 PostBuild
 </a>
 </em>
@@ -222,7 +222,8 @@ capable of targeting objects based on kind, label and annotation selectors.</p>
 </td>
 <td>
 <em>(Optional)</em>
-<p>Strategic merge patches, defined as inline YAML objects.</p>
+<p>Strategic merge patches, defined as inline YAML objects.
+Deprecated: Use Patches instead.</p>
 </td>
 </tr>
 <tr>
@@ -236,7 +237,8 @@ capable of targeting objects based on kind, label and annotation selectors.</p>
 </td>
 <td>
 <em>(Optional)</em>
-<p>JSON 6902 patches, defined as inline YAML objects.</p>
+<p>JSON 6902 patches, defined as inline YAML objects.
+Deprecated: Use Patches instead.</p>
 </td>
 </tr>
 <tr>
@@ -272,7 +274,7 @@ when reconciling this Kustomization.</p>
 <td>
 <code>sourceRef</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.CrossNamespaceSourceReference">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.CrossNamespaceSourceReference">
 CrossNamespaceSourceReference
 </a>
 </em>
@@ -324,22 +326,6 @@ Defaults to &lsquo;Interval&rsquo; duration.</p>
 </tr>
 <tr>
 <td>
-<code>validation</code><br>
-<em>
-string
-</em>
-</td>
-<td>
-<em>(Optional)</em>
-<p>Validate the Kubernetes objects before applying them on the cluster.
-The validation strategy can be &lsquo;client&rsquo; (local dry-run), &lsquo;server&rsquo;
-(APIServer dry-run) or &lsquo;none&rsquo;.
-When &lsquo;Force&rsquo; is &lsquo;true&rsquo;, validation will fallback to &lsquo;client&rsquo; if set to
-&lsquo;server&rsquo; because server-side validation is not supported in this scenario.</p>
-</td>
-</tr>
-<tr>
-<td>
 <code>force</code><br>
 <em>
 bool
@@ -358,7 +344,7 @@ when patching fails due to an immutable field change.</p>
 <td>
 <code>status</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationStatus">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationStatus">
 KustomizationStatus
 </a>
 </em>
@@ -370,11 +356,11 @@ KustomizationStatus
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.CrossNamespaceSourceReference">CrossNamespaceSourceReference
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.CrossNamespaceSourceReference">CrossNamespaceSourceReference
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationSpec">KustomizationSpec</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationSpec">KustomizationSpec</a>)
 </p>
 <p>CrossNamespaceSourceReference contains enough information to let you locate the
 typed referenced object at cluster level</p>
@@ -438,11 +424,11 @@ string
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.Decryption">Decryption
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.Decryption">Decryption
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationSpec">KustomizationSpec</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationSpec">KustomizationSpec</a>)
 </p>
 <p>Decryption defines how decryption is handled for Kubernetes manifests.</p>
 <div class="md-typeset__scrollwrap">
@@ -484,11 +470,89 @@ github.com/fluxcd/pkg/apis/meta.LocalObjectReference
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.KubeConfig">KubeConfig
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.Entry">Entry
+</h3>
+<p>
+(<em>Appears on:</em>
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Inventory">Inventory</a>)
+</p>
+<p>Entry contains the information necessary to locate a resource within a cluster.</p>
+<div class="md-typeset__scrollwrap">
+<div class="md-typeset__table">
+<table>
+<thead>
+<tr>
+<th>Field</th>
+<th>Description</th>
+</tr>
+</thead>
+<tbody>
+<tr>
+<td>
+<code>id</code><br>
+<em>
+string
+</em>
+</td>
+<td>
+<p>ObjectID is the string representation of a Kubernetes object metadata,
+in the format &lsquo;<namespace><em><name></em><group>_<kind>&rsquo;.</p>
+</td>
+</tr>
+<tr>
+<td>
+<code>ver</code><br>
+<em>
+string
+</em>
+</td>
+<td>
+<p>ObjectVersion is the API version of this  Kubernetes object kind.</p>
+</td>
+</tr>
+</tbody>
+</table>
+</div>
+</div>
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.Inventory">Inventory
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationSpec">KustomizationSpec</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationStatus">KustomizationStatus</a>)
+</p>
+<p>Inventory is a record of objects that have been reconciled.</p>
+<div class="md-typeset__scrollwrap">
+<div class="md-typeset__table">
+<table>
+<thead>
+<tr>
+<th>Field</th>
+<th>Description</th>
+</tr>
+</thead>
+<tbody>
+<tr>
+<td>
+<code>entries</code><br>
+<em>
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Entry">
+[]Entry
+</a>
+</em>
+</td>
+<td>
+<p>Entries of Kubernetes objects IDs.</p>
+</td>
+</tr>
+</tbody>
+</table>
+</div>
+</div>
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.KubeConfig">KubeConfig
+</h3>
+<p>
+(<em>Appears on:</em>
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationSpec">KustomizationSpec</a>)
 </p>
 <p>KubeConfig references a Kubernetes secret that contains a kubeconfig file.</p>
 <div class="md-typeset__scrollwrap">
@@ -525,11 +589,11 @@ the Kustomization.</p>
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.KustomizationSpec">KustomizationSpec
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.KustomizationSpec">KustomizationSpec
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Kustomization">Kustomization</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Kustomization">Kustomization</a>)
 </p>
 <p>KustomizationSpec defines the desired state of a kustomization.</p>
 <div class="md-typeset__scrollwrap">
@@ -562,7 +626,7 @@ Kustomization can be reconciled.</p>
 <td>
 <code>decryption</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Decryption">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Decryption">
 Decryption
 </a>
 </em>
@@ -605,7 +669,7 @@ value to retry failures.</p>
 <td>
 <code>kubeConfig</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KubeConfig">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KubeConfig">
 KubeConfig
 </a>
 </em>
@@ -634,7 +698,7 @@ Defaults to &lsquo;None&rsquo;, which translates to the root path of the SourceR
 <td>
 <code>postBuild</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.PostBuild">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.PostBuild">
 PostBuild
 </a>
 </em>
@@ -696,7 +760,8 @@ capable of targeting objects based on kind, label and annotation selectors.</p>
 </td>
 <td>
 <em>(Optional)</em>
-<p>Strategic merge patches, defined as inline YAML objects.</p>
+<p>Strategic merge patches, defined as inline YAML objects.
+Deprecated: Use Patches instead.</p>
 </td>
 </tr>
 <tr>
@@ -710,7 +775,8 @@ capable of targeting objects based on kind, label and annotation selectors.</p>
 </td>
 <td>
 <em>(Optional)</em>
-<p>JSON 6902 patches, defined as inline YAML objects.</p>
+<p>JSON 6902 patches, defined as inline YAML objects.
+Deprecated: Use Patches instead.</p>
 </td>
 </tr>
 <tr>
@@ -746,7 +812,7 @@ when reconciling this Kustomization.</p>
 <td>
 <code>sourceRef</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.CrossNamespaceSourceReference">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.CrossNamespaceSourceReference">
 CrossNamespaceSourceReference
 </a>
 </em>
@@ -798,22 +864,6 @@ Defaults to &lsquo;Interval&rsquo; duration.</p>
 </tr>
 <tr>
 <td>
-<code>validation</code><br>
-<em>
-string
-</em>
-</td>
-<td>
-<em>(Optional)</em>
-<p>Validate the Kubernetes objects before applying them on the cluster.
-The validation strategy can be &lsquo;client&rsquo; (local dry-run), &lsquo;server&rsquo;
-(APIServer dry-run) or &lsquo;none&rsquo;.
-When &lsquo;Force&rsquo; is &lsquo;true&rsquo;, validation will fallback to &lsquo;client&rsquo; if set to
-&lsquo;server&rsquo; because server-side validation is not supported in this scenario.</p>
-</td>
-</tr>
-<tr>
-<td>
 <code>force</code><br>
 <em>
 bool
@@ -829,11 +879,11 @@ when patching fails due to an immutable field change.</p>
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.KustomizationStatus">KustomizationStatus
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.KustomizationStatus">KustomizationStatus
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Kustomization">Kustomization</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Kustomization">Kustomization</a>)
 </p>
 <p>KustomizationStatus defines the observed state of a kustomization.</p>
 <div class="md-typeset__scrollwrap">
@@ -848,6 +898,21 @@ when patching fails due to an immutable field change.</p>
 <tbody>
 <tr>
 <td>
+<code>ReconcileRequestStatus</code><br>
+<em>
+<a href="https://godoc.org/github.com/fluxcd/pkg/apis/meta#ReconcileRequestStatus">
+github.com/fluxcd/pkg/apis/meta.ReconcileRequestStatus
+</a>
+</em>
+</td>
+<td>
+<p>
+(Members of <code>ReconcileRequestStatus</code> are embedded into this type.)
+</p>
+</td>
+</tr>
+<tr>
+<td>
 <code>observedGeneration</code><br>
 <em>
 int64
@@ -898,25 +963,10 @@ string
 </tr>
 <tr>
 <td>
-<code>ReconcileRequestStatus</code><br>
-<em>
-<a href="https://godoc.org/github.com/fluxcd/pkg/apis/meta#ReconcileRequestStatus">
-github.com/fluxcd/pkg/apis/meta.ReconcileRequestStatus
-</a>
-</em>
-</td>
-<td>
-<p>
-(Members of <code>ReconcileRequestStatus</code> are embedded into this type.)
-</p>
-</td>
-</tr>
-<tr>
-<td>
-<code>snapshot</code><br>
+<code>inventory</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Snapshot">
-Snapshot
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.Inventory">
+Inventory
 </a>
 </em>
 </td>
@@ -929,11 +979,11 @@ Snapshot
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.PostBuild">PostBuild
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.PostBuild">PostBuild
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationSpec">KustomizationSpec</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.KustomizationSpec">KustomizationSpec</a>)
 </p>
 <p>PostBuild describes which actions to perform on the YAML manifest
 generated by building the kustomize overlay.</p>
@@ -968,7 +1018,7 @@ e.g. ${var:=default}, ${var:position} and ${var/substring/replacement}.</p>
 <td>
 <code>substituteFrom</code><br>
 <em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.SubstituteReference">
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.SubstituteReference">
 []SubstituteReference
 </a>
 </em>
@@ -985,102 +1035,11 @@ must match the vars declared in the manifests for the substitution to happen.</p
 </table>
 </div>
 </div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.Snapshot">Snapshot
-</h3>
-<p>
-(<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.KustomizationStatus">KustomizationStatus</a>)
-</p>
-<p>Snapshot holds the metadata of the Kubernetes objects
-generated for a source revision</p>
-<div class="md-typeset__scrollwrap">
-<div class="md-typeset__table">
-<table>
-<thead>
-<tr>
-<th>Field</th>
-<th>Description</th>
-</tr>
-</thead>
-<tbody>
-<tr>
-<td>
-<code>checksum</code><br>
-<em>
-string
-</em>
-</td>
-<td>
-<p>The manifests sha1 checksum.</p>
-</td>
-</tr>
-<tr>
-<td>
-<code>entries</code><br>
-<em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.SnapshotEntry">
-[]SnapshotEntry
-</a>
-</em>
-</td>
-<td>
-<p>A list of Kubernetes kinds grouped by namespace.</p>
-</td>
-</tr>
-</tbody>
-</table>
-</div>
-</div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.SnapshotEntry">SnapshotEntry
-</h3>
-<p>
-(<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.Snapshot">Snapshot</a>)
-</p>
-<p>Snapshot holds the metadata of namespaced
-Kubernetes objects</p>
-<div class="md-typeset__scrollwrap">
-<div class="md-typeset__table">
-<table>
-<thead>
-<tr>
-<th>Field</th>
-<th>Description</th>
-</tr>
-</thead>
-<tbody>
-<tr>
-<td>
-<code>namespace</code><br>
-<em>
-string
-</em>
-</td>
-<td>
-<em>(Optional)</em>
-<p>The namespace of this entry.</p>
-</td>
-</tr>
-<tr>
-<td>
-<code>kinds</code><br>
-<em>
-map[string]string
-</em>
-</td>
-<td>
-<p>The list of Kubernetes kinds.</p>
-</td>
-</tr>
-</tbody>
-</table>
-</div>
-</div>
-<h3 id="kustomize.toolkit.fluxcd.io/v1beta1.SubstituteReference">SubstituteReference
+<h3 id="kustomize.toolkit.fluxcd.io/v1beta2.SubstituteReference">SubstituteReference
 </h3>
 <p>
 (<em>Appears on:</em>
-<a href="#kustomize.toolkit.fluxcd.io/v1beta1.PostBuild">PostBuild</a>)
+<a href="#kustomize.toolkit.fluxcd.io/v1beta2.PostBuild">PostBuild</a>)
 </p>
 <p>SubstituteReference contains a reference to a resource containing
 the variables name and value.</p>
diff --git a/docs/spec/v1beta2/README.md b/docs/spec/v1beta2/README.md
new file mode 100644
index 00000000..95e426a0
--- /dev/null
+++ b/docs/spec/v1beta2/README.md
@@ -0,0 +1,24 @@
+# kustomize.toolkit.fluxcd.io/v1beta2
+
+This is the v1beta1 API specification for defining continuous delivery pipelines
+of Kubernetes objects generated with Kustomize.
+
+## Specification
+
+- [Kustomization CRD](kustomization.md)
+    + [Source reference](kustomization.md#source-reference)
+    + [Generate kustomization.yaml](kustomization.md#generate-kustomizationyaml)
+    + [Reconciliation](kustomization.md#reconciliation)
+    + [Garbage collection](kustomization.md#garbage-collection)
+    + [Health assessment](kustomization.md#health-assessment)
+    + [Kustomization dependencies](kustomization.md#kustomization-dependencies)
+    + [Role-based access control](kustomization.md#role-based-access-control)
+    + [Override kustomize config](kustomization.md#override-kustomize-config)
+    + [Variable substitution](kustomization.md#variable-substitution)
+    + [Targeting remote clusters](kustomization.md#remote-clusters--cluster-api)
+    + [Secrets decryption](kustomization.md#secrets-decryption)
+    + [Status](kustomization.md#status)
+
+## Implementation
+
+* [kustomize-controller](https://github.com/fluxcd/kustomize-controller/)
diff --git a/docs/spec/v1beta2/kustomization.md b/docs/spec/v1beta2/kustomization.md
new file mode 100644
index 00000000..371fdd97
--- /dev/null
+++ b/docs/spec/v1beta2/kustomization.md
@@ -0,0 +1,1040 @@
+# Kustomization
+
+The `Kustomization` API defines a pipeline for fetching, decrypting, building, validating and applying Kubernetes manifests.
+
+## Specification
+
+A **Kustomization** object defines the source of Kubernetes manifests by referencing an object
+managed by [source-controller](https://github.com/fluxcd/source-controller),
+the path to the Kustomization file within that source,
+and the interval at which the kustomize build output is applied on the cluster.
+
+```go
+type KustomizationSpec struct {
+	// DependsOn may contain a dependency.CrossNamespaceDependencyReference slice
+	// with references to Kustomization resources that must be ready before this
+	// Kustomization can be reconciled.
+	// +optional
+	DependsOn []dependency.CrossNamespaceDependencyReference `json:"dependsOn,omitempty"`
+
+	// Decrypt Kubernetes secrets before applying them on the cluster.
+	// +optional
+	Decryption *Decryption `json:"decryption,omitempty"`
+
+	// The interval at which to reconcile the Kustomization.
+	// +required
+	Interval metav1.Duration `json:"interval"`
+
+	// The interval at which to retry a previously failed reconciliation.
+	// When not specified, the controller uses the KustomizationSpec.Interval
+	// value to retry failures.
+	// +optional
+	RetryInterval *metav1.Duration `json:"retryInterval,omitempty"`
+
+	// The KubeConfig for reconciling the Kustomization on a remote cluster.
+	// When specified, KubeConfig takes precedence over ServiceAccountName.
+	// +optional
+	KubeConfig *KubeConfig `json:"kubeConfig,omitempty"`
+
+	// Path to the directory containing the kustomization.yaml file, or the
+	// set of plain YAMLs a kustomization.yaml should be generated for.
+	// Defaults to 'None', which translates to the root path of the SourceRef.
+	// +optional
+	Path string `json:"path,omitempty"`
+
+	// PostBuild describes which actions to perform on the YAML manifest
+	// generated by building the kustomize overlay.
+	// +optional
+	PostBuild *PostBuild `json:"postBuild,omitempty"`
+
+	// Enables garbage collection.
+	// +required
+	Prune bool `json:"prune"`
+
+	// A list of resources to be included in the health assessment.
+	// +optional
+	HealthChecks []meta.NamespacedObjectKindReference `json:"healthChecks,omitempty"`
+
+	// Strategic merge and JSON patches, defined as inline YAML objects,
+	// capable of targeting objects based on kind, label and annotation selectors.
+	// +optional
+	Patches []kustomize.Patch `json:"patches,omitempty"`
+
+	// Images is a list of (image name, new name, new tag or digest)
+	// for changing image names, tags or digests. This can also be achieved with a
+	// patch, but this operator is simpler to specify.
+	// +optional
+    Images []kustomize.Image `json:"images,omitempty"`
+
+	// The name of the Kubernetes service account to impersonate
+	// when reconciling this Kustomization.
+	// +optional
+	ServiceAccountName string `json:"serviceAccountName,omitempty"`
+
+	// Reference of the source where the kustomization file is.
+	// +required
+	SourceRef CrossNamespaceSourceReference `json:"sourceRef"`
+
+	// This flag tells the controller to suspend subsequent kustomize executions,
+	// it does not apply to already started executions. Defaults to false.
+	// +optional
+	Suspend bool `json:"suspend,omitempty"`
+
+	// TargetNamespace sets or overrides the namespace in the
+	// kustomization.yaml file.
+	// +optional
+	TargetNamespace string `json:"targetNamespace,omitempty"`
+
+	// Timeout for apply and health checking operations.
+	// Defaults to 'Interval' duration.
+	// +optional
+	Timeout *metav1.Duration `json:"timeout,omitempty"`
+	
+	// Force instructs the controller to recreate resources
+	// when patching fails due to an immutable field change.
+	// +kubebuilder:default:=false
+	// +optional
+	Force bool `json:"force,omitempty"`
+}
+```
+
+The decryption section defines how decryption is handled for Kubernetes manifests:
+
+```go
+type Decryption struct {
+	// Provider is the name of the decryption engine.
+	// +kubebuilder:validation:Enum=sops
+	// +required
+	Provider string `json:"provider"`
+
+	// The secret name containing the private OpenPGP keys used for decryption.
+	// +optional
+	SecretRef *meta.LocalObjectReference `json:"secretRef,omitempty"`
+}
+```
+
+KubeConfig references a Kubernetes Secret for applying to another cluster.
+This can be used with Cluster API:
+
+```go
+type KubeConfig struct {
+	// SecretRef holds the name to a secret that contains a 'value' key with
+	// the kubeconfig file as the value. It must be in the same namespace as
+	// the Kustomization.
+	// It is recommended that the kubeconfig is self-contained, and the secret
+	// is regularly updated if credentials such as a cloud-access-token expire.
+	// Cloud specific `cmd-path` auth helpers will not function without adding
+	// binaries and credentials to the Pod that is responsible for reconciling
+	// the Kustomization.
+	// +required
+	SecretRef meta.LocalObjectReference `json:"secretRef,omitempty"`
+}
+```
+
+The post-build section defines which actions to perform on the YAML manifest after kustomize build:
+
+```go
+type PostBuild struct {
+	// Substitute holds a map of key/value pairs.
+	// The variables defined in your YAML manifests
+	// that match any of the keys defined in the map
+	// will be substituted with the set value.
+	// Includes support for bash string replacement functions
+	// e.g. ${var:=default}, ${var:position} and ${var/substring/replacement}.
+	// +optional
+	Substitute map[string]string `json:"substitute,omitempty"`
+
+	// SubstituteFrom holds references to ConfigMaps and Secrets containing
+	// the variables and their values to be substituted in the YAML manifests.
+	// The ConfigMap and the Secret data keys represent the var names and they
+	// must match the vars declared in the manifests for the substitution to happen.
+	// +optional
+	SubstituteFrom []SubstituteReference `json:"substituteFrom,omitempty"`
+}
+```
+
+The status sub-resource records the result of the last reconciliation:
+
+```go
+type KustomizationStatus struct {
+	// ObservedGeneration is the last reconciled generation.
+	// +optional
+	ObservedGeneration int64 `json:"observedGeneration,omitempty"`
+
+	// +optional
+	Conditions []metav1.Condition `json:"conditions,omitempty"`
+
+	// The last successfully applied revision.
+	// The revision format for Git sources is <branch|tag>/<commit-sha>.
+	// +optional
+	LastAppliedRevision string `json:"lastAppliedRevision,omitempty"`
+
+	// LastAttemptedRevision is the revision of the last reconciliation attempt.
+	// +optional
+	LastAttemptedRevision string `json:"lastAttemptedRevision,omitempty"`
+
+	// LastHandledReconcileAt is the last manual reconciliation request (by
+	// annotating the Kustomization) handled by the reconciler.
+	// +optional
+	LastHandledReconcileAt string `json:"lastHandledReconcileAt,omitempty"`
+
+	// The last successfully applied revision metadata.
+	// +optional
+	Inventory *Inventory `json:"inventory"`
+}
+```
+
+Status condition types:
+
+```go
+const (
+	// ReadyCondition is the name of the condition that
+	// records the readiness status of a Kustomization.
+	ReadyCondition string = "Ready"
+
+	// HealthyCondition is the condition type used
+	// to record the last health assessment result.
+	HealthyCondition string = "Healthy"
+)
+```
+
+Status condition reasons:
+
+```go
+const (
+	// ReconciliationSucceededReason represents the fact that the
+	// reconciliation of the Kustomization has succeeded.
+	ReconciliationSucceededReason string = "ReconciliationSucceeded"
+
+	// ReconciliationFailedReason represents the fact that the
+	// reconciliation of the Kustomization has failed.
+	ReconciliationFailedReason string = "ReconciliationFailed"
+
+	// ProgressingReason represents the fact that the
+	// reconciliation of the Kustomization is underway.
+	ProgressingReason string = "Progressing"
+
+	// DependencyNotReady represents the fact that
+	// one of the dependencies of the Kustomization is not ready.
+	DependencyNotReadyReason string = "DependencyNotReady"
+
+	// PruneFailedReason represents the fact that the
+	// pruning of the Kustomization failed.
+	PruneFailedReason string = "PruneFailed"
+
+	// ArtifactFailedReason represents the fact that the
+	// artifact download of the kustomization failed.
+	ArtifactFailedReason string = "ArtifactFailed"
+
+	// BuildFailedReason represents the fact that the
+	// kustomize build of the Kustomization failed.
+	BuildFailedReason string = "BuildFailed"
+
+	// HealthCheckFailedReason represents the fact that
+	// one of the health checks of the Kustomization failed.
+	HealthCheckFailedReason string = "HealthCheckFailed"
+
+	// ValidationFailedReason represents the fact that the
+	// validation of the Kustomization manifests has failed.
+	ValidationFailedReason string = "ValidationFailed"
+)
+```
+
+## Source reference
+
+The Kustomization `spec.sourceRef` is a reference to an object managed by
+[source-controller](https://github.com/fluxcd/source-controller). When the source
+[revision](https://github.com/fluxcd/source-controller/blob/main/docs/spec/v1beta1/common.md#source-status)
+changes, it generates a Kubernetes event that triggers a kustomize build and apply.
+
+Source supported types:
+
+* [GitRepository](https://github.com/fluxcd/source-controller/blob/main/docs/spec/v1beta1/gitrepositories.md)
+* [Bucket](https://github.com/fluxcd/source-controller/blob/main/docs/spec/v1beta1/buckets.md)
+
+> **Note** that the source should contain the kustomization.yaml and all the
+> Kubernetes manifests and configuration files referenced in the kustomization.yaml.
+> If your Git repository or S3 bucket contains only plain manifests,
+> then a kustomization.yaml will be automatically generated.
+
+## Generate kustomization.yaml
+
+If your repository contains plain Kubernetes manifests, the `kustomization.yaml`
+file is automatically generated for all the Kubernetes manifests
+in the `spec.path` and sub-directories. This expects all YAML files present under that path to be valid kubernetes manifests
+and needs non-kubernetes ones to be excluded using `.sourceignore` file or `spec.ignore` on `GitRepository` object.
+
+Example of excluding CI workflows and SOPS config files:
+
+```yaml
+apiVersion: source.toolkit.fluxcd.io/v1beta1
+kind: GitRepository
+metadata:
+  name: podinfo
+  namespace: default
+spec:
+  interval: 5m
+  url: https://github.com/stefanprodan/podinfo
+  ignore: |
+    .git/
+    .github/
+    .sops.yaml
+    .gitlab-ci.yml
+```
+
+It is recommended to generate the `kustomization.yaml` on your own and store it in Git, this way you can
+validate your manifests in CI (example script [here](https://github.com/fluxcd/flux2-multi-tenancy/blob/main/scripts/validate.sh)).
+Assuming your manifests are inside `./clusters/my-cluster`, you can generate a `kustomization.yaml` with:
+
+```sh
+cd clusters/my-cluster
+
+# create kustomization
+kustomize create --autodetect --recursive
+
+# validate kustomization
+kustomize build | kubeval --ignore-missing-schemas
+```
+
+## Reconciliation
+
+The Kustomization `spec.interval` tells the controller at which interval to fetch the
+Kubernetes manifest for the source, build the Kustomization and apply it on the cluster.
+The interval time units are `s`, `m` and `h` e.g. `interval: 5m`, the minimum value should be over 60 seconds.
+
+The Kustomization execution can be suspended by setting `spec.suspend` to `true`.
+
+With `spec.force` you can tell the controller to replace the resources in-cluster if the
+patching fails due to immutable fields changes.
+
+The controller can be told to reconcile the Kustomization outside of the specified interval
+by annotating the Kustomization object with:
+
+```go
+const (
+	// ReconcileAtAnnotation is the annotation used for triggering a
+	// reconciliation outside of the defined schedule.
+	ReconcileAtAnnotation string = "reconcile.fluxcd.io/requestedAt"
+)
+```
+
+On-demand execution example:
+
+```bash
+kubectl annotate --overwrite kustomization/podinfo reconcile.fluxcd.io/requestedAt="$(date +%s)"
+```
+
+List all Kubernetes objects reconciled from a Kustomization:
+
+```sh
+kubectl get all --all-namespaces \
+-l=kustomize.toolkit.fluxcd.io/name="<Kustomization name>" \
+-l=kustomize.toolkit.fluxcd.io/namespace="<Kustomization namespace>"
+```
+
+## Garbage collection
+
+To enable garbage collection, set `spec.prune` to `true`.
+
+Garbage collection means that the Kubernetes objects that were previously applied on the cluster
+but are missing from the current source revision, are removed from cluster automatically.
+Garbage collection is also performed when a Kustomization object is deleted,
+triggering a removal of all Kubernetes objects previously applied on the cluster.
+
+To keep track of the Kubernetes objects reconciled from a Kustomization, the controller
+creates an inventory of the last applied resources. The inventory records are in the
+format `<namespace>_<name>_<group>_<kind>_<version>` and they are stored in-cluster
+under `.status.inventory.entries`.
+
+You can disable pruning for certain resources by either
+labeling or annotating them with:
+
+```yaml
+kustomize.toolkit.fluxcd.io/prune: disabled
+```
+
+## Health assessment
+
+A Kustomization can contain a series of health checks used to determine the
+[rollout status](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#deployment-status)
+of the deployed workloads and the ready status of custom resources.
+
+A health check entry can reference one of the following types:
+
+* Kubernetes builtin kinds: Deployment, DaemonSet, StatefulSet, PersistentVolumeClaim, Pod, PodDisruptionBudget, Job, CronJob, Service, Secret, ConfigMap, CustomResourceDefinition
+* Toolkit kinds: HelmRelease, HelmRepository, GitRepository, etc
+* Custom resources that are compatible with [kstatus](https://github.com/kubernetes-sigs/cli-utils/tree/master/pkg/kstatus)
+
+Assuming the Kustomization source contains a Kubernetes Deployment named `backend`,
+a health check can be defined as follows:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: backend
+  namespace: default
+spec:
+  interval: 5m
+  path: "./webapp/backend/"
+  prune: true
+  sourceRef:
+    kind: GitRepository
+    name: webapp
+  healthChecks:
+    - apiVersion: apps/v1
+      kind: Deployment
+      name: backend
+      namespace: dev
+  timeout: 2m
+```
+
+After applying the kustomize build output, the controller verifies if the rollout completed successfully.
+If the deployment was successful, the Kustomization ready condition is marked as `true`,
+if the rollout failed, or if it takes more than the specified timeout to complete, then the
+Kustomization ready condition is set to `false`. If the deployment becomes healthy on the next
+execution, then the Kustomization is marked as ready.
+
+When a Kustomization contains HelmRelease objects, instead of checking the underling Deployments, you can
+define a health check that waits for the HelmReleases to be reconciled with:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: webapp
+  namespace: default
+spec:
+  interval: 15m
+  path: "./releases/"
+  prune: true
+  sourceRef:
+    kind: GitRepository
+    name: webapp
+  healthChecks:
+    - apiVersion: helm.toolkit.fluxcd.io/v2beta1
+      kind: HelmRelease
+      name: frontend
+      namespace: dev
+    - apiVersion: helm.toolkit.fluxcd.io/v2beta1
+      kind: HelmRelease
+      name: backend
+      namespace: dev
+  timeout: 5m
+```
+
+If all the HelmRelease objects are successfully installed or upgraded, then the Kustomization will be marked as ready.
+
+## Kustomization dependencies
+
+When applying a Kustomization, you may need to make sure other resources exist before the
+workloads defined in your Kustomization are deployed.
+For example, a namespace must exist before applying resources to it.
+
+With `spec.dependsOn` you can specify that the execution of a Kustomization follows another.
+When you add `dependsOn` entries to a Kustomization, that Kustomization is applied
+only after all of its dependencies are ready. The readiness state of a Kustomization is determined by
+its last apply status condition.
+
+Assuming two Kustomizations:
+
+* `cert-manager` - reconciles the cert-manager CRDs and controller
+* `certs` - reconciles the cert-manager custom resources
+
+You can instruct the controller to apply the `cert-manager` Kustomization before `certs`:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: cert-manager
+  namespace: flux-system
+spec:
+  interval: 5m
+  path: "./cert-manager/controller"
+  prune: true
+  sourceRef:
+    kind: GitRepository
+    name: flux-system
+  healthChecks:
+    - apiVersion: apps/v1
+      kind: Deployment
+      name: cert-manager
+      namespace: cert-manager
+---
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: certs
+  namespace: flux-system
+spec:
+  dependsOn:
+    - name: cert-manager
+  interval: 5m
+  path: "./cert-manager/certs"
+  prune: true
+  sourceRef:
+    kind: GitRepository
+    name: flux-system
+```
+
+When combined with health assessment, a Kustomization will run after all its dependencies health checks are passing.
+For example, a service mesh proxy injector should be running before deploying applications inside the mesh.
+
+> **Note** that circular dependencies between Kustomizations must be avoided, otherwise the
+> interdependent Kustomizations will never be applied on the cluster.
+
+## Role-based access control
+
+By default, a Kustomization apply runs under the cluster admin account and can create, modify, delete
+cluster level objects (namespaces, CRDs, etc) and namespeced objects (deployments, ingresses, etc).
+For certain Kustomizations a cluster admin may wish to control what types of Kubernetes objects can
+be reconciled and under which namespaces.
+To restrict a Kustomization, one can assign a service account under which the reconciliation is performed.
+
+Assuming you want to restrict a group of Kustomizations to a single namespace, you can create an account
+with a role binding that grants access only to that namespace:
+
+```yaml
+apiVersion: v1
+kind: Namespace
+metadata:
+  name: webapp
+---
+apiVersion: v1
+kind: ServiceAccount
+metadata:
+  name: webapp-reconciler
+  namespace: webapp
+---
+apiVersion: rbac.authorization.k8s.io/v1
+kind: Role
+metadata:
+  name: webapp-reconciler
+  namespace: webapp
+rules:
+  - apiGroups: ['*']
+    resources: ['*']
+    verbs: ['*']
+---
+apiVersion: rbac.authorization.k8s.io/v1
+kind: RoleBinding
+metadata:
+  name: webapp-reconciler
+  namespace: webapp
+roleRef:
+  apiGroup: rbac.authorization.k8s.io
+  kind: Role
+  name: webapp-reconciler
+subjects:
+- kind: ServiceAccount
+  name: webapp-reconciler
+  namespace: webapp
+```
+
+> **Note** that the namespace, RBAC and service account manifests should be
+> placed in a Git source and applied with a Kustomization. The Kustomizations that
+> are running under that service account should depend-on the one that contains the account.
+
+Create a Kustomization that prevents altering the cluster state outside of the `webapp` namespace:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: backend
+  namespace: webapp
+spec:
+  serviceAccountName: webapp-reconciler
+  dependsOn:
+    - name: common
+  interval: 5m
+  path: "./webapp/backend/"
+  prune: true
+  sourceRef:
+    kind: GitRepository
+    name: webapp
+```
+
+When the controller reconciles the `frontend-webapp` Kustomization, it will impersonate the `webapp-reconciler`
+account. If the Kustomization contains cluster level objects like CRDs or objects belonging to a different
+namespace, the reconciliation will fail since the account it runs under has no permissions to alter objects
+outside of the `webapp` namespace.
+
+## Override kustomize config
+
+The Kustomization has a set of fields to extend and/or override the Kustomize
+patches and namespace on all the Kubernetes objects reconciled by the resource,
+offering support for the following Kustomize directives:
+
+- [namespace](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/namespace/)
+- [patches](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/patches/)
+- [images](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/images/)
+
+### Target namespace
+
+To configure the [Kustomize `namespace`](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/namespace/)
+and overwrite the namespace of all the Kubernetes objects reconciled by the `Kustomization`,
+`spec.targetNamespace` can be defined:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: podinfo
+  namespace: flux-system
+spec:
+  # ...omitted for brevity
+  targetNamespace: test
+```
+
+The `targetNamespace` is expected to exist.
+
+### Patches
+
+To add [Kustomize `patches` entries](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/patches/)
+to the configuration, and patch resources using either a [strategic merge](https://kubectl.docs.kubernetes.io/references/kustomize/glossary#patchstrategicmerge) 
+patch or a [JSON6902](https://kubectl.docs.kubernetes.io/references/kustomize/glossary#patchjson6902) patch,
+`spec.patches` items must contain a `target` selector and a `patch` document.
+The patch can target a single resource or multiple resources:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: podinfo
+  namespace: flux-system
+spec:
+  # ...omitted for brevity
+  patches:
+    - patch: |-
+        apiVersion: apps/v1
+        kind: Deployment
+        metadata:
+          name: not-used
+        spec:
+          template:
+            metadata:
+              annotations:
+                cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
+      target:
+        kind: Deployment
+        labelSelector: "app.kubernetes.io/part-of=my-app"
+    - patch: |
+        - op: add
+          path: /spec/template/spec/securityContext
+          value:
+            runAsUser: 10000
+            fsGroup: 1337
+        - op: add
+          path: /spec/template/spec/containers/0/securityContext
+          value:
+            readOnlyRootFilesystem: true
+            allowPrivilegeEscalation: false
+            runAsNonRoot: true
+            capabilities:
+              drop:
+                - ALL
+      target:
+        kind: Deployment
+        name: podinfo
+        namespace: apps
+```
+
+### Images
+
+To add [Kustomize `images` entries](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/images/)
+to the configuration, and overwrite the name, tag or digest of container images
+without creating patches, `spec.images` can be defined:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: podinfo
+  namespace: flux-system
+spec:
+  # ...omitted for brevity
+  images:
+  - name: podinfo
+    newName: my-registry/podinfo
+    newTag: v1
+  - name: podinfo
+    newTag: 1.8.0
+  - name: podinfo
+    newName: my-podinfo
+  - name: podinfo
+    digest: sha256:24a0c4b4a4c0eb97a1aabb8e29f18e917d05abfe1b7a7c07857230879ce7d3d3
+```
+
+## Variable substitution
+
+With `spec.postBuild.substitute` you can provide a map of key/value pairs holding the
+variables to be substituted in the final YAML manifest, after kustomize build.
+
+With `spec.postBuild.substituteFrom` you can provide a list of ConfigMaps and Secrets
+from which the variables are loaded.
+The ConfigMap and Secret data keys are used as the var names.
+
+This offers basic templating for your manifests including support
+for [bash string replacement functions](https://github.com/drone/envsubst) e.g.:
+
+- `${var:=default}`
+- `${var:position}`
+- `${var:position:length}`
+- `${var/substring/replacement}`
+
+Note that the name of a variable can contain only alphanumeric and underscore characters.
+The controller validates the var names using this regular expression:
+`^[_[:alpha:]][_[:alpha:][:digit:]]*$`.
+
+Assuming you have manifests with the following variables:
+
+```yaml
+apiVersion: v1
+kind: Namespace
+metadata:
+  name: apps
+  labels:
+    environment: ${cluster_env:=dev}
+    region: "${cluster_region}"
+```
+
+You can specify the variables and their values in the Kustomization definition under
+`substitute` and/or `substituteFrom` post build section:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: apps
+spec:
+  interval: 5m
+  path: "./apps/"
+  postBuild:
+    substitute:
+      cluster_env: "prod"
+      cluster_region: "eu-central-1"
+    substituteFrom:
+      - kind: ConfigMap
+        name: cluster-vars
+      - kind: Secret
+        name: cluster-secret-vars
+```
+
+The var values which are specified in-line with `substitute`
+take precedence over the ones in `substituteFrom`.
+
+Note that if you want to avoid var substitutions in scripts embedded in ConfigMaps or container commands,
+you must use the format `$var` instead of `${var}`. All the undefined variables in the format `${var}`
+will be substituted with string empty, unless a default is provided e.g. `${var:=default}`.
+
+You can disable the variable substitution for certain resources by either
+labeling or annotating them with:
+
+```yaml
+kustomize.toolkit.fluxcd.io/substitute: disabled
+``` 
+
+Substitution of variables only happens if at least a single variable or resource to substitute
+from is defined. This may cause issues if you rely on expressions which should evaluate to a
+default, even if no other variables are configured. To work around this, one can set an
+arbitrary key/value pair to enable the substitution of variables. For example: 
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: apps
+spec:
+  ...
+  postBuild:
+    substitute:
+      var_substitution_enabled: "true"
+```
+
+You can replicate the controller post-build substitutions locally using
+[kustomize](https://github.com/kubernetes-sigs/kustomize)
+and Drone's [envsubst](https://github.com/drone/envsubst):
+
+```console
+$ go install github.com/drone/envsubst/cmd/envsubst
+
+$ export cluster_region=eu-central-1
+$ kustomize build ./apps/ | $GOPATH/bin/envsubst 
+---
+apiVersion: v1
+kind: Namespace
+metadata:
+  name: apps
+  labels:
+    environment: dev
+    region: eu-central-1
+```
+
+## Remote Clusters / Cluster-API
+
+If the `kubeConfig` field is set, objects will be applied, health-checked, pruned, and deleted for the default
+cluster specified in that KubeConfig instead of using the in-cluster ServiceAccount.
+
+The secret defined in the `kubeConfig.SecretRef` must exist in the same namespace as the Kustomization.
+On every reconciliation, the KubeConfig bytes will be loaded from the `value` or `value.yaml` key of the secret's data,
+and the secret can thus be regularly updated if cluster-access-tokens have to rotate due to expiration.
+
+This composes well with Cluster API bootstrap providers such as CAPBK (kubeadm), CAPA (AWS) and others.
+
+To reconcile a Kustomization to a CAPI controlled cluster, put the `Kustomization` in the same namespace as your
+`Cluster` object, and set the `kubeConfig.secretRef.name` to `<cluster-name>-kubeconfig`:
+
+```yaml
+apiVersion: cluster.x-k8s.io/v1alpha3
+kind: Cluster
+metadata:
+  name: stage  # the kubeconfig Secret will contain the Cluster name
+  namespace: capi-stage
+spec:
+  clusterNetwork:
+    pods:
+      cidrBlocks:
+      - 10.100.0.0/16
+    serviceDomain: stage-cluster.local
+    services:
+      cidrBlocks:
+      - 10.200.0.0/12
+  controlPlaneRef:
+    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
+    kind: KubeadmControlPlane
+    name: stage-control-plane
+    namespace: capi-stage
+  infrastructureRef:
+    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
+    kind: DockerCluster
+    name: stage
+    namespace: capi-stage
+---
+# ... unrelated Cluster API objects omitted for brevity ...
+---
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: cluster-addons
+  namespace: capi-stage
+spec:
+  interval: 5m
+  path: "./config/addons/"
+  prune: true
+  sourceRef:
+    kind: GitRepository
+    name: cluster-addons
+  kubeConfig:
+    secretRef:
+      name: stage-kubeconfig  # Cluster API creates this for the matching Cluster
+```
+
+The Cluster and Kustomization can be created at the same time.
+The Kustomization will eventually reconcile once the cluster is available.
+
+If you wish to target clusters created by other means than CAPI, you can create a ServiceAccount
+on the remote cluster, generate a KubeConfig for that account, and then create a secret on the
+cluster where kustomize-controller is running e.g.:
+
+```sh
+kubectl create secret generic prod-kubeconfig \
+    --from-file=value.yaml=./kubeconfig
+```
+
+> **Note** that the KubeConfig should be self-contained and not rely on binaries, environment,
+> or credential files from the kustomize-controller Pod.
+> This matches the constraints of KubeConfigs from current Cluster API providers.
+> KubeConfigs with `cmd-path` in them likely won't work without a custom,
+> per-provider installation of kustomize-controller.
+
+## Secrets decryption
+
+In order to store secrets safely in a public or private Git repository,
+you can use [Mozilla SOPS](https://github.com/mozilla/sops)
+and encrypt your Kubernetes Secrets data with [OpenPGP](https://www.openpgp.org)
+and [age](https://age-encryption.org/v1/) keys.
+
+### OpenPGP
+
+Generate a GPG key **without passphrase** using [gnupg](https://www.gnupg.org/),
+then use `sops` to encrypt a Kubernetes secret:
+
+```sh
+sops --pgp=FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4 \
+--encrypt --encrypted-regex '^(data|stringData)$' --in-place my-secret.yaml
+```
+
+Commit and push the encrypted file to Git.
+
+> **Note** that you should encrypt only the `data` section, encrypting the Kubernetes
+> secret metadata, kind or apiVersion is not supported by kustomize-controller.
+
+Create a secret in the `default` namespace with the OpenPGP private key,
+the key name must end with `.asc` to be detected as an OpenPGP key:
+
+```sh
+gpg --export-secret-keys --armor FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4 |
+kubectl -n default create secret generic sops-gpg \
+--from-file=sops.asc=/dev/stdin
+```
+
+Configure decryption by referring the private key secret:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: my-secrets
+  namespace: default
+spec:
+  interval: 5m
+  path: "./"
+  sourceRef:
+    kind: GitRepository
+    name: my-secrets
+  decryption:
+    provider: sops
+    secretRef:
+      name: sops-pgp
+```
+
+### Age
+
+Generate an age key with [age](https://age-encryption.org) using `age-keygen`,
+then use `sops` to encrypt a Kubernetes secret:
+
+```console
+$ age-keygen -o age.agekey
+Public key: age1helqcqsh9464r8chnwc2fzj8uv7vr5ntnsft0tn45v2xtz0hpfwq98cmsg
+$ sops --age=age1helqcqsh9464r8chnwc2fzj8uv7vr5ntnsft0tn45v2xtz0hpfwq98cmsg \
+--encrypt --encrypted-regex '^(data|stringData)$' --in-place my-secret.yaml
+```
+
+Commit and push the encrypted file to Git.
+
+> **Note** that you should encrypt only the `data` section, encrypting the Kubernetes
+> secret metadata, kind or apiVersion is not supported by kustomize-controller.
+
+Create a secret in the `default` namespace with the age private key,
+the key name must end with `.agekey` to be detected as an age key:
+
+```sh
+cat age.agekey |
+kubectl -n default create secret generic sops-age \
+--from-file=age.agekey=/dev/stdin
+```
+
+Configure decryption by referring the private key secret:
+
+```yaml
+apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
+kind: Kustomization
+metadata:
+  name: my-secrets
+  namespace: default
+spec:
+  interval: 5m
+  path: "./"
+  sourceRef:
+    kind: GitRepository
+    name: my-secrets
+  decryption:
+    provider: sops
+    secretRef:
+      name: sops-age
+```
+
+### Kustomize secretGenerator
+
+SOPS encrypted data can be stored as a base64 encoded Secret,
+which enables the use of Kustomize `secretGenerator` as follows:
+
+```console
+$ echo "my-secret-token" | sops -e /dev/stdin > token.encrypted
+$ cat <<EOF > kustomization.yaml
+apiVersion: kustomize.config.k8s.io/v1beta1
+kind: Kustomization
+
+secretGenerator:
+ - name: token
+   files:
+   - token=token.encrypted
+EOF
+```
+
+Commit and push `token.encrypted` and `kustomization.yaml` to Git.
+
+The kustomize-controller scans the values of Kubernetes Secrets, and when it 
+detects that the values are SOPS encrypted, it decrypts them before applying 
+them on the cluster.
+
+## Status
+
+When the controller completes a Kustomization apply, reports the result in the `status` sub-resource.
+
+A successful reconciliation sets the ready condition to `true` and updates the revision field:
+
+```yaml
+status:
+  conditions:
+  - lastTransitionTime: "2020-09-17T19:28:48Z"
+    message: "Applied revision: master/a1afe267b54f38b46b487f6e938a6fd508278c07"
+    reason: ReconciliationSucceeded
+    status: "True"
+    type: Ready
+  lastAppliedRevision: master/a1afe267b54f38b46b487f6e938a6fd508278c07
+  lastAttemptedRevision: master/a1afe267b54f38b46b487f6e938a6fd508278c07
+```
+
+You can wait for the kustomize controller to complete a reconciliation with:
+
+```bash
+kubectl wait kustomization/backend --for=condition=ready
+```
+
+The controller logs the Kubernetes objects:
+
+```json
+{
+  "level": "info",
+  "ts": "2020-09-17T07:27:11.921Z",
+  "logger": "controllers.Kustomization",
+  "msg": "Kustomization applied in 1.436096591s",
+  "kustomization": "default/backend",
+  "output": {
+    "service/backend": "created",
+    "deployment.apps/backend": "created",
+    "horizontalpodautoscaler.autoscaling/backend": "created"
+  }
+}
+```
+
+A failed reconciliation sets the ready condition to `false`:
+
+```yaml
+status:
+  conditions:
+  - lastTransitionTime: "2020-09-17T07:26:48Z"
+    message: "The Service 'backend' is invalid: spec.type: Unsupported value: 'Ingress'"
+    reason: ValidationFailed
+    status: "False"
+    type: Ready
+  lastAppliedRevision: master/a1afe267b54f38b46b487f6e938a6fd508278c07
+  lastAttemptedRevision: master/7c500d302e38e7e4a3f327343a8a5c21acaaeb87
+```
+
+> **Note** that the last applied revision is updated only on a successful reconciliation.
+
+When a reconciliation fails, the controller logs the error and issues a Kubernetes event:
+
+```json
+{
+  "level": "error",
+  "ts": "2020-09-17T07:27:11.921Z",
+  "logger": "controllers.Kustomization",
+  "kustomization": "default/backend",
+  "error": "The Service 'backend' is invalid: spec.type: Unsupported value: 'Ingress'"
+}
+```
