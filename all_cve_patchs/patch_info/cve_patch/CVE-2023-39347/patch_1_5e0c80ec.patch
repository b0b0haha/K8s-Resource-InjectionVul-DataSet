From 5e0c80ec3554ca932cf63d7bacf0421cddd5a6d4 Mon Sep 17 00:00:00 2001
From: Maciej Kwiek <maciej@isovalent.com>
Date: Fri, 4 Aug 2023 15:09:14 +0200
Subject: [PATCH] Sanitize pod label changes on pod update

This change moves pod sanitization code from GetPodMetadata function
which is used on pod creation and applies the same logic on labels
provided by k8s update of pod objects.

This allows Cilium to defend against user changing namespace, service
account, cluster name labels, and other labels that could lead
to bypassing network policy.

Signed-off-by: Maciej Kwiek <maciej@isovalent.com>
---
 pkg/k8s/labels.go           | 19 +++--------
 pkg/k8s/utils/utils.go      | 59 +++++++++++++++++++++++++++++++++
 pkg/k8s/utils/utils_test.go | 65 +++++++++++++++++++++++++++++++++++++
 pkg/k8s/watchers/pod.go     |  8 +++--
 4 files changed, 134 insertions(+), 17 deletions(-)

diff --git a/pkg/k8s/labels.go b/pkg/k8s/labels.go
index 0bfddd6d7669a..6a4cf0ba778ed 100644
--- a/pkg/k8s/labels.go
+++ b/pkg/k8s/labels.go
@@ -11,9 +11,9 @@ import (
 
 	k8sConst "github.com/cilium/cilium/pkg/k8s/apis/cilium.io"
 	slim_corev1 "github.com/cilium/cilium/pkg/k8s/slim/k8s/api/core/v1"
+	k8sUtils "github.com/cilium/cilium/pkg/k8s/utils"
 	"github.com/cilium/cilium/pkg/logging/logfields"
 	"github.com/cilium/cilium/pkg/option"
-	"github.com/cilium/cilium/pkg/policy"
 )
 
 const (
@@ -97,17 +97,6 @@ func GetPodMetadata(k8sNs *slim_corev1.Namespace, pod *slim_corev1.Pod) (contain
 	annotations := objMetaCpy.Annotations
 	k8sLabels := filterPodLabels(objMetaCpy.Labels)
 
-	for k, v := range k8sNs.GetLabels() {
-		k8sLabels[policy.JoinPath(k8sConst.PodNamespaceMetaLabels, k)] = v
-	}
-	k8sLabels[k8sConst.PodNamespaceLabel] = namespace
-
-	if pod.Spec.ServiceAccountName != "" {
-		k8sLabels[k8sConst.PolicyLabelServiceAccount] = pod.Spec.ServiceAccountName
-	} else {
-		delete(k8sLabels, k8sConst.PolicyLabelServiceAccount)
-	}
-
 	// If the pod has been injected with an Istio sidecar proxy compatible with
 	// Cilium, add a label to notify that.
 	// If the pod already contains that label to explicitly enable or disable
@@ -118,15 +107,15 @@ func GetPodMetadata(k8sNs *slim_corev1.Namespace, pod *slim_corev1.Pod) (contain
 		k8sLabels[k8sConst.PolicyLabelIstioSidecarProxy] = "true"
 	}
 
-	k8sLabels[k8sConst.PolicyLabelCluster] = option.Config.ClusterName
-
 	for _, containers := range pod.Spec.Containers {
 		for _, cp := range containers.Ports {
 			containerPorts = append(containerPorts, cp)
 		}
 	}
 
-	return containerPorts, k8sLabels, annotations, nil
+	labels := k8sUtils.SanitizePodLabels(k8sLabels, k8sNs, pod.Spec.ServiceAccountName, option.Config.ClusterName)
+
+	return containerPorts, labels, annotations, nil
 }
 
 // filterPodLabels returns a copy of the given labels map, without the labels owned by Cilium.
diff --git a/pkg/k8s/utils/utils.go b/pkg/k8s/utils/utils.go
index e5b69ea3b546f..ae5c79f2dee13 100644
--- a/pkg/k8s/utils/utils.go
+++ b/pkg/k8s/utils/utils.go
@@ -6,14 +6,17 @@ package utils
 import (
 	"net"
 	"sort"
+	"strings"
 
 	v1 "k8s.io/api/core/v1"
 	v1meta "k8s.io/apimachinery/pkg/apis/meta/v1"
 
 	"github.com/cilium/cilium/pkg/ip"
+	k8sconst "github.com/cilium/cilium/pkg/k8s/apis/cilium.io"
 	slim_corev1 "github.com/cilium/cilium/pkg/k8s/slim/k8s/api/core/v1"
 	"github.com/cilium/cilium/pkg/k8s/slim/k8s/apis/labels"
 	"github.com/cilium/cilium/pkg/k8s/slim/k8s/apis/selection"
+	labelsPkg "github.com/cilium/cilium/pkg/labels"
 )
 
 const (
@@ -191,3 +194,59 @@ func GetClusterIPByFamily(ipFamily slim_corev1.IPFamily, service *slim_corev1.Se
 
 	return ""
 }
+
+// SanitizePodLabels makes sure that no important pod labels were overridden manually
+func SanitizePodLabels(labels map[string]string, namespace *slim_corev1.Namespace, serviceAccount, clusterName string) map[string]string {
+	sanitizedLabels := make(map[string]string)
+
+	for k, v := range labels {
+		sanitizedLabels[k] = v
+	}
+	// Sanitize namespace labels
+	for k, v := range namespace.GetLabels() {
+		sanitizedLabels[joinPath(k8sconst.PodNamespaceMetaLabels, k)] = v
+	}
+	// Sanitize namespace name label
+	sanitizedLabels[k8sconst.PodNamespaceLabel] = namespace.ObjectMeta.Name
+	// Sanitize service account name
+	if serviceAccount != "" {
+		sanitizedLabels[k8sconst.PolicyLabelServiceAccount] = serviceAccount
+	} else {
+		delete(sanitizedLabels, k8sconst.PolicyLabelServiceAccount)
+	}
+	// Sanitize cluster name
+	sanitizedLabels[k8sconst.PolicyLabelCluster] = clusterName
+
+	return sanitizedLabels
+}
+
+// StripPodSpecialLabels strips labels that are not supposed to be coming from a k8s pod object
+func StripPodSpecialLabels(labels map[string]string) map[string]string {
+	sanitizedLabels := make(map[string]string)
+	forbiddenKeys := map[string]struct{}{
+		k8sconst.PodNamespaceMetaLabels:    {},
+		k8sconst.PolicyLabelServiceAccount: {},
+		k8sconst.PolicyLabelCluster:        {},
+		k8sconst.PodNamespaceLabel:         {},
+	}
+	for k, v := range labels {
+		// If the key contains the prefix for namespace labels then we will
+		// ignore it.
+		if strings.HasPrefix(k, k8sconst.PodNamespaceMetaLabels) {
+			continue
+		}
+		// If the key belongs to any of the forbiddenKeys then we will ignore
+		// it.
+		_, ok := forbiddenKeys[k]
+		if ok {
+			continue
+		}
+		sanitizedLabels[k] = v
+	}
+	return sanitizedLabels
+}
+
+// joinPath mimics JoinPath from pkg/policy/utils, which could not be imported here due to circular dependency
+func joinPath(a, b string) string {
+	return a + labelsPkg.PathDelimiter + b
+}
diff --git a/pkg/k8s/utils/utils_test.go b/pkg/k8s/utils/utils_test.go
index 4debdd7f1796b..af0a35b369dc1 100644
--- a/pkg/k8s/utils/utils_test.go
+++ b/pkg/k8s/utils/utils_test.go
@@ -10,6 +10,10 @@ import (
 	corev1 "k8s.io/api/core/v1"
 	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
 	"k8s.io/client-go/kubernetes/fake"
+
+	k8sconst "github.com/cilium/cilium/pkg/k8s/apis/cilium.io"
+	slim_corev1 "github.com/cilium/cilium/pkg/k8s/slim/k8s/api/core/v1"
+	slim_metav1 "github.com/cilium/cilium/pkg/k8s/slim/k8s/apis/meta/v1"
 )
 
 type fakeCfg struct {
@@ -72,3 +76,64 @@ func TestServiceProxyName(t *testing.T) {
 		t.Fatalf("Expected test-svc-3, retrieved: %v", svcs)
 	}
 }
+
+func TestSanitizePodLabels(t *testing.T) {
+	namespaceLabelKey := "wow-very-key"
+	namespaceMetaLabelKey := joinPath(k8sconst.PodNamespaceMetaLabels, namespaceLabelKey)
+	testedLabels := map[string]string{
+		k8sconst.PodNamespaceLabel:         "fake-namespace",
+		k8sconst.PolicyLabelServiceAccount: "fake-sa",
+		k8sconst.PolicyLabelCluster:        "fake-cluster-name",
+		namespaceMetaLabelKey:              "fake-namespace-label-val",
+		k8sconst.PodNameLabel:              "fake-pod-name",
+	}
+	trueNamespace := "true-namespace"
+	trueSA := "true-sa"
+	trueClusterName := "true-cluster-name"
+	trueNamespaceLabelValue := "true-value-for-key"
+
+	namespace := &slim_corev1.Namespace{
+		ObjectMeta: slim_metav1.ObjectMeta{Name: trueNamespace,
+			Labels: map[string]string{
+				namespaceLabelKey: trueNamespaceLabelValue,
+			}}}
+	labels := SanitizePodLabels(testedLabels, namespace, trueSA, trueClusterName)
+
+	ns, ok := labels[k8sconst.PodNamespaceLabel]
+	if !ok {
+		t.Errorf("namespace label not found")
+	}
+	if ns != trueNamespace {
+		t.Errorf("namespace label not set to %s, set to %s instead", trueNamespace, namespace)
+	}
+
+	sa, ok := labels[k8sconst.PolicyLabelServiceAccount]
+	if !ok {
+		t.Errorf("sa label not found")
+	}
+	if sa != trueSA {
+		t.Errorf("sa label not set to %s, set to %s instead", trueSA, sa)
+	}
+
+	clusterName, ok := labels[k8sconst.PolicyLabelCluster]
+	if !ok {
+		t.Errorf("cluster name label not found")
+	}
+	if clusterName != trueClusterName {
+		t.Errorf("cluster name label not set to %s, set to %s instead", trueClusterName, clusterName)
+	}
+
+	namespaceMetaLabel, ok := labels[namespaceMetaLabelKey]
+	if !ok {
+		t.Errorf("namespace meta label not found")
+	}
+	if namespaceMetaLabel != trueNamespaceLabelValue {
+		t.Errorf("namespace meta label not set to %s, set to %s instead", trueNamespaceLabelValue, namespaceMetaLabel)
+	}
+
+	labels = SanitizePodLabels(testedLabels, namespace, "", trueClusterName)
+	sa, ok = labels[k8sconst.PolicyLabelServiceAccount]
+	if ok {
+		t.Errorf("Expected service account label to be deleted, got %s instead", sa)
+	}
+}
diff --git a/pkg/k8s/watchers/pod.go b/pkg/k8s/watchers/pod.go
index b7f186c3b08d3..219277d5fbb4c 100644
--- a/pkg/k8s/watchers/pod.go
+++ b/pkg/k8s/watchers/pod.go
@@ -298,8 +298,12 @@ func (k *K8sWatcher) updateK8sPodV1(oldK8sPod, newK8sPod *slim_corev1.Pod) error
 
 	// Check label updates too.
 	oldK8sPodLabels, _ := labelsfilter.Filter(labels.Map2Labels(oldK8sPod.ObjectMeta.Labels, labels.LabelSourceK8s))
-	oldPodLabels := oldK8sPodLabels.K8sStringMap()
-	newK8sPodLabels, _ := labelsfilter.Filter(labels.Map2Labels(newK8sPod.ObjectMeta.Labels, labels.LabelSourceK8s))
+	// old labels are stripped to avoid grandfathering in special labels
+	oldPodLabels := k8sUtils.StripPodSpecialLabels(oldK8sPodLabels.K8sStringMap())
+
+	strippedNewLabels := k8sUtils.StripPodSpecialLabels(newK8sPod.Labels)
+
+	newK8sPodLabels, _ := labelsfilter.Filter(labels.Map2Labels(strippedNewLabels, labels.LabelSourceK8s))
 	newPodLabels := newK8sPodLabels.K8sStringMap()
 	labelsChanged := !comparator.MapStringEquals(oldPodLabels, newPodLabels)
 
