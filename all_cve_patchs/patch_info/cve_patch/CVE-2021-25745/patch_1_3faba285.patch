From 3faba285f509e46d04997f7c0f0597efba5ae8c5 Mon Sep 17 00:00:00 2001
From: Ricardo Pchevuzinske Katz <ricardo.katz@gmail.com>
Date: Mon, 23 May 2022 21:01:31 -0300
Subject: [PATCH] Improve path rule

---
 internal/ingress/inspector/rules.go      | 4 ++--
 internal/ingress/inspector/rules_test.go | 5 +++++
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/internal/ingress/inspector/rules.go b/internal/ingress/inspector/rules.go
index 9c9ade0f2f..ab573b7fe3 100644
--- a/internal/ingress/inspector/rules.go
+++ b/internal/ingress/inspector/rules.go
@@ -22,8 +22,8 @@ import (
 )
 
 var (
-	invalidAliasDirective = regexp.MustCompile(`\s*alias\s*.*;`)
-	invalidRootDirective  = regexp.MustCompile(`\s*root\s*.*;`)
+	invalidAliasDirective = regexp.MustCompile(`(?s)\s*alias\s*.*;`)
+	invalidRootDirective  = regexp.MustCompile(`(?s)\s*root\s*.*;`)
 	invalidEtcDir         = regexp.MustCompile(`/etc/(passwd|shadow|group|nginx|ingress-controller)`)
 	invalidSecretsDir     = regexp.MustCompile(`/var/run/secrets`)
 	invalidByLuaDirective = regexp.MustCompile(`.*_by_lua.*`)
diff --git a/internal/ingress/inspector/rules_test.go b/internal/ingress/inspector/rules_test.go
index 3c8f9f47b4..6ed6dbe87a 100644
--- a/internal/ingress/inspector/rules_test.go
+++ b/internal/ingress/inspector/rules_test.go
@@ -35,6 +35,11 @@ func TestCheckRegex(t *testing.T) {
 			wantErr: true,
 			value:   "   alias    blabla/lala ;",
 		},
+		{
+			name:    "must refuse invalid alias with line break",
+			wantErr: true,
+			value:   "alias #\n/lalala/1/;",
+		},
 		{
 			name:    "must refuse invalid attempt to call /etc",
 			wantErr: true,
