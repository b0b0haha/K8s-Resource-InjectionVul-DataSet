From bb82371bf3a23b06aa4d1db0c1f491795d0cbf43 Mon Sep 17 00:00:00 2001
From: Ivan Towlson <itowlson@microsoft.com>
Date: Fri, 12 Feb 2021 16:45:11 +1300
Subject: [PATCH] Ignore tool paths at workspace level

---
 package.json                    | 99 ++++++++++++++++++++++++++++-----
 src/components/config/config.ts | 50 +++++++++++++----
 2 files changed, 126 insertions(+), 23 deletions(-)

diff --git a/package.json b/package.json
index cedbc8ca1..af867df85 100644
--- a/package.json
+++ b/package.json
@@ -100,10 +100,11 @@
     "contributes": {
         "configuration": {
             "type": "object",
-            "title": "Kubernetes configuration",
+            "title": "Kubernetes",
             "properties": {
                 "vs-kubernetes": {
                     "type": "object",
+                    "title": "Additional settings",
                     "description": "Kubernetes configuration",
                     "properties": {
                         "vs-kubernetes.namespace": {
@@ -112,51 +113,51 @@
                         },
                         "vs-kubernetes.kubectl-path": {
                             "type": "string",
-                            "description": "File path to a kubectl binary."
+                            "description": "[deprecated - use top level property] File path to a kubectl binary."
                         },
                         "vs-kubernetes.helm-path": {
                             "type": "string",
-                            "description": "File path to a helm binary."
+                            "description": "[deprecated - use top level property] File path to a helm binary."
                         },
                         "vs-kubernetes.minikube-path": {
                             "type": "string",
-                            "description": "File path to a minikube binary."
+                            "description": "[deprecated - use top level property] File path to a minikube binary."
                         },
                         "vs-kubernetes.kubectl-path.windows": {
                             "type": "string",
-                            "description": "File path to a kubectl binary."
+                            "description": "[deprecated - use top level property] File path to a kubectl binary."
                         },
                         "vs-kubernetes.helm-path.windows": {
                             "type": "string",
-                            "description": "File path to a helm binary."
+                            "description": "[deprecated - use top level property] File path to a helm binary."
                         },
                         "vs-kubernetes.minikube-path.windows": {
                             "type": "string",
-                            "description": "File path to a minikube binary."
+                            "description": "[deprecated - use top level property] File path to a minikube binary."
                         },
                         "vs-kubernetes.kubectl-path.mac": {
                             "type": "string",
-                            "description": "File path to a kubectl binary."
+                            "description": "[deprecated - use top level property] File path to a kubectl binary."
                         },
                         "vs-kubernetes.helm-path.mac": {
                             "type": "string",
-                            "description": "File path to a helm binary."
+                            "description": "[deprecated - use top level property] File path to a helm binary."
                         },
                         "vs-kubernetes.minikube-path.mac": {
                             "type": "string",
-                            "description": "File path to a minikube binary."
+                            "description": "[deprecated - use top level property] File path to a minikube binary."
                         },
                         "vs-kubernetes.kubectl-path.linux": {
                             "type": "string",
-                            "description": "File path to a kubectl binary."
+                            "description": "[deprecated - use top level property] File path to a kubectl binary."
                         },
                         "vs-kubernetes.helm-path.linux": {
                             "type": "string",
-                            "description": "File path to a helm binary."
+                            "description": "[deprecated - use top level property] File path to a helm binary."
                         },
                         "vs-kubernetes.minikube-path.linux": {
                             "type": "string",
-                            "description": "File path to a minikube binary."
+                            "description": "[deprecated - use top level property] File path to a minikube binary."
                         },
                         "vs-kubernetes.kubectlVersioning": {
                             "type": "string",
@@ -286,6 +287,78 @@
                     "type": "string",
                     "default": null,
                     "description": "Image prefix for docker images ie 'docker.io/brendanburns'"
+                },
+                "vscode-kubernetes.kubectl-path": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Path to kubectl",
+                    "description": "File path to a kubectl binary. (You can override this on a per-OS basis if required)."
+                },
+                "vscode-kubernetes.helm-path": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Helm path",
+                    "description": "File path to a helm binary. (You can override this on a per-OS basis if required)."
+                },
+                "vscode-kubernetes.minikube-path": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Minikube path",
+                    "description": "File path to a minikube binary. (You can override this on a per-OS basis if required)."
+                },
+                "vscode-kubernetes.kubectl-path.windows": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Path to kubectl (Windows)",
+                    "description": "File path to a kubectl binary."
+                },
+                "vscode-kubernetes.helm-path.windows": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Helm path (Windows)",
+                    "description": "File path to a helm binary."
+                },
+                "vscode-kubernetes.minikube-path.windows": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Minikube path (Windows)",
+                    "description": "File path to a minikube binary."
+                },
+                "vscode-kubernetes.kubectl-path.mac": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Path to kubectl (Mac)",
+                    "description": "File path to a kubectl binary."
+                },
+                "vscode-kubernetes.helm-path.mac": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Helm path (Mac)",
+                    "description": "File path to a helm binary."
+                },
+                "vscode-kubernetes.minikube-path.mac": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Minikube path (Mac)",
+                    "description": "File path to a minikube binary."
+                },
+                "vscode-kubernetes.kubectl-path.linux": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Path to kubectl (Linux)",
+                    "description": "File path to a kubectl binary."
+                },
+                "vscode-kubernetes.helm-path.linux": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Helm path (Linux)",
+                    "description": "File path to a helm binary."
+                },
+                "vscode-kubernetes.minikube-path.linux": {
+                    "type": "string",
+                    "scope": "machine",
+                    "title": "Minikube path (Linux)",
+                    "description": "File path to a minikube binary."
                 }
             }
         },
diff --git a/src/components/config/config.ts b/src/components/config/config.ts
index 2682713de..b98b386d7 100644
--- a/src/components/config/config.ts
+++ b/src/components/config/config.ts
@@ -1,6 +1,7 @@
 import * as vscode from 'vscode';
 import { Host } from '../../host';
 import { Shell, Platform } from '../../shell';
+import { Dictionary } from '../../utils/dictionary';
 
 const EXTENSION_CONFIG_KEY = "vs-kubernetes";
 const KUBECONFIG_PATH_KEY = "vs-kubernetes.kubeconfig";
@@ -97,27 +98,56 @@ export function getActiveKubeconfig(): string {
 
 // Functions for working with tool paths
 
-export function getToolPath(host: Host, shell: Shell, tool: string): string | undefined {
-    const baseKey = toolPathBaseKey(tool);
-    return getPathSetting(host, shell, baseKey);
-}
-
-function getPathSetting(host: Host, shell: Shell, baseKey: string): string | undefined {
+export function getToolPath(_host: Host, shell: Shell, tool: string): string | undefined {
     const os = shell.platform();
-    const osOverridePath = host.getConfiguration(EXTENSION_CONFIG_KEY)[osOverrideKey(os, baseKey)];
-    return osOverridePath || host.getConfiguration(EXTENSION_CONFIG_KEY)[baseKey];
+
+    const config = vscode.workspace.getConfiguration();
+
+    const baseBackCompatKey = toolPathBackCompatBaseKey(tool);
+    const osBackCompatKey = osOverrideKey(os, baseBackCompatKey);
+    const backCompatSettings = config.inspect<Dictionary<any>>(EXTENSION_CONFIG_KEY);
+    const wsFolderValues = backCompatSettings?.workspaceFolderValue || {};
+    const wsValues = backCompatSettings?.workspaceValue || {};
+    const userValues = backCompatSettings?.globalValue || {};
+    const defaultValues = backCompatSettings?.defaultValue || {};
+
+    const localBackCompatSetting =
+        wsFolderValues[osBackCompatKey] ||
+        wsFolderValues[baseBackCompatKey] ||
+        wsValues[osBackCompatKey] ||
+        wsValues[baseBackCompatKey];
+
+    if (localBackCompatSetting) {
+        console.warn(`Ignoring workspace-level setting ${baseBackCompatKey}; paths are not allowed at workspace level`);
+    }
+
+    const globalBackCompatSetting =
+        userValues[osBackCompatKey] ||
+        userValues[baseBackCompatKey] ||
+        defaultValues[osBackCompatKey] ||
+        defaultValues[baseBackCompatKey];
+
+    const baseKey = toolPathNewBaseKey(tool);
+    const osKey = osOverrideKey(os, baseKey);
+    const topLevelToolPath = config.get<string>(osKey) || config.get<string>(baseKey);
+
+    return topLevelToolPath || globalBackCompatSetting;
 }
 
 export function toolPathOSKey(os: Platform, tool: string): string {
-    const baseKey = toolPathBaseKey(tool);
+    const baseKey = toolPathNewBaseKey(tool);
     const osSpecificKey = osOverrideKey(os, baseKey);
     return osSpecificKey;
 }
 
-function toolPathBaseKey(tool: string): string {
+function toolPathBackCompatBaseKey(tool: string): string {
     return `vs-kubernetes.${tool}-path`;
 }
 
+function toolPathNewBaseKey(tool: string): string {
+    return `vscode-kubernetes.${tool}-path`;
+}
+
 function osOverrideKey(os: Platform, baseKey: string): string {
     const osKey = osKeyString(os);
     return osKey ? `${baseKey}.${osKey}` : baseKey;  // The 'else' clause should never happen so don't worry that this would result in double-checking a missing base key
