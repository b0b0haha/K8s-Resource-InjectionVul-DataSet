From aab8d724a3d2aa1a3daa742aa8bf42d45cbb612e Mon Sep 17 00:00:00 2001
From: Peter Hunt <pehunt@redhat.com>
Date: Tue, 26 Mar 2024 12:07:17 -0400
Subject: [PATCH] annotations: add OCI runtime specific annotations to the
 AllowedAnnotations

meaning an admin would have to opt-into allowing them to be used

Signed-off-by: Peter Hunt <pehunt@redhat.com>
---
 pkg/annotations/annotations.go | 13 +++++++++++++
 test/workloads.bats            | 29 +++++++++++++++++++++++++++++
 2 files changed, 42 insertions(+)

diff --git a/pkg/annotations/annotations.go b/pkg/annotations/annotations.go
index 2560ff04819..76131ff8914 100644
--- a/pkg/annotations/annotations.go
+++ b/pkg/annotations/annotations.go
@@ -94,4 +94,17 @@ var AllAllowedAnnotations = []string{
 	PodLinuxResources,
 	LinkLogsAnnotation,
 	CPUSharedAnnotation,
+	// Keep in sync with
+	// https://github.com/opencontainers/runc/blob/3db0871f1cf25c7025861ba0d51d25794cb21623/features.go#L67
+	// Once runc 1.2 is released, we can use the `runc features` command to get this programatically,
+	// but we should hardcode these for now to prevent misuse.
+	"bundle",
+	"org.systemd.property.",
+	"org.criu.config",
+
+	// Simiarly, keep in sync with
+	// https://github.com/containers/crun/blob/475a3fd0be/src/libcrun/container.c#L362-L366
+	"module.wasm.image/variant",
+	"io.kubernetes.cri.container-type",
+	"run.oci.",
 }
diff --git a/test/workloads.bats b/test/workloads.bats
index 9cbf3f23de3..7970b07e8ac 100644
--- a/test/workloads.bats
+++ b/test/workloads.bats
@@ -391,3 +391,32 @@ function check_conmon_fields() {
 	ctr_id=$(crictl run "$ctrconfig" "$sboxconfig")
 	[[ $(crictl exec "$ctr_id" cat /sys/fs/cgroup/memory.max) != 4294967296 ]]
 }
+
+@test "test special runtime annotations not allowed" {
+	start_crio
+
+	jq --arg val "'inactive-or-failed'" '   .annotations["org.systemd.property.CollectMode"] = $val' \
+		"$TESTDATA"/sandbox_config.json > "$sboxconfig"
+
+	jq --arg val "'inactive-or-failed'" '   .annotations["org.systemd.property.CollectMode"] = $val' \
+		"$TESTDATA"/container_sleep.json > "$ctrconfig"
+
+	ctr_id=$(crictl run "$ctrconfig" "$sboxconfig")
+	[[ $(systemctl show --property CollectMode crio-$ctr_id.scope) != "CollectMode=inactive-or-failed" ]]
+}
+
+@test "test special runtime annotations allowed" {
+	create_workload_with_allowed_annotation "org.systemd.property." "org.systemd.property.CollectMode"
+
+	start_crio
+
+	jq --arg val "'inactive-or-failed'" '   .annotations["org.systemd.property.CollectMode"] = $val' \
+		"$TESTDATA"/sandbox_config.json > "$sboxconfig"
+
+	jq --arg val "'inactive-or-failed'" '   .annotations["org.systemd.property.CollectMode"] = $val' \
+		"$TESTDATA"/container_sleep.json > "$ctrconfig"
+
+	ctr_id=$(crictl run "$ctrconfig" "$sboxconfig")
+	systemctl show --property CollectMode crio-$ctr_id.scope
+	[[ $(systemctl show --property CollectMode crio-$ctr_id.scope) == "CollectMode=inactive-or-failed" ]]
+}
