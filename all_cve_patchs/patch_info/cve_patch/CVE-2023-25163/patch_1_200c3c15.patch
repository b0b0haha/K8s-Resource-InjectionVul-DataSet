From 200c3c156e9c27c6c5b197a5be28315e9b802b12 Mon Sep 17 00:00:00 2001
From: Michael Crenshaw <350466+crenshaw-dev@users.noreply.github.com>
Date: Tue, 7 Feb 2023 10:11:36 -0500
Subject: [PATCH] fix: sanitize repo creds in error messages (#12309)

Signed-off-by: Michael Crenshaw <350466+crenshaw-dev@users.noreply.github.com>
---
 util/argo/argo.go | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/util/argo/argo.go b/util/argo/argo.go
index 8d0cba1582fd6..bfa373d5cc4f4 100644
--- a/util/argo/argo.go
+++ b/util/argo/argo.go
@@ -288,7 +288,8 @@ func validateRepo(ctx context.Context,
 			return nil, err
 		}
 		if err := TestRepoWithKnownType(ctx, repoClient, repo, source.IsHelm(), source.IsHelmOci()); err != nil {
-			errMessage = fmt.Sprintf("repositories not accessible: %v", repo)
+			sanitizedRepo := sanitizeRepoForLogging(repo)
+			errMessage = fmt.Sprintf("repositories not accessible: %v", sanitizedRepo)
 		}
 		repoAccessible := false
 
@@ -338,6 +339,19 @@ func validateRepo(ctx context.Context,
 	return conditions, nil
 }
 
+func sanitizeRepoForLogging(repo *argoappv1.Repository) *argoappv1.Repository {
+	if repo == nil {
+		return nil
+	}
+	sanitizedRepo := &argoappv1.Repository{
+		Repo:    repo.Repo,
+		Type:    repo.Type,
+		Name:    repo.Name,
+		Project: repo.Project,
+	}
+	return sanitizedRepo
+}
+
 // GetRefSources creates a map of ref keys (from the sources' 'ref' fields) to information about the referenced source.
 // This function also validates the references use allowed characters and does not define the same ref key more than
 // once (which would lead to ambiguous references).
