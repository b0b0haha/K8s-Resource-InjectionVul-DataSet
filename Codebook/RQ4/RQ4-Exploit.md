# RQ4 漏洞利用条件分析Codebook

## 1. 总体说明

### 1.1 分析目标
从攻击模式和利用复杂度两个维度分析Kubernetes资源注入漏洞的触发条件，评估漏洞利用的难易程度和攻击者需要的技术要求。

### 1.2 关键概念
- **攻击模式**：基于注入机制特征的恶意内容利用方式
- **利用复杂度**：从资源操作和组件交互角度评估的攻击触发难度
- **组件**：具有明确功能边界和独立逻辑处理能力的软件模块或服务单元

### 1.3 分析原则
- 基于**具体的攻击流程**和**PoC细节**进行分析
- 关注**最低攻击要求**而非理论上的复杂场景
- 考虑**实际部署环境**中的触发条件

---

## 2. 攻击模式分类框架

### 2.1 静态配置注入 (Static Configuration Injection)

#### 定义
攻击者直接在配置字段中指定恶意值，这些值被系统原样使用而无需转换处理

#### 特征识别
- **直接恶意值**：攻击载荷直接写入资源字段
- **无转换处理**：字段值被系统直接使用，不经过复杂转换
- **配置时注入**：在资源创建或更新时即包含恶意内容
- **即时生效**：恶意配置立即或在下次处理时生效

#### 技术特征
- 字段值格式与最终使用格式一致
- 缺乏输入验证和过滤机制
- 恶意内容可直接识别和理解

#### 典型案例
- **CVE-2021-25741**：直接在nginx配置注解中写入恶意nginx指令
- **CVE-2024-10220**：在gitRepo.repository字段中直接指定恶意仓库路径
- **CVE-2021-25745**：在path字段中直接写入恶意nginx配置语句

#### 识别标准
- 攻击载荷在资源定义中明文可见
- 字段值与攻击效果有直接对应关系
- 不需要运行时的复杂处理或转换

### 2.2 动态参数生成攻击 (Dynamic Parameter-based Generation)

#### 定义
用户输入看似无害，但通过运行时处理转换为恶意值，主要通过突破预期处理上下文来操纵数据结构

#### 特征识别
- **看似无害输入**：初始输入内容看起来是正常参数
- **运行时转换**：通过模板渲染、命令构造、表达式评估等过程转换
- **上下文突破**：利用处理机制的特性改变预期行为
- **延迟生效**：恶意效果在运行时处理后才显现

#### 技术特征
- 涉及模板引擎、参数替换、动态配置生成
- 利用语法特性（如JSON模板、shell展开）
- 需要理解系统的处理逻辑和上下文

#### 主要场景
- **模板渲染注入**：利用模板引擎的变量替换机制
- **命令构造注入**：通过参数拼接影响最终命令
- **表达式评估注入**：利用动态表达式求值机制
- **配置合并注入**：通过配置合并过程覆盖关键参数

#### 典型案例
- **CVE-2021-37914**：通过Argo Workflows的参数覆盖机制，在运行时动态修改env字段

#### 识别标准
- 初始输入与最终攻击效果不直接对应
- 需要系统的运行时处理才能产生恶意效果
- 涉及复杂的数据转换或处理逻辑

---

## 3. 利用复杂度分析框架

### 3.1 API操作复杂度

#### 3.1.1 资源API个数分析
**定义**：完成攻击所需的最少Kubernetes API调用次数

**评估标准**：
- **单次API调用**：仅需一次CREATE/UPDATE操作
- **多次API调用**：需要多次资源操作配合
- **复杂API序列**：需要特定顺序的多个API操作

**分析方法**：
1. 识别攻击所需的所有API操作
2. 确定最少操作次数要求
3. 分析API操作间的依赖关系

#### 3.1.2 资源类别个数分析
**定义**：攻击涉及的不同Kubernetes资源类型数量

**评估标准**：
- **单一资源类型**：仅涉及一种K8s资源
- **多种资源类型**：需要操作多种不同资源
- **跨资源类型协作**：多种资源间需要协同配合

**典型模式**：
- Pod、Deployment、Service等工作负载资源
- ConfigMap、Secret等配置资源
- Ingress、Gateway等网络资源
- CustomResource等扩展资源

### 3.2 字段修改复杂度

#### 3.2.1 修改的资源字段个数
**定义**：触发漏洞所需修改的最少字段数量

**评估维度**：
- **必需字段**：必须修改才能触发漏洞的字段
- **可选字段**：可以增强攻击效果但非必需的字段
- **协同字段**：需要同时修改才能生效的字段组合

#### 3.2.2 字段关系分析
**分析维度**：
- **独立字段**：单独修改即可触发漏洞
- **依赖字段**：需要其他字段配合才能生效
- **互斥字段**：某些字段组合会相互冲突

#### 3.2.3 注入协同机制
**协同模式**：
- **同一资源内协同**：同一资源的多个字段配合
- **跨资源协同**：不同资源的字段需要配合
- **时序协同**：字段修改需要特定的时间顺序

### 3.3 组件交互复杂度

#### 3.3.1 组件定义和识别
**组件定义**：
在Kubernetes系统中承担特定功能职责的独立软件模块或服务单元，具有：
- 明确的功能边界和职责
- 独立的逻辑处理能力
- 通过明确接口进行交互

**组件类型**：
- **K8s内置组件**：API Server、etcd、kubelet、kube-proxy
- **控制器组件**：Deployment Controller、Service Controller等
- **第三方控制器**：Ingress Controller、Operator等
- **应用组件**：具体的应用服务和代理

#### 3.3.2 组件个数统计方法
**统计原则**：
- 仅统计**直接参与**漏洞触发流程的组件
- 不包括间接影响或无关的组件
- 按照攻击数据流经过的组件进行计数

**识别步骤**：
1. **梳理攻击流程**：从资源创建到漏洞触发的完整路径
2. **识别数据流**：恶意数据在各组件间的传播路径
3. **确定参与组件**：实际处理恶意数据的组件
4. **统计组件个数**：去重后的组件总数

#### 3.3.3 组件依赖关系分析
**依赖关系类型**：
- **顺序依赖**：组件需要按特定顺序处理
- **数据依赖**：组件间需要传递特定数据
- **状态依赖**：组件状态变化影响其他组件

**分析维度**：
- **调用链路**：组件间的调用关系和顺序
- **数据传递**：恶意数据在组件间的流动方式
- **状态同步**：组件状态变化的同步机制

---

## 4. 分析示例

### 4.1 CVE-2021-25741分析

**攻击模式分析**：
- **模式类型**：静态配置注入
- **分析依据**：直接在nginx配置注解中写入恶意配置指令，无需运行时转换

**利用复杂度分析**：
- **API操作复杂度**：1次API调用（CREATE/UPDATE Ingress）
- **资源类别个数**：1个（Ingress资源）
- **字段修改个数**：1个字段（configuration-snippet注解）
- **组件交互复杂度**：2个组件
  - 组件1：Ingress Controller（处理Ingress资源）
  - 组件2：Nginx（执行配置文件）
- **依赖关系**：Ingress Controller读取注解 → 生成nginx配置 → Nginx加载配置

### 4.2 CVE-2021-37914分析

**攻击模式分析**：
- **模式类型**：动态参数生成攻击
- **分析依据**：通过看似正常的参数输入，在运行时通过模板处理机制覆盖env字段

**利用复杂度分析**：
- **API操作复杂度**：1次API调用（提交workflow）
- **资源类别个数**：1个（Workflow资源）
- **字段修改个数**：1个字段（运行时参数）
- **组件交互复杂度**：3个组件
  - 组件1：Argo Workflows Controller（处理workflow）
  - 组件2：参数处理引擎（动态参数替换）
  - 组件3：容器运行时（执行最终命令）
- **依赖关系**：参数提交 → 模板处理 → 字段覆盖 → 容器执行

---

## 5. 质量控制

### 5.1 分析一致性要求
- 基于具体的PoC和攻击流程进行分析
- 统计最少攻击要求而非最复杂场景
- 确保组件识别的准确性和完整性

### 5.2 复杂度评估标准
- API操作数基于实际最少需求
- 字段修改数仅计算必需字段
- 组件数基于直接参与的组件

### 5.3 边界情况处理
- **可选攻击路径**：选择最简单的攻击路径进行分析
- **环境差异**：基于典型部署环境进行评估
- **权限假设**：基于攻击者已有的基础权限进行分析