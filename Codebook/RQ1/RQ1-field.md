# RQ1 易受攻击字段特征分析Codebook

## 1. 总体说明

### 1.1 分析目标
基于漏洞补丁、漏洞信息和利用技术细节，准确识别和分类Kubernetes资源注入漏洞中的易受攻击字段，从位置特征和功能特征两个维度进行系统性分析。

### 1.2 关键概念
- **易受攻击字段**：成为资源注入攻击向量的Kubernetes资源字段
- **位置特征**：字段在Kubernetes资源结构中的位置（metadata、spec、status）
- **功能特征**：字段在组件实现中的具体功能用途和处理方式

### 1.3 分析原则
- 基于**补丁变更**和**漏洞利用细节**确定受影响字段
- 结合**字段语义**和**组件实现**进行功能分类
- 考虑**K8s资源结构**和**应用特定功能**

---

## 2. 字段识别方法

### 2.1 字段识别流程

#### Step 1: 补丁分析确定字段
**目标**：从漏洞补丁中识别被修复的字段

**识别方法**：
- 分析补丁中新增或修改的验证逻辑
- 查找补丁中直接提及的字段路径
- 识别受影响的资源类型和字段名称

**示例**：
```go
// CVE-2021-25741补丁分析
// 补丁路径：pkg/apis/networking/v1/ingress.go
// 受影响字段：metadata.annotations["nginx.ingress.kubernetes.io/configuration-snippet"]
```

#### Step 2: 漏洞信息确认字段
**目标**：通过CVE描述和安全公告确认字段

**确认方法**：
- 查看CVE描述中提及的资源字段
- 分析PoC代码中使用的字段
- 结合攻击向量描述确定注入点

#### Step 3: 利用技术细节验证
**目标**：通过具体的利用技术确认字段用途

**验证方法**：
- 分析攻击载荷如何利用特定字段
- 理解字段值如何被组件处理和执行
- 确定字段在攻击链中的作用

---

## 3. 字段位置分类框架

### 3.1 资源元数据 (metadata)

#### 定义
包含资源识别和配置信息的元数据部分，通常用于资源管理和控制器识别

#### 子类别

**基本信息字段**：
- **字段示例**：apiVersion、kind、name、namespace、uid、generation
- **特征**：系统管理字段，通常应该是不可变的
- **漏洞模式**：错误地允许用户修改系统管理字段
- **典型案例**：CVE-2025-1098中的UID字段注入

**标签 (labels)**：
- **字段示例**：metadata.labels.*
- **特征**：用于资源选择和分组的键值对
- **漏洞模式**：通过标签注入影响资源选择逻辑
- **典型案例**：CVE-2023-39347中通过Pod标签绕过网络策略

**注解 (annotations)**：
- **字段示例**：metadata.annotations.*
- **特征**：存储非标识性元数据，通常用于配置扩展功能
- **漏洞模式**：注解值被直接用于配置生成或命令执行
- **典型案例**：CVE-2021-25741中的nginx配置注解注入

#### 识别标准
- 字段路径以`metadata.`开头
- 字段用于资源识别、分类或元数据存储
- 通常由用户在资源创建时设置

### 3.2 资源规约 (spec)

#### 定义
定义用户期望的资源状态配置，包含资源的核心功能定义

#### 特征
- 字段路径以`spec.`开头
- 用户可直接配置和修改
- 包含资源的主要功能参数

#### 漏洞模式
- 规约字段值直接用于系统操作
- 缺乏充分的输入验证和过滤
- 字段值传播到特权操作中

#### 典型案例
- CVE-2021-25745：spec.rules[].http.paths[].path字段注入
- CVE-2024-10220：spec.volumes[].gitRepo.repository字段注入
- CVE-2022-21701：spec.servers[].port字段和相关配置注入

#### 识别标准
- 字段路径以`spec.`开头
- 定义资源的核心功能配置
- 直接影响资源的行为和操作

### 3.3 资源状态 (status)

#### 定义
记录资源的当前实际状态，通常由控制器维护

#### 特征
- 字段路径以`status.`开头
- 理论上用户不应直接修改
- 由系统组件和控制器更新

#### 漏洞模式
- 错误地授予用户对status字段的写权限
- status字段值被其他组件信任和使用
- 缺乏对status字段修改的权限检查

#### 典型案例
- CVE-2020-8554：status.loadBalancer.ingress.ip字段权限配置错误

#### 识别标准
- 字段路径以`status.`开头
- 漏洞源于权限配置错误
- 不当的用户写权限授予

---

## 4. 字段功能分类框架

### 4.1 路径匹配类字段 (Path Matching Fields)

#### 定义
控制资源访问路径、URL路由、文件路径等的字段

#### 功能特征
- 用于路径解析和匹配
- 影响网络路由或文件系统访问
- 通常涉及路径遍历或URL构造

#### 典型字段
- `ingress.spec.rules[].host`：主机名匹配
- `ingress.spec.rules[].http.paths[].path`：URL路径匹配
- `volumeMount.mountPath`：容器内挂载路径
- `hostPath.path`：宿主机路径

#### 漏洞模式
- 路径遍历攻击（../../../etc/passwd）
- 恶意URL构造
- 文件系统访问绕过

#### 典型案例
- CVE-2021-25745：通过path字段注入nginx配置
- CVE-2022-24731：通过路径字段实现路径遍历

#### 识别标准
- 字段名包含path、host、url、route等关键词
- 字段值用于路径解析或匹配逻辑
- 漏洞涉及路径遍历或URL构造

### 4.2 命令执行类字段 (Command Execution Fields)

#### 定义
直接或间接执行系统命令、脚本、程序的字段

#### 功能特征
- 字段值最终传递给命令执行函数
- 影响容器启动或生命周期管理
- 涉及脚本执行或程序调用

#### 典型字段
- `container.command`：容器启动命令
- `container.args`：命令行参数
- `lifecycle.postStart.exec.command`：生命周期钩子命令
- `lifecycle.preStop.exec.command`：停止前执行命令

#### 漏洞模式
- 命令注入和参数注入
- Shell脚本注入
- 环境变量注入影响命令执行

#### 典型案例
- CVE-2024-10220：通过gitRepo字段注入git命令参数
- CVE-2022-1708/CVE-2022-31030：lifecycle钩子命令注入

#### 识别标准
- 字段名包含command、args、exec、script等关键词
- 字段值用于构造或执行系统命令
- 漏洞涉及命令注入或代码执行

### 4.3 资源引用类字段 (Resource Reference Fields)

#### 定义
引用其他Kubernetes资源或外部资源的字段

#### 功能特征
- 建立资源间的关联关系
- 用于数据共享和配置传递
- 涉及跨资源的数据流动

#### 典型字段
- `configMapRef`：ConfigMap资源引用
- `secretRef`：Secret资源引用
- `serviceAccountName`：ServiceAccount引用
- `volumes[].gitRepo.repository`：外部Git仓库引用

#### 漏洞模式
- 跨命名空间资源访问
- 外部资源引用注入
- 资源引用链攻击

#### 典型案例
- CVE-2024-43803：跨命名空间Secret引用
- CVE-2024-3177：envFrom字段Secret引用绕过
- CVE-2021-41254：资源引用链中的验证断裂

#### 识别标准
- 字段名包含Ref、Name、Reference等关键词
- 字段值用于引用其他资源
- 漏洞涉及资源访问权限或引用验证

### 4.4 应用特定功能字段 (Application-Specific Fields)

#### 定义
特定于某个应用或控制器的功能字段，实现应用特有的业务逻辑

#### 子分类

**4.4.1 应用内相似性 (Intra-application Similarity)**
- **定义**：同一应用中功能相似的字段表现出相同的漏洞模式
- **特征**：相同应用的不同字段实现类似功能，存在相同安全缺陷
- **示例**：CVE-2021-25741和CVE-2021-25745中Ingress的configuration-snippet注解和path字段

**4.4.2 应用间相似性 (Inter-application Similarity)**
- **定义**：不同应用实现相同功能的字段表现出相似的漏洞模式
- **特征**：实现相同功能的不同应用存在相似的安全缺陷
- **示例**：CRI-O和containerd的lifecycle.preStop和lifecycle.postStart字段（CVE-2022-1708和CVE-2022-31030）

#### 功能特征
- 实现应用特定的业务逻辑
- 字段语义与应用功能紧密相关
- 通常需要结合应用文档理解字段用途

#### 典型字段
- `nginx.ingress.kubernetes.io/configuration-snippet`：Nginx配置片段
- `istio.io/rev`：Istio版本标识
- `spec.servers[].port`：Gateway端口配置
- `io.kubernetes.cri-o.UnifiedCgroup`：CRI-O资源限制注解

#### 漏洞模式
- 应用特定的配置注入
- 业务逻辑绕过
- 功能扩展点的安全缺陷

#### 识别标准
- 字段属于特定应用或控制器的扩展功能
- 字段命名包含应用或组件标识
- 需要结合应用功能文档理解字段用途

---

## 5. 分析决策矩阵

### 5.1 位置分类决策树
```
字段位置分析
├── 字段路径以metadata.开头？
│   ├── YES → metadata类别
│   │   ├── labels.* → 标签字段
│   │   ├── annotations.* → 注解字段
│   │   └── name/uid/namespace → 基本信息字段
├── 字段路径以spec.开头？ → spec类别
├── 字段路径以status.开头？ → status类别
└── 其他路径 → 特殊情况，需要具体分析
```

### 5.2 功能分类决策树
```
字段功能分析
├── 字段用于路径/URL/文件处理？ → 路径匹配类字段
├── 字段用于命令/脚本执行？ → 命令执行类字段
├── 字段用于引用其他资源？ → 资源引用类字段
├── 字段属于应用特定功能？ → 应用特定功能字段
│   ├── 同应用其他字段有相似漏洞？ → 应用内相似性
│   └── 其他应用相似字段有相似漏洞？ → 应用间相似性
└── 无法归类 → 需要创建新类别或重新分析
```

### 5.3 综合分析矩阵

| 位置\功能 | 路径匹配 | 命令执行 | 资源引用 | 应用特定 |
|-----------|----------|----------|----------|----------|
| metadata | 注解路径配置 | 注解命令注入 | ServiceAccount引用 | 应用特定注解 |
| spec | 路径规约字段 | 容器命令字段 | 资源引用字段 | 应用配置字段 |
| status | 路径状态字段 | - | 状态引用字段 | 应用状态字段 |

---

## 6. 分析示例

### 6.1 CVE-2021-25741字段分析

**字段识别**：
- **受影响字段**：`metadata.annotations["nginx.ingress.kubernetes.io/configuration-snippet"]`
- **资源类型**：Ingress
- **识别依据**：补丁新增对该注解的验证逻辑

**位置分类**：
- **分类结果**：metadata - 注解 (annotations)
- **分类依据**：字段路径为metadata.annotations.*

**功能分类**：
- **分类结果**：应用特定功能字段 - 应用内相似性
- **分类依据**：nginx.ingress.kubernetes.io前缀表明为Nginx Ingress控制器特定功能，与CVE-2021-25745的path字段表现出相似的配置注入漏洞模式

### 6.2 CVE-2024-10220字段分析

**字段识别**：
- **受影响字段**：`spec.volumes[].gitRepo.repository`
- **资源类型**：Pod/Volume
- **识别依据**：补丁对gitRepo.repository字段新增协议验证

**位置分类**：
- **分类结果**：spec
- **分类依据**：字段路径为spec.volumes.*

**功能分类**：
- **分类结果**：资源引用类字段
- **分类依据**：repository字段用于引用外部Git仓库资源，漏洞涉及外部资源引用的安全验证

---

## 7. 质量控制

### 7.1 字段识别验证
- 必须基于具体的补丁代码确认字段
- 通过漏洞描述和PoC验证字段用途
- 结合组件实现理解字段处理逻辑

### 7.2 分类一致性检查
- 位置分类基于字段在K8s资源结构中的实际位置
- 功能分类基于字段在组件中的具体用途
- 多名分析师交叉验证分类结果

### 7.3 边界情况处理
- **多功能字段**：按主要功能进行分类
- **复合字段路径**：按最具体的路径层级分类
- **新字段类型**：建立新类别并记录分类标准