# 清理Commits字段脚本说明

## 功能描述

这些脚本用于处理 `cve_patch-deduplicated.json` 文件中每个Item的"commits"字段，只保留"url"、"hash"和"date"字段，删除其他字段（如"type"、"date_source"等）。

## 脚本文件

### 1. clean_commits_fields.py
- **功能**: 完整版脚本，包含详细的错误处理和统计信息
- **特点**: 
  - 创建新的数据结构，不修改原始数据
  - 提供详细的处理统计信息
  - 包含完整的错误处理机制

### 2. clean_commits_simple.py  
- **功能**: 简化版脚本，适用于大文件处理
- **特点**:
  - 直接修改原始数据结构
  - 更高效的内存使用
  - 代码更简洁

### 3. check_cleaned_data.py
- **功能**: 完整数据验证脚本
- **特点**:
  - 全面验证commits字段格式
  - 检查数据完整性
  - 生成详细验证报告
  - 比较原始文件和清理后文件

### 4. quick_check.py
- **功能**: 快速验证脚本
- **特点**:
  - 快速检查前10个记录
  - 简单易用
  - 适合初步验证

## 使用方法

### 方法1: 使用完整版脚本
```bash
python clean_commits_fields.py
```

### 方法2: 使用简化版脚本
```bash
python clean_commits_simple.py
```

### 方法3: 验证数据正确性
```bash
# 快速验证（推荐先运行）
python quick_check.py

# 完整验证
python check_cleaned_data.py
```

## 输入输出

- **输入文件**: `cve_patch-deduplicated.json`
- **输出文件**: `cve_patch-deduplicated-cleaned.json`

## 处理效果

### 原始数据格式:
```json
{
  "commits": [
    {
      "type": "url_only",
      "url": "https://github.com/kubernetes/kubernetes/commit/c7846fd24c16266a3bfd86315171f5b4d5f0c9c9",
      "hash": "c7846fd24c16266a3bfd86315171f5b4d5f0c9c9",
      "date": "2024-04-25T14:21:51+00:00",
      "date_source": "github_api"
    }
  ]
}
```

### 清理后格式:
```json
{
  "commits": [
    {
      "url": "https://github.com/kubernetes/kubernetes/commit/c7846fd24c16266a3bfd86315171f5b4d5f0c9c9",
      "hash": "c7846fd24c16266a3bfd86315171f5b4d5f0c9c9",
      "date": "2024-04-25T14:21:51+00:00"
    }
  ]
}
```

## 注意事项

1. 脚本会保留原始文件，生成新的清理后文件
2. 如果输出文件已存在，会被覆盖
3. 建议在处理前备份原始文件
4. 对于大文件，建议使用简化版脚本以提高处理速度

## 错误处理

脚本包含以下错误处理机制：
- 检查输入文件是否存在
- JSON解析错误处理
- 文件读写错误处理
- 数据类型检查

## 验证功能

### 快速验证 (quick_check.py)
- 检查前10个记录的commits字段格式
- 验证是否只包含url、hash、date字段
- 显示格式正确率

### 完整验证 (check_cleaned_data.py)
- 全面检查所有记录的commits字段
- 验证数据完整性（记录数、commit数是否匹配）
- 生成详细错误报告
- 保存验证结果到JSON文件

## 统计信息

脚本运行完成后会显示：
- 处理的记录数量
- 原始文件和清理后文件的大小
- 总commit数量和清理后commit数量
- 数据验证结果和正确率 