#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
数据验证脚本：检查清理后的JSON数据是否正确
验证commits字段只包含url、hash、date字段
"""

import json
import os
from typing import Dict, List, Any, Set

def check_commits_fields(data: List[Dict[str, Any]]) -> Dict[str, Any]:
    """
    检查commits字段的格式是否正确
    
    Args:
        data: JSON数据列表
        
    Returns:
        检查结果字典
    """
    results = {
        'total_items': len(data),
        'items_with_commits': 0,
        'total_commits': 0,
        'valid_commits': 0,
        'invalid_commits': 0,
        'errors': [],
        'unexpected_fields': set(),
        'missing_fields': set()
    }
    
    # 期望的字段
    expected_fields = {'url', 'hash', 'date'}
    
    for i, item in enumerate(data):
        if 'commits' in item:
            results['items_with_commits'] += 1
            
            if isinstance(item['commits'], list):
                for j, commit in enumerate(item['commits']):
                    results['total_commits'] += 1
                    
                    if isinstance(commit, dict):
                        # 检查是否只包含期望的字段
                        current_fields = set(commit.keys())
                        unexpected = current_fields - expected_fields
                        missing = expected_fields - current_fields
                        
                        if unexpected:
                            results['unexpected_fields'].update(unexpected)
                            results['errors'].append({
                                'item_index': i,
                                'commit_index': j,
                                'type': 'unexpected_fields',
                                'fields': list(unexpected),
                                'commit': commit
                            })
                            results['invalid_commits'] += 1
                        elif missing:
                            results['missing_fields'].update(missing)
                            results['errors'].append({
                                'item_index': i,
                                'commit_index': j,
                                'type': 'missing_fields',
                                'fields': list(missing),
                                'commit': commit
                            })
                            results['invalid_commits'] += 1
                        else:
                            results['valid_commits'] += 1
                    else:
                        results['errors'].append({
                            'item_index': i,
                            'commit_index': j,
                            'type': 'not_dict',
                            'commit': commit
                        })
                        results['invalid_commits'] += 1
    
    # 转换set为list以便JSON序列化
    results['unexpected_fields'] = list(results['unexpected_fields'])
    results['missing_fields'] = list(results['missing_fields'])
    
    return results

def check_data_integrity(original_file: str, cleaned_file: str) -> Dict[str, Any]:
    """
    检查数据完整性，比较原始文件和清理后文件
    
    Args:
        original_file: 原始JSON文件路径
        cleaned_file: 清理后JSON文件路径
        
    Returns:
        完整性检查结果
    """
    integrity_results = {
        'original_items': 0,
        'cleaned_items': 0,
        'items_match': False,
        'original_commits': 0,
        'cleaned_commits': 0,
        'commits_count_match': False
    }
    
    try:
        # 读取原始文件
        with open(original_file, 'r', encoding='utf-8') as f:
            original_data = json.load(f)
        
        # 读取清理后文件
        with open(cleaned_file, 'r', encoding='utf-8') as f:
            cleaned_data = json.load(f)
        
        integrity_results['original_items'] = len(original_data)
        integrity_results['cleaned_items'] = len(cleaned_data)
        integrity_results['items_match'] = len(original_data) == len(cleaned_data)
        
        # 统计commit数量
        for item in original_data:
            if 'commits' in item and isinstance(item['commits'], list):
                integrity_results['original_commits'] += len(item['commits'])
        
        for item in cleaned_data:
            if 'commits' in item and isinstance(item['commits'], list):
                integrity_results['cleaned_commits'] += len(item['commits'])
        
        integrity_results['commits_count_match'] = (
            integrity_results['original_commits'] == integrity_results['cleaned_commits']
        )
        
    except Exception as e:
        integrity_results['error'] = str(e)
    
    return integrity_results

def print_results(results: Dict[str, Any], integrity_results: Dict[str, Any]):
    """打印检查结果"""
    print("=" * 60)
    print("数据验证结果")
    print("=" * 60)
    
    print(f"总记录数: {results['total_items']}")
    print(f"包含commits的记录数: {results['items_with_commits']}")
    print(f"总commit数: {results['total_commits']}")
    print(f"有效commit数: {results['valid_commits']}")
    print(f"无效commit数: {results['invalid_commits']}")
    
    if results['valid_commits'] > 0:
        valid_percentage = (results['valid_commits'] / results['total_commits']) * 100
        print(f"数据正确率: {valid_percentage:.2f}%")
    
    print("\n" + "-" * 40)
    print("数据完整性检查")
    print("-" * 40)
    
    print(f"原始文件记录数: {integrity_results['original_items']}")
    print(f"清理后文件记录数: {integrity_results['cleaned_items']}")
    print(f"记录数匹配: {'✓' if integrity_results['items_match'] else '✗'}")
    
    print(f"原始文件commit数: {integrity_results['original_commits']}")
    print(f"清理后文件commit数: {integrity_results['cleaned_commits']}")
    print(f"commit数匹配: {'✓' if integrity_results['commits_count_match'] else '✗'}")
    
    if results['unexpected_fields']:
        print(f"\n发现意外字段: {results['unexpected_fields']}")
    
    if results['missing_fields']:
        print(f"缺少字段: {results['missing_fields']}")
    
    if results['errors']:
        print(f"\n发现 {len(results['errors'])} 个错误:")
        for i, error in enumerate(results['errors'][:5]):  # 只显示前5个错误
            print(f"  错误 {i+1}: {error['type']} - 记录 {error['item_index']}, commit {error['commit_index']}")
        if len(results['errors']) > 5:
            print(f"  ... 还有 {len(results['errors']) - 5} 个错误")
    
    print("\n" + "=" * 60)
    if results['invalid_commits'] == 0 and integrity_results['items_match'] and integrity_results['commits_count_match']:
        print("✓ 数据验证通过！所有commits字段格式正确")
    else:
        print("✗ 数据验证失败！请检查上述错误信息")

def main():
    """主函数"""
    original_file = "cve_patch-deduplicated.json"
    cleaned_file = "cve_patch-deduplicated-cleaned.json"
    
    # 检查文件是否存在
    if not os.path.exists(original_file):
        print(f"错误：原始文件 {original_file} 不存在")
        return
    
    if not os.path.exists(cleaned_file):
        print(f"错误：清理后文件 {cleaned_file} 不存在")
        print("请先运行清理脚本生成清理后的文件")
        return
    
    try:
        print("正在读取清理后的文件...")
        with open(cleaned_file, 'r', encoding='utf-8') as f:
            cleaned_data = json.load(f)
        
        print("正在验证数据格式...")
        results = check_commits_fields(cleaned_data)
        
        print("正在检查数据完整性...")
        integrity_results = check_data_integrity(original_file, cleaned_file)
        
        # 打印结果
        print_results(results, integrity_results)
        
        # 保存详细报告
        report_file = "data_validation_report.json"
        report = {
            'validation_results': results,
            'integrity_results': integrity_results,
            'timestamp': str(__import__('datetime').datetime.now())
        }
        
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        print(f"\n详细报告已保存到: {report_file}")
        
    except json.JSONDecodeError as e:
        print(f"JSON解析错误: {e}")
    except Exception as e:
        print(f"检查过程中发生错误: {e}")

if __name__ == "__main__":
    main() 