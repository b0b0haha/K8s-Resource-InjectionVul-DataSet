#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
脚本功能：处理JSON文件中每个Item的"commits"字段，只保留"url"、"hash"和"date"字段
输入文件：cve_patch-deduplicated.json
输出文件：cve_patch-deduplicated-cleaned.json
"""

import json
import os
from typing import Dict, List, Any

def clean_commits_fields(data: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    清理每个Item中commits字段，只保留url、hash、date字段
    
    Args:
        data: 原始JSON数据列表
        
    Returns:
        清理后的数据列表
    """
    cleaned_data = []
    
    for item in data:
        cleaned_item = item.copy()
        
        # 如果存在commits字段且是列表
        if 'commits' in cleaned_item and isinstance(cleaned_item['commits'], list):
            cleaned_commits = []
            
            for commit in cleaned_item['commits']:
                if isinstance(commit, dict):
                    # 只保留指定的字段
                    cleaned_commit = {}
                    for field in ['url', 'hash', 'date']:
                        if field in commit:
                            cleaned_commit[field] = commit[field]
                    
                    cleaned_commits.append(cleaned_commit)
                else:
                    # 如果不是字典，保持原样
                    cleaned_commits.append(commit)
            
            cleaned_item['commits'] = cleaned_commits
        
        cleaned_data.append(cleaned_item)
    
    return cleaned_data

def main():
    """主函数"""
    input_file = "cve_patch-deduplicated.json"
    output_file = "cve_patch-deduplicated-cleaned.json"
    
    # 检查输入文件是否存在
    if not os.path.exists(input_file):
        print(f"错误：输入文件 {input_file} 不存在")
        return
    
    try:
        # 读取原始JSON文件
        print(f"正在读取文件: {input_file}")
        with open(input_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        print(f"成功读取 {len(data)} 条记录")
        
        # 清理commits字段
        print("正在清理commits字段...")
        cleaned_data = clean_commits_fields(data)
        
        # 保存清理后的数据
        print(f"正在保存到文件: {output_file}")
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(cleaned_data, f, indent=2, ensure_ascii=False)
        
        print("处理完成！")
        print(f"原始文件大小: {os.path.getsize(input_file) / 1024 / 1024:.2f} MB")
        print(f"清理后文件大小: {os.path.getsize(output_file) / 1024 / 1024:.2f} MB")
        
        # 统计信息
        total_commits = 0
        cleaned_commits = 0
        for item in data:
            if 'commits' in item and isinstance(item['commits'], list):
                total_commits += len(item['commits'])
        
        for item in cleaned_data:
            if 'commits' in item and isinstance(item['commits'], list):
                cleaned_commits += len(item['commits'])
        
        print(f"总commit数量: {total_commits}")
        print(f"清理后commit数量: {cleaned_commits}")
        
    except json.JSONDecodeError as e:
        print(f"JSON解析错误: {e}")
    except Exception as e:
        print(f"处理过程中发生错误: {e}")

if __name__ == "__main__":
    main() 