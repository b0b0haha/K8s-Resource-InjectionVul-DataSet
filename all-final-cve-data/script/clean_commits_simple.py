#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
简化版脚本：处理JSON文件中每个Item的"commits"字段，只保留"url"、"hash"和"date"字段
适用于大文件处理
"""

import json
import os

def clean_commits_simple():
    """简化版清理函数"""
    input_file = "cve_patch-deduplicated.json"
    output_file = "cve_patch-deduplicated-cleaned.json"
    
    if not os.path.exists(input_file):
        print(f"错误：输入文件 {input_file} 不存在")
        return
    
    try:
        print(f"正在读取文件: {input_file}")
        with open(input_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        print(f"成功读取 {len(data)} 条记录")
        print("正在清理commits字段...")
        
        # 直接处理数据
        for item in data:
            if 'commits' in item and isinstance(item['commits'], list):
                for commit in item['commits']:
                    if isinstance(commit, dict):
                        # 只保留指定字段，删除其他字段
                        keys_to_keep = ['url', 'hash', 'date']
                        keys_to_remove = [k for k in commit.keys() if k not in keys_to_keep]
                        for key in keys_to_remove:
                            del commit[key]
        
        print(f"正在保存到文件: {output_file}")
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=2, ensure_ascii=False)
        
        print("处理完成！")
        print(f"原始文件大小: {os.path.getsize(input_file) / 1024 / 1024:.2f} MB")
        print(f"清理后文件大小: {os.path.getsize(output_file) / 1024 / 1024:.2f} MB")
        
    except Exception as e:
        print(f"处理过程中发生错误: {e}")

if __name__ == "__main__":
    clean_commits_simple() 